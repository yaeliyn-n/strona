<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Twój osobisty profil w Kronikach Elary. Zobacz swoje statystyki, ekwipunek, osiągnięcia i zarządzaj swoim kontem.">
    <meta name="keywords" content="profil użytkownika, kroniki elary, statystyki gracza, ekwipunek, discord, anime, manga">
    <meta name="author" content="Arcadius & Strażnicy Kronik Elary">
    <title>Mój Profil - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #111827; 
            --bg-header: rgba(15, 23, 42, 0.92); 
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6;
            --border-card: rgba(167, 139, 250, 0.15); 
            --btn-primary-bg: #8B5CF6;
            --btn-primary-hover-bg: #7C3AED;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #8B5CF6;
            --scrollbar-thumb-hover-bg: #7C3AED;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.15); 
            --shadow-strong-color: rgba(167, 139, 250, 0.3); 
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
            --rgb-purple-400: 167, 139, 250; 
            --rgb-stone-400: 168, 162, 158; 
            --rgb-amber-400: 251, 191, 36; 
            --rgb-cyan-400: 34, 211, 238; 
            --text-purple-400: #A78BFA;
            --text-stone-400: #A8A29E;
            --text-amber-400: #FBBF24;
            --text-cyan-400: #22D3EE;
        }
        html.light {
            --bg-primary: #F9FAFB; 
            --bg-secondary: #F3F4F6; 
            --bg-card: #FFFFFF; 
            --bg-header: rgba(255, 255, 255, 0.95);
            --text-primary: #1F2937; 
            --text-secondary: #4B5563; 
            --text-accent: #7C3AED; 
            --text-accent-hover: #6D28D9; 
            --border-accent: #7C3AED;
            --border-card: rgba(124, 58, 237, 0.1);
            --btn-primary-bg: #7C3AED;
            --btn-primary-hover-bg: #6D28D9;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #A78BFA;
            --scrollbar-thumb-hover-bg: #8B5CF6;
            --svg-icon-fill: #374151;
            --shadow-color: rgba(124, 58, 237, 0.08);
            --shadow-strong-color: rgba(124, 58, 237, 0.15);
            --modal-backdrop: rgba(249, 250, 251, 0.85);
            --rgb-accent: 124, 58, 237;
            --rgb-purple-400: 124, 58, 237;
            --rgb-stone-400: 120, 113, 108;
            --rgb-amber-400: 217, 119, 6;
            --rgb-cyan-400: 8, 145, 178;
            --text-purple-400: #7C3AED;
            --text-stone-400: #78716C;
            --text-amber-400: #D97706;
            --text-cyan-400: #0891B2;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.75; }
        h1, h2, h3, h4, h5 { font-family: 'Lora', serif; font-weight: 600; line-height: 1.35; }
        h1 { letter-spacing: -0.025em; font-weight: 700; } h2 { letter-spacing: -0.02em; font-weight: 700; } h3 { font-weight: 600; }
        .hero-profile-bg { background: linear-gradient(rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.98)), url('https://placehold.co/1920x400/0a0f1e/A78BFA?text=Mój+Profil') center/cover no-repeat; }
        .section-bg { background-color: var(--bg-secondary); }
        .card-bg { background-color: var(--bg-card); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.3s ease; border: 1px solid var(--border-card); box-shadow: 0 6px 12px -3px var(--shadow-color); overflow: hidden; }
        .card-bg:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 24px -4px var(--shadow-strong-color); }
        .btn-primary, .btn-discord, .btn-secondary { color: #FFFFFF; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 8px -2px var(--shadow-color); font-weight: 600; letter-spacing: 0.03em; padding-top: 0.8rem; padding-bottom: 0.8rem; border-radius: 0.375rem; } 
        .btn-primary { background-color: var(--btn-primary-bg); } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px var(--shadow-strong-color); }
        .btn-discord { background-color: var(--btn-discord-bg); } .btn-discord:hover { background-color: var(--btn-discord-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px rgba(88, 101, 242, 0.35); }
        .btn-secondary { background-color: transparent; border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.8rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: var(--border-accent); color: white; transform: scale(1.04) translateY(-2px); box-shadow: 0 6px 12px -2px var(--shadow-color); }
        .text-accent { color: var(--text-accent); }
        .reveal { opacity: 0; transform: translateY(50px); transition: opacity 0.8s cubic-bezier(0.645, 0.045, 0.355, 1), transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        ::-webkit-scrollbar { width: 12px; } ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 6px; border: 3px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(16px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 10px -3px rgba(15,23,42,0.15); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 4px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1px; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent), 0.1); }
        .nav-link:hover::after, .nav-link.active::after { width: 50%; }
        #mobileMenu { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none; }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        html.dark .text-shadow-custom { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 8px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.375rem; box-shadow: 0 8px 20px -4px var(--shadow-strong-color), 0 6px 8px -5px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: opacity 0.15s ease, transform 0.15s ease, visibility 0s linear 0.15s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.15s ease, transform 0.15s ease; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.7rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.1s ease, color 0.1s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent), 0.08); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; } 
        .modal { background-color: var(--modal-backdrop); backdrop-filter: blur(6px); }
        .modal-content { background-color: var(--bg-card); max-height: 90vh; }
        
        .profile-avatar-large { width: 128px; height: 128px; border-radius: 50%; border: 4px solid var(--border-accent); box-shadow: 0 0 20px rgba(var(--rgb-accent), 0.4); }
        .stat-card { background-color: var(--bg-secondary); padding: 1.5rem; border-radius: 0.5rem; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--text-accent); display: block; }
        .stat-label { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .inventory-item { background-color: var(--bg-secondary); border: 1px solid var(--border-card); border-radius: 0.375rem; padding: 1rem; text-align: center; }
        .inventory-item img { width: 48px; height: 48px; margin: 0 auto 0.5rem auto; object-fit: contain; }
        .inventory-item-name { font-size: 0.875rem; font-weight: 500; color: var(--text-primary); }
        .inventory-item-quantity { font-size: 0.75rem; color: var(--text-accent); }
        .loading-spinner { border-color: var(--text-accent) transparent var(--text-accent) transparent; }

        /* Styles for Missions */
        .mission-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; border-left: 4px solid var(--border-accent); }
        .mission-progress-bar { width: 100%; background-color: rgba(var(--rgb-accent), 0.1); border-radius: 9999px; height: 0.5rem; margin-top: 0.5rem; overflow: hidden; }
        .mission-progress-fill { height: 100%; background-color: var(--text-accent); border-radius: 9999px; transition: width 0.5s ease-in-out; }
        .mission-status-completed { color: #34D399; } /* green-400 */
        .mission-status-active { color: #FBBF24; } /* amber-400 */
        .mission-status-locked { color: #EF4444; } /* red-500 */

        /* Styles for Achievements */
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        .achievement-card { background-color: var(--bg-secondary); border: 1px solid var(--border-card); border-radius: 0.5rem; padding: 1rem; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .achievement-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .achievement-title { font-weight: 600; color: var(--text-primary); font-size: 0.95rem; line-height: 1.2; }
        .achievement-description { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; flex-grow: 1; }
        .achievement-date { font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .achievement-unlocked { border-color: #34D399; } /* Green border for unlocked */
        .achievement-locked { border-color: #EF4444; opacity: 0.6; } /* Red border for locked, slightly faded */

        /* Styles for Warnings */
        .warnings-list {
            background-color: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        .warning-item {
            border-bottom: 1px solid var(--border-card);
            padding: 0.75rem 0;
        }
        .warning-item:last-child {
            border-bottom: none;
        }
        .warning-reason {
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .warning-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .form-label { color: var(--text-secondary); margin-bottom: 0.25rem; font-size:0.875rem; display: block; }
        .form-input, .form-textarea {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            border-radius: 0.375rem; padding: 0.6rem 0.8rem;
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: var(--border-accent);
            box-shadow: 0 0 0 2px rgba(var(--rgb-accent),0.25);
        }
    </style>
</head>
<body class="antialiased">

    <header id="navbar" class="fixed top-0 left-0 right-0 z-50 py-3">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold" aria-label="Strona główna Kronik Elary">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <a href="index.html" class="nav-link">Strona Główna</a>
                <a href="prezentacja.html" class="nav-link">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="nav-link">Wikipedia Kronik</a> 
                <a href="blog.html" class="nav-link">Blog</a>
                <a href="gallery.html" class="nav-link">Galeria</a>
                <a href="ranking-stats.html" class="nav-link">Rankingi</a>
                <a href="dom-aukcyjny.html" class="nav-link">Dom Aukcyjny</a>
                <div id="auth-section-nav" class="ml-4 relative"></div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative"></div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otwórz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona Główna</a>
                <a href="prezentacja.html" class="block py-2.5 px-3 nav-link text-base font-medium">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="block py-2.5 px-3 nav-link text-base font-medium">Wikipedia Kronik</a>
                <a href="blog.html" class="block py-2.5 px-3 nav-link text-base font-medium">Blog</a>
                <a href="gallery.html" class="block py-2.5 px-3 nav-link text-base font-medium">Galeria</a>
                <a href="ranking-stats.html" class="block py-2.5 px-3 nav-link text-base font-medium">Rankingi</a>
                <a href="dom-aukcyjny.html" class="block py-2.5 px-3 nav-link text-base font-medium">Dom Aukcyjny</a>
                <a href="https://discord.gg/TWOJLINKZAPROSZENIOWY" target="_blank" rel="noopener noreferrer" class="block mt-2 py-2.5 px-3 text-base font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md text-center">Dołącz do Discorda</a>
            </div>
        </div>
    </header>

    <main>
        <section class="hero-profile-bg pt-32 pb-16 sm:pt-40 sm:pb-24 text-center reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <img id="profileAvatarLarge" src="https://placehold.co/128x128/A78BFA/FFFFFF?text=U" alt="Awatar użytkownika" class="profile-avatar-large mx-auto mb-6" onerror="this.onerror=null;this.src='https://placehold.co/128x128/A78BFA/FFFFFF?text=U';">
                <h1 id="profileUsername" class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-2 leading-tight text-shadow-custom">
                    Ładowanie profilu...
                </h1>
                <p id="profileEmail" class="text-md text-slate-300 mb-8 text-shadow-custom"></p>
                <div id="profileLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md max-w-md mx-auto"></div>
            </div>
        </section>

        <section id="profile-details" class="py-16 sm:py-20 reveal">
            <div class="container mx-auto px-4 sm:px-6">

                <section id="user-profile-details" class="mb-12 p-6 bg-bg-card rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-accent">Mój Profil Użytkownika</h2>
                        <button id="editProfileButton" class="btn-secondary text-sm py-2 px-4" style="display: none;">Edytuj Profil</button>
                    </div>

                    {/* View Mode Div */}
                    <div id="profileViewMode">
                        <div class="mb-3"><strong class="text-secondary">Bio:</strong> <p id="viewBio" class="text-primary whitespace-pre-wrap">-</p></div>
                        <div class="mb-3"><strong class="text-secondary">Ulubione Anime:</strong> <p id="viewFavoriteAnime" class="text-primary">-</p></div>
                        <div class="mb-3"><strong class="text-secondary">Ulubiona Manga:</strong> <p id="viewFavoriteManga" class="text-primary">-</p></div>
                        <div class="mb-3"><strong class="text-secondary">Strona WWW:</strong> <a id="viewWebsiteLink" href="#" class="text-accent hover:underline" target="_blank" rel="noopener noreferrer">-</a></div>
                        <div class="mb-3"><strong class="text-secondary">Twitter:</strong> <a id="viewTwitterLink" href="#" class="text-accent hover:underline" target="_blank" rel="noopener noreferrer">-</a></div>
                        <div class="mb-3"><strong class="text-secondary">Twitch:</strong> <a id="viewTwitchLink" href="#" class="text-accent hover:underline" target="_blank" rel="noopener noreferrer">-</a></div>
                        <div class="mb-3"><strong class="text-secondary">YouTube:</strong> <a id="viewYouTubeLink" href="#" class="text-accent hover:underline" target="_blank" rel="noopener noreferrer">-</a></div>
                    </div>

                    {/* Edit Mode Form (initially hidden) */}
                    <form id="profileEditForm" style="display: none;" class="space-y-4">
                        <div>
                            <label for="editBio" class="block text-sm font-medium text-secondary mb-1">Bio:</label>
                            <textarea id="editBio" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary" rows="4"></textarea>
                        </div>
                        <div>
                            <label for="editFavoriteAnime" class="block text-sm font-medium text-secondary mb-1">Ulubione Anime:</label>
                            <input type="text" id="editFavoriteAnime" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary">
                        </div>
                        <div>
                            <label for="editFavoriteManga" class="block text-sm font-medium text-secondary mb-1">Ulubiona Manga:</label>
                            <input type="text" id="editFavoriteManga" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary">
                        </div>
                        <div>
                            <label for="editWebsiteLink" class="block text-sm font-medium text-secondary mb-1">Strona WWW (URL):</label>
                            <input type="url" id="editWebsiteLink" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary" placeholder="https://example.com">
                        </div>
                        <div>
                            <label for="editTwitterLink" class="block text-sm font-medium text-secondary mb-1">Twitter URL (opcjonalnie):</label>
                            <input type="url" id="editTwitterLink" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary" placeholder="https://twitter.com/username">
                        </div>
                        <div>
                            <label for="editTwitchLink" class="block text-sm font-medium text-secondary mb-1">Twitch URL (opcjonalnie):</label>
                            <input type="url" id="editTwitchLink" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary" placeholder="https://twitch.tv/username">
                        </div>
                        <div>
                            <label for="editYouTubeLink" class="block text-sm font-medium text-secondary mb-1">YouTube URL (opcjonalnie):</label>
                            <input type="url" id="editYouTubeLink" class="w-full p-2.5 rounded-md bg-bg-secondary border border-[var(--border-card)] focus:ring-2 focus:ring-[var(--text-accent)] focus:border-[var(--text-accent)] outline-none transition-colors text-primary placeholder-text-secondary" placeholder="https://youtube.com/channel/...">
                        </div>
                        <div class="flex space-x-3 justify-end">
                            <button type="button" id="cancelEditProfileButton" class="btn-secondary text-sm py-2 px-4">Anuluj</button>
                            <button type="submit" id="saveProfileButton" class="btn-primary text-sm py-2 px-4">Zapisz Zmiany</button>
                        </div>
                    </form>
                    <div id="profileUpdateStatus" class="text-sm mt-3"></div>
                </section>

                <div class="mb-12">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-primary mb-6 text-center sm:text-left">Twoje <span class="text-accent">Statystyki</span> w Kronikach</h2>
                    <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6">
                        <div class="text-center py-6 col-span-full">
                            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                            <p class="text-secondary">Ładowanie statystyk...</p>
                        </div>
                    </div>
                    <div id="statsLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md mt-4"></div>
                </div>

                <div class="mb-12">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-primary mb-6 text-center sm:text-left">Twój <span class="text-accent">Ekwipunek</span></h2>
                    <div id="inventoryContainer" class="inventory-grid">
                        <div class="text-center py-6 col-span-full">
                             <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                            <p class="text-secondary">Ładowanie ekwipunku...</p>
                        </div>
                    </div>
                    <div id="inventoryLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md mt-4"></div>
                </div>

                <div class="mb-12">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-primary mb-6 text-center sm:text-left">Twoje <span class="text-accent">Misje</span></h2>
                    <div id="missionsContainer" class="space-y-4">
                        <div class="text-center py-6">
                            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                            <p class="text-secondary">Ładowanie misji...</p>
                        </div>
                    </div>
                    <div id="missionsLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md mt-4"></div>
                </div>

                <div class="mb-12">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-primary mb-6 text-center sm:text-left">Twoje <span class="text-accent">Osiągnięcia</span></h2>
                    <div id="achievementsContainer" class="achievement-grid">
                        <div class="text-center py-6 col-span-full">
                            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                            <p class="text-secondary">Ładowanie osiągnięć...</p>
                        </div>
                    </div>
                    <div id="achievementsLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md mt-4"></div>
                </div>

                <div class="mb-12">
                    <h2 class="text-2xl sm:text-3xl font-semibold text-primary mb-6 text-center sm:text-left">Twoje <span class="text-accent">Ostrzeżenia</span></h2>
                    <div id="warningsContainer" class="warnings-list">
                        <div class="text-center py-6">
                            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                            <p class="text-secondary">Ładowanie ostrzeżeń...</p>
                        </div>
                    </div>
                    <div id="warningsLoadingError" class="hidden text-red-400 bg-red-900/50 p-3 rounded-md mt-4"></div>
                </div>
            </div>
        </section>
        
    </main>

    <footer class="py-12 text-center" style="background-color: var(--bg-header);">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="flex justify-center space-x-6 mb-6">
                <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Twitter">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.67.9-.53 1.59-1.37 1.92-2.38-.84.5-1.78.86-2.79 1.07C18.28 4.42 17.03 4 15.64 4c-2.94 0-5.32 2.38-5.32 5.32 0 .42.05.83.14 1.22-4.42-.22-8.33-2.34-10.96-5.55-.46.79-.72 1.7-.72 2.67 0 1.84.94 3.47 2.37 4.42-.87-.03-1.69-.27-2.41-.66v.07c0 2.57 1.83 4.72 4.25 5.21-.44.12-.91.18-1.39.18-.34 0-.67-.03-1-.1 0 .67.65 1.37 1.77 1.84-.7.55-1.59.88-2.58.88-.39 0-.77-.02-1.14-.07.91.59 2 1.02 3.19 1.02 3.83 0 5.93-3.18 5.93-5.93 0-.09 0-.18-.01-.27.41-.3.76-.68 1.04-1.09z"/></svg>
                </a>
                 <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Instagram">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.17.053 1.805.248 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.167.422.362 1.056.415 2.227.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.17-.248 1.805-.415 2.227a3.48 3.48 0 01-.896 1.382c-.42.419-.82.679-1.382.896-.422.167-1.056.362-2.227.415-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.17-.053-1.805-.248-2.227-.415a3.492 3.492 0 01-1.381-.896 3.492 3.492 0 01-.896-1.381c-.167-.422-.362-1.056-.415-2.227-.058-1.266-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.17.248-1.805.415-2.227.218-.562.477-.96.896-1.381.419-.42.819-.679 1.381-.896.422-.167 1.056-.362 2.227-.415C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.143 0-3.505.012-4.725.068-1.09.05-1.647.235-1.98.378a1.69 1.69 0 00-.755.755c-.143.333-.328.89-.378 1.98C4.082 8.495 4.07 8.857 4.07 12s.012 3.505.068 4.725c.05 1.09.235 1.647.378 1.98.16.373.397.637.755.755.333.143.89.328 1.98.378 1.22.056 1.582.068 4.725.068s3.505-.012 4.725-.068c1.09-.05 1.647.235 1.98-.378.373-.16.637-.397.755-.755.143-.333.328.89.378-1.98.056-1.22.068-1.582.068-4.725s-.012-3.505-.068-4.725c-.05-1.09-.235-1.647-.378-1.98a1.69 1.69 0 00-.755-.755c-.333-.143-.89-.328-1.98-.378C15.505 3.977 15.143 3.965 12 3.965zm0 3.273a4.762 4.762 0 100 9.524 4.762 4.762 0 000-9.524zm0 7.722a3.06 3.06 0 110-6.12 3.06 3.06 0 010 6.12zm4.758-7.868a1.128 1.128 0 100-2.255 1.128 1.128 0 000 2.255z"/></svg>
                </a>
                 <a href="polityka-prywatnosci.html" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Polityka Prywatności">
                    Polityka Prywatności
                </a>
            </div>
            <p class="text-secondary text-sm">
                &copy; <span id="currentYear">2024</span> Kroniki Elary. Wszelkie prawa zastrzeżone.
            </p>
            <p class="text-xs mt-2.5" style="color: var(--text-secondary-light, #94A3B8);">
                Stworzone z pasji do anime i mangi przez Arcadiusa i jego Strażników.
            </p>
        </div>
    </footer>

    <div id="eventModal" class="fixed inset-0 z-[60] items-center justify-center hidden p-4 modal">
        </div>

    <script src="js/main.js" defer></script>
    <script>
        // Specific script for profil.html
        let loggedInUser = null; // To store logged-in user's basic info
        let currentProfileData = {}; // To store the profile data of the user being viewed (UserProfile model data)
        let isOwnProfile = false; // Flag to check if the profile being viewed is the logged-in user's own
        const GUILD_ID = "1375477258172502086"; // Replace with actual Guild ID

        // DOM Elements
        const profileUsernameEl = document.getElementById('profileUsername');
        const profileEmailEl = document.getElementById('profileEmail');
        const profileAvatarLargeEl = document.getElementById('profileAvatarLarge');
        const profileLoadingErrorEl = document.getElementById('profileLoadingError');

        // Profile Details Section Elements
        const userProfileDetailsSection = document.getElementById('user-profile-details');
        const editProfileButton = document.getElementById('editProfileButton');
        const profileViewMode = document.getElementById('profileViewMode');
        const profileEditForm = document.getElementById('profileEditForm');
        const viewBio = document.getElementById('viewBio');
        const viewFavoriteAnime = document.getElementById('viewFavoriteAnime');
        const viewFavoriteManga = document.getElementById('viewFavoriteManga');
        const viewWebsiteLink = document.getElementById('viewWebsiteLink');
        const viewTwitterLink = document.getElementById('viewTwitterLink');
        const viewTwitchLink = document.getElementById('viewTwitchLink');
        const viewYouTubeLink = document.getElementById('viewYouTubeLink');
        const editBio = document.getElementById('editBio');
        const editFavoriteAnime = document.getElementById('editFavoriteAnime');
        const editFavoriteManga = document.getElementById('editFavoriteManga');
        const editWebsiteLink = document.getElementById('editWebsiteLink');
        const editTwitterLink = document.getElementById('editTwitterLink');
        const editTwitchLink = document.getElementById('editTwitchLink');
        const editYouTubeLink = document.getElementById('editYouTubeLink');
        const cancelEditProfileButton = document.getElementById('cancelEditProfileButton');
        const saveProfileButton = document.getElementById('saveProfileButton');
        const profileUpdateStatus = document.getElementById('profileUpdateStatus');


        async function initializeProfilePage() {
            // updateAuthDisplay in main.js will fetch loggedInUser and cache it.
            // We can try to access it or re-fetch /api/me if needed, but main.js should handle nav.
            // For profile page specific logic, we proceed to determine whose profile to load.

            const params = new URLSearchParams(window.location.search);
            const targetDiscordUserId = params.get('userId');
            let userIdToFetch = null;

            // Try to get logged-in user info from main.js's scope if possible, or make a new call
            // This assumes main.js might have already fetched and stored it.
            // For simplicity, let's re-fetch here to ensure we have it for profile logic.
            try {
                const meResponse = await fetch('/api/me');
                if (meResponse.ok) {
                    loggedInUser = await meResponse.json();
                }
            } catch(e) { console.warn("Could not fetch /api/me for profile page init:", e); }


            if (targetDiscordUserId) {
                userIdToFetch = targetDiscordUserId;
            } else if (loggedInUser && loggedInUser.id) {
                userIdToFetch = loggedInUser.id;
            }

            if (!userIdToFetch) {
                profileUsernameEl.textContent = 'Nie określono profilu';
                profileEmailEl.textContent = 'Podaj ID użytkownika w URL (np. profil.html?userId=DISCORD_ID) lub zaloguj się, aby zobaczyć swój profil.';
                profileLoadingErrorEl.textContent = 'Nie można załadować profilu. Brak ID użytkownika.';
                profileLoadingErrorEl.classList.remove('hidden');
                if(userProfileDetailsSection) userProfileDetailsSection.style.display = 'none';
                // Hide other sections too
                document.getElementById('statsContainer').innerHTML = '<p class="text-center text-secondary col-span-full py-6">Nie określono profilu.</p>';
                document.getElementById('inventoryContainer').innerHTML = '<p class="text-center text-secondary col-span-full py-6">Nie określono profilu.</p>';
                // ... and so on for missions, achievements, warnings
                return;
            }

            isOwnProfile = loggedInUser && loggedInUser.id === userIdToFetch;
            if (editProfileButton) {
                editProfileButton.style.display = isOwnProfile ? 'inline-flex' : 'none'; // Ensure button is visible if own profile
            }
             const userProfileSectionTitle = userProfileDetailsSection?.querySelector('h2.text-2xl');
            if (userProfileSectionTitle) {
                userProfileSectionTitle.textContent = isOwnProfile ? 'Mój Profil Użytkownika' : 'Profil Użytkownika';
            }


            try {
                const profileApiResponse = await fetch(`/api/profile/${userIdToFetch}`);
                if (!profileApiResponse.ok) {
                    const errorData = await profileApiResponse.json().catch(() => ({}));
                    throw new Error(errorData.error || `Nie udało się załadować profilu: ${profileApiResponse.status}`);
                }
                const fullUserData = await profileApiResponse.json(); // This is the User model object, with 'profile' (UserProfile) nested

                document.title = `Profil: ${fullUserData.username || 'Nieznany'} - Kroniki Elary`;
                currentProfileData = fullUserData.profile || {}; // Store UserProfile part for editing form

                displayFullUserProfileData(fullUserData, currentProfileData); // Pass both parts

                // Load other stats
                loadUserStats(userIdToFetch);
                loadUserInventory(userIdToFetch);
                if (!GUILD_ID || !/^\d+$/.test(GUILD_ID)) {
                    console.error("Błąd: GUILD_ID jest nieprawidłowe.");
                    // Handle error display for sections requiring GUILD_ID
                } else {
                    loadUserMissions(userIdToFetch, GUILD_ID);
                    loadUserAchievements(userIdToFetch, GUILD_ID);
                    loadUserWarnings(userIdToFetch, GUILD_ID);
                }
                profileLoadingErrorEl.classList.add('hidden');
                if(userProfileDetailsSection) userProfileDetailsSection.style.display = 'block';

            } catch (error) {
                console.error('Błąd ładowania danych profilu:', error);
                document.title = 'Błąd Profilu - Kroniki Elary';
                profileUsernameEl.textContent = 'Błąd ładowania';
                profileLoadingErrorEl.textContent = `Wystąpił błąd: ${error.message}. Spróbuj odświeżyć stronę.`;
                profileLoadingErrorEl.classList.remove('hidden');
                if(userProfileDetailsSection) userProfileDetailsSection.style.display = 'none';
            }
        }

        function displayFullUserProfileData(userData, profileDetails) {
            // userData is the main User object (discordUserId, username, email, avatar)
            // profileDetails is the UserProfile object (bio, links, etc.)

            profileUsernameEl.textContent = userData.username || 'Brak nazwy użytkownika';
            profileEmailEl.textContent = userData.email || ''; // Display only if it's own profile, or if public display of email is intended
            if (profileAvatarLargeEl) {
                profileAvatarLargeEl.src = userData.avatar || 'https://placehold.co/128x128/A78BFA/FFFFFF?text=U';
                profileAvatarLargeEl.onerror = () => { profileAvatarLargeEl.src = 'https://placehold.co/128x128/A78BFA/FFFFFF?text=U'; };
            }

            // Populate view mode from profileDetails
            viewBio.textContent = profileDetails.bio || '-';
            viewFavoriteAnime.textContent = profileDetails.favoriteAnime || '-';
            viewFavoriteManga.textContent = profileDetails.favoriteManga || '-';
            updateLinkElement(viewWebsiteLink, profileDetails.websiteLink);
            updateLinkElement(viewTwitterLink, profileDetails.twitterLink);
            updateLinkElement(viewTwitchLink, profileDetails.twitchLink);
            updateLinkElement(viewYouTubeLink, profileDetails.youtubeLink);
        }


        function updateLinkElement(element, linkUrl) {
            if (linkUrl) {
                element.href = linkUrl;
                element.textContent = linkUrl;
                element.target = "_blank"; // Open in new tab
                element.rel = "noopener noreferrer";
                element.classList.remove('opacity-60', 'pointer-events-none');
            } else {
                element.textContent = '-';
                element.href = '#';
                element.target = "";
                element.rel = "";
                element.classList.add('opacity-60', 'pointer-events-none');
            }
        }

        function toggleProfileEditMode(isEditing) {
            if (!profileViewMode || !profileEditForm || !editProfileButton) return;

            if (isEditing) {
                profileViewMode.style.display = 'none';
                profileEditForm.style.display = 'block';
                editProfileButton.style.display = 'none';

                // Populate form with currentProfileData (which is UserProfile part)
                editBio.value = currentProfileData.bio || '';
                editFavoriteAnime.value = currentProfileData.favoriteAnime || '';
                editFavoriteManga.value = currentProfileData.favoriteManga || '';
                editWebsiteLink.value = currentProfileData.websiteLink || '';
                editTwitterLink.value = currentProfileData.twitterLink || '';
                editTwitchLink.value = currentProfileData.twitchLink || '';
                editYouTubeLink.value = currentProfileData.youtubeLink || '';
            } else {
                profileViewMode.style.display = 'block';
                profileEditForm.style.display = 'none';
                if(isOwnProfile) editProfileButton.style.display = 'inline-flex';
            }
            if(profileUpdateStatus) profileUpdateStatus.textContent = '';
        }

        // Attach event listeners for profile editing
        if (editProfileButton) {
            editProfileButton.addEventListener('click', () => toggleProfileEditMode(true));
        }
        if (cancelEditProfileButton) {
            cancelEditProfileButton.addEventListener('click', () => {
                displayFullUserProfileData(loggedInUser, currentProfileData); // Revert form by re-populating view
                toggleProfileEditMode(false);
            });
        }
        if (profileEditForm) {
            profileEditForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                if (!profileUpdateStatus || !saveProfileButton) return;

                profileUpdateStatus.textContent = 'Zapisywanie...';
                profileUpdateStatus.className = 'text-sm mt-3 text-amber-400';
                toggleButtonLoadingState(saveProfileButton, true, "Zapisywanie...");


                const updatedProfile = {
                    bio: editBio.value.trim(),
                    favoriteAnime: editFavoriteAnime.value.trim(),
                    favoriteManga: editFavoriteManga.value.trim(),
                    websiteLink: editWebsiteLink.value.trim() || null,
                    twitterLink: editTwitterLink.value.trim() || null,
                    twitchLink: editTwitchLink.value.trim() || null,
                    youtubeLink: editYouTubeLink.value.trim() || null,
                };

                try {
                    // User can only edit their own profile via /api/profile/me
                    const response = await fetch('/api/profile/me', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updatedProfile)
                    });
                    const result = await response.json(); // This returns only the UserProfile part

                    if (response.ok) {
                        currentProfileData = result; // Update local store with the saved profile data
                        displayFullUserProfileData(loggedInUser, currentProfileData); // Refresh view
                        toggleProfileEditMode(false);
                        profileUpdateStatus.textContent = 'Profil zaktualizowany pomyślnie!';
                        profileUpdateStatus.className = 'text-sm mt-3 text-green-400';
                    } else {
                        profileUpdateStatus.textContent = `Błąd zapisu: ${result.error || 'Nieznany błąd serwera'}`;
                        profileUpdateStatus.className = 'text-sm mt-3 text-red-400';
                    }
                } catch (error) {
                    console.error('Błąd zapisu profilu:', error);
                    profileUpdateStatus.textContent = 'Wystąpił błąd sieciowy podczas zapisu.';
                    profileUpdateStatus.className = 'text-sm mt-3 text-red-400';
                } finally {
                    toggleButtonLoadingState(saveProfileButton, false, "Zapisz Zmiany");
                    setTimeout(() => { if(profileUpdateStatus) profileUpdateStatus.textContent = ''; }, 5000);
                }
            });
        }


        // Functions for stats, inventory, missions, achievements, warnings (assuming they exist and are correctly defined)
        async function loadUserStats(discordUserId) { /* ... (existing implementation) ... */ }
        async function loadUserInventory(discordUserId) { /* ... (existing implementation) ... */ }
        async function loadUserMissions(discordUserId, guildId) { /* ... (existing implementation) ... */ }
        async function loadUserAchievements(discordUserId, guildId) { /* ... (existing implementation) ... */ }
        async function loadUserWarnings(discordUserId, guildId) { /* ... (existing implementation) ... */ }
        function formatDuration(seconds) { /* ... (existing implementation) ... */ }


        document.addEventListener('DOMContentLoaded', function() {
            // Initialize common scripts from main.js first
            // If initializeCommonScripts is not yet defined because main.js is deferred,
            // this specific page's init might need to wait or be called from main.js
            if (typeof initializeCommonScripts === "function") {
                 // initializeCommonScripts(); // Call if main.js setup is needed before profile page specifics
            } else {
                // Fallback or wait for main.js if it sets up global things like nav
                console.warn("main.js (initializeCommonScripts) not yet loaded or defined.");
            }
            initializeProfilePage(); // Load profile specific data
        });
    </script>
</body>
</html>
