<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #293548; 
            --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6; 
            --border-card: rgba(167, 139, 250, 0.25); 
            --btn-primary-bg: #8B5CF6; 
            --btn-primary-hover-bg: #7C3AED; 
            --btn-danger-bg: #EF4444; 
            --btn-danger-hover-bg: #DC2626; 
            --btn-success-bg: #22C55E;
            --btn-success-hover-bg: #16A34A;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.25); 
            --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
        }
        html.light { 
            /* Light theme is kept same as dark for admin panel for now */
            --bg-primary: #0F172A; --bg-secondary: #1E293B; --bg-card: #293548; --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; --text-secondary: #94A3B8; --text-accent: #A78BFA; --text-accent-hover: #8B5CF6;
            --border-accent: #8B5CF6; --border-card: rgba(167, 139, 250, 0.25);
            --btn-primary-bg: #8B5CF6; --btn-primary-hover-bg: #7C3AED; --btn-danger-bg: #EF4444; --btn-danger-hover-bg: #DC2626;
            --btn-success-bg: #22C55E; --btn-success-hover-bg: #16A34A; --btn-discord-bg: #5865F2; --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0; --shadow-color: rgba(167, 139, 250, 0.25); --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 600; }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(18px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 5px 15px -4px rgba(15,23,42,0.2); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.65rem 1.1rem; border-radius: 0.6rem; font-weight: 500; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent),0.12); }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 3px; bottom: 5px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1.5px; }
        .nav-link.active::after { width: 60%; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.5rem; box-shadow: 0 10px 25px -5px var(--shadow-strong-color), 0 8px 10px -6px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s linear 0.2s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition-delay: 0s; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.15s ease, color 0.15s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent),0.1); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-secondary); border: 1px solid var(--border-card); color: var(--text-primary); border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--border-accent); box-shadow: 0 0 0 3px rgba(var(--rgb-accent),0.3); }
        .form-label { color: var(--text-secondary); margin-bottom: 0.5rem; display: block; font-weight: 500; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease; letter-spacing: 0.03em; }
        .btn-primary { background-color: var(--btn-primary-bg); color: white; } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px var(--shadow-strong-color); }
        .btn-secondary { background-color: var(--bg-card); border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.75rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: rgba(var(--rgb-accent),0.15); transform: translateY(-2px); box-shadow: 0 6px 12px -3px var(--shadow-color); }
        .btn-success { background-color: #22C55E; color: white; } .btn-success:hover { background-color: #16A34A; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(34,197,94,0.4); }
        .btn-danger { background-color: #EF4444; color: white; } .btn-danger:hover { background-color: #DC2626; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(239,68,68,0.4); }
        .btn-discord { background-color: #5865F2; color: white; } .btn-discord:hover { background-color: #4752C4; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(88,101,242,0.4); }
        #adminMessage { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; text-align: center; font-weight: 500; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateY(10px); }
        #adminMessage.visible { opacity: 1; transform: translateY(0); }
        #adminMessage.success { background-color: rgba(52, 211, 153, 0.15); color: #34D399; border: 1px solid rgba(52, 211, 153, 0.4); }
        #adminMessage.error { background-color: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        #adminMessage.info { background-color: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.4); }
        #mobileMenu { transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none;  }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .loading-spinner { border: 3px solid rgba(var(--rgb-accent), 0.3); border-top-color: var(--text-accent); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .admin-table th, .admin-table td { border: 1px solid var(--border-card); padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: rgba(var(--rgb-accent), 0.1); color: var(--text-accent); font-weight: 600; }
        .admin-table td .form-input, .admin-table td .form-select { padding: 0.5rem; font-size: 0.875rem; }
        .admin-table td .btn { padding: 0.4rem 0.8rem; font-size: 0.875rem; margin-left: 0.5rem; }
        .admin-table .item-icon-preview { font-size: 1.5rem; width: 2rem; text-align: center; }
        .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; }
        .tab-button:hover { color: var(--text-accent); }
        .tab-button.active { color: var(--text-accent); border-bottom-color: var(--text-accent); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .prose { color: var(--text-secondary); } /* Basic prose styles for markdown preview */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: var(--text-primary); margin-top: 1.25em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; } .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; } .prose li { margin-bottom: 0.25em; }
        .prose a { color: var(--text-accent); } .prose strong { color: var(--text-primary); } .prose code { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 0.25rem; }
        .prose pre { background-color: var(--bg-secondary); padding: 0.75em; border-radius: 0.375rem; overflow-x: auto; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header id="navbar" class="sticky top-0 z-50 py-3 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span> <span class="text-sm text-red-400 font-normal">[Panel Admina]</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <div id="auth-section-nav" class="ml-4 relative"></div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative"></div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otwórz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button data-tab="contentManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Treścią</button>
                <button data-tab="articleManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Artykułami</button>
                <button data-tab="wikiManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wiki</button>
                <button data-tab="supportManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wsparciem</button>
                <button data-tab="shopManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Sklepem</button>
                <button data-tab="warningsManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Ostrzeżeniami</button>
                <button data-tab="botConfigManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Konfiguracja Bota</button>
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona Główna Serwisu</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 sm:px-6 py-8">
        <div id="admin-panel-container">
            <div class="mb-6 border-b border-[var(--border-card)]">
                <nav class="flex -mb-px space-x-1 flex-wrap" aria-label="Tabs">
                    <button data-tab="contentManagement" class="tab-button active">Zarządzanie Treścią</button>
                    <button data-tab="articleManagement" class="tab-button">Zarządzanie Artykułami</button>
                    <button data-tab="wikiManagement" class="tab-button">Zarządzanie Wiki</button>
                    <button data-tab="supportManagement" class="tab-button">Zarządzanie Wsparciem</button>
                    <button data-tab="shopManagement" class="tab-button">Zarządzanie Sklepem</button>
                    <button data-tab="warningsManagement" class="tab-button">Zarządzanie Ostrzeżeniami</button>
                    <button data-tab="botConfigManagement" class="tab-button">Konfiguracja Bota</button>
                </nav>
            </div>

            <div id="admin-login-prompt" class="text-center py-12" style="display:none;">
                <h2 class="text-2xl font-semibold text-primary mb-4">Dostęp Wymaga Uwierzytelnienia</h2>
                <p class="text-secondary mb-6">Musisz być zalogowany jako administrator, aby uzyskać dostęp do tego panelu.</p>
                <a href="/auth/discord/login?redirect=/admin.html" class="btn-discord !text-white px-6 py-3 rounded-lg text-md inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg>
                    Zaloguj przez Discord
                </a>
            </div>

            <div id="contentManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Treścią Strony</h1>
                {/* ... (existing contentManagement content) ... */}
            </div>

            <div id="articleManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Artykułami</h1>
                <div id="adminArticleListContainer" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-accent">Lista Artykułów</h2>
                        <button id="showCreateArticleFormButton" class="btn btn-success">Utwórz Nowy Artykuł</button>
                    </div>
                    <div id="articlesTableContainer" class="overflow-x-auto"></div>
                    <div id="articleListPaginationControls" class="mt-6 flex justify-center items-center space-x-3"></div>
                    <div id="articleListLoading" class="text-center py-6 text-secondary hidden"><span class="loading-spinner !w-8 !h-8"></span> Ładowanie artykułów...</div>
                    <div id="articleListError" class="text-center py-6 text-red-400 hidden"></div>
                    <div id="articleListEmpty" class="text-center py-6 text-secondary hidden">Brak artykułów do wyświetlenia.</div>
                </div>

                <div id="adminArticleFormContainer" style="display:none;" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl mt-8">
                    <h2 id="articleFormTitle" class="text-2xl font-semibold text-accent mb-6">Utwórz Nowy Artykuł</h2>
                    <form id="adminArticleForm" class="space-y-6">
                        <div>
                            <label for="articleTitle" class="form-label">Tytuł Artykułu:</label>
                            <input type="text" id="articleTitle" name="title" class="form-input" required>
                        </div>
                        <div>
                            <label for="articleSlug" class="form-label">Slug (URL):</label>
                            <input type="text" id="articleSlug" name="slug" class="form-input" placeholder="Pozostaw puste, aby wygenerować automatycznie">
                            <p class="text-xs text-secondary mt-1">Unikalny identyfikator w URL, np. 'moj-pierwszy-artykul'.</p>
                        </div>
                        <div>
                            <label for="articleContent" class="form-label">Treść Artykułu (Markdown):</label>
                            <textarea id="articleContent" name="content" rows="15" class="form-textarea" placeholder="Wpisz treść artykułu używając składni Markdown..."></textarea>
                            <div class="mt-2 text-xs text-secondary">
                                Podgląd (uproszczony):
                                <button type="button" id="togglePreviewButton" class="ml-2 text-accent text-xs underline">Pokaż/Ukryj Podgląd</button>
                            </div>
                            <div id="articlePreview" class="mt-2 p-4 border border-[var(--border-card)] rounded-md bg-[var(--bg-primary)] min-h-[100px] prose prose-sm max-w-none hidden"></div>
                        </div>
                        <div>
                            <label for="articleCategoriesSelect" class="form-label">Kategorie:</label>
                            <select multiple id="articleCategoriesSelect" class="form-select h-32"></select>
                            <p class="text-xs text-secondary mt-1">Przytrzymaj Ctrl (lub Cmd na Mac), aby wybrać wiele.</p>
                        </div>
                        <div>
                            <label for="articleStatus" class="form-label">Status:</label>
                            <select id="articleStatus" name="status" class="form-select">
                                <option value="draft">Szkic (Draft)</option>
                                <option value="published">Opublikowany (Published)</option>
                            </select>
                        </div>
                        <div>
                            <label for="articleIsFeatured" class="form-label flex items-center">
                                <input type="checkbox" id="articleIsFeatured" name="isFeatured" class="mr-2 h-4 w-4 text-accent rounded border-[var(--border-card)] focus:ring-accent">
                                Oznacz jako Polecany (Featured)
                            </label>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                            <button type="button" id="backToArticleListButton" class="btn btn-secondary w-full sm:w-auto">Wróć do Listy</button>
                            <button type="submit" id="saveArticleButton" class="btn btn-primary w-full sm:w-auto">
                                <span class="button-text">Utwórz Artykuł</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="adminCategoryManagementSection" class="mt-12 bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold text-accent mb-6">Zarządzanie Kategoriami</h2>
                    <form id="adminCategoryForm" class="mb-8 space-y-4 md:space-y-0 md:flex md:items-end md:space-x-3">
                        <input type="hidden" id="editingCategoryId">
                        <div class="flex-grow">
                            <label for="categoryName" class="form-label">Nazwa Kategorii:</label>
                            <input type="text" id="categoryName" name="name" class="form-input" required>
                        </div>
                        <div class="flex-grow">
                            <label for="categorySlug" class="form-label">Slug Kategorii:</label>
                            <input type="text" id="categorySlug" name="slug" class="form-input" placeholder="Automatycznie z nazwy">
                        </div>
                        <div class="flex space-x-2 pt-4 md:pt-0">
                             <button type="submit" id="saveCategoryButton" class="btn btn-success whitespace-nowrap">
                                <span class="button-text">Dodaj Kategorię</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                            <button type="button" id="clearCategoryFormButton" class="btn btn-secondary whitespace-nowrap">Wyczyść</button>
                        </div>
                    </form>
                    <div id="adminCategoriesListContainer" class="overflow-x-auto"></div>
                    <div id="categoryListLoading" class="text-center py-4 text-secondary hidden"><span class="loading-spinner"></span> Ładowanie kategorii...</div>
                    <div id="categoryListError" class="text-center py-4 text-red-400 hidden"></div>
                    <div id="categoryListEmpty" class="text-center py-4 text-secondary hidden">Brak kategorii.</div>
                </div>
            </div>

            <div id="wikiManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Stronami Wiki</h1>
                <div id="adminWikiPageListContainer" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-accent">Lista Stron Wiki</h2>
                        <button id="showCreateWikiPageFormButton" class="btn btn-success">Utwórz Nową Stronę Wiki</button>
                    </div>
                    <div id="wikiPagesTableContainer" class="overflow-x-auto"></div>
                    <div id="wikiPageListPaginationControls" class="mt-6 flex justify-center items-center space-x-3"></div>
                    <div id="wikiPageListLoading" class="text-center py-6 text-secondary hidden"><span class="loading-spinner !w-8 !h-8"></span> Ładowanie stron wiki...</div>
                    <div id="wikiPageListError" class="text-center py-6 text-red-400 hidden"></div>
                    <div id="wikiPageListEmpty" class="text-center py-6 text-secondary hidden">Brak stron wiki do wyświetlenia.</div>
                </div>

                <div id="adminWikiPageFormContainer" style="display:none;" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl mt-8">
                    <h2 id="wikiPageFormTitle" class="text-2xl font-semibold text-accent mb-6">Utwórz Nową Stronę Wiki</h2>
                    <form id="adminWikiPageForm" class="space-y-6">
                        <div>
                            <label for="wikiPageTitle" class="form-label">Tytuł Strony:</label>
                            <input type="text" id="wikiPageTitle" name="title" class="form-input" required>
                        </div>
                        <div>
                            <label for="wikiPageSlug" class="form-label">Slug (URL):</label>
                            <input type="text" id="wikiPageSlug" name="slug" class="form-input" placeholder="Pozostaw puste, aby wygenerować automatycznie">
                            <p class="text-xs text-secondary mt-1">Unikalny identyfikator w URL, np. 'moja-strona-wiki'.</p>
                        </div>
                        <div>
                            <label for="wikiPageContent" class="form-label">Treść Strony (Markdown):</label>
                            <textarea id="wikiPageContent" name="content" rows="15" class="form-textarea" placeholder="Wpisz treść strony używając składni Markdown..."></textarea>
                            <div class="mt-2 text-xs text-secondary">
                                Podgląd (uproszczony):
                                <button type="button" id="toggleWikiPreviewButton" class="ml-2 text-accent text-xs underline">Pokaż/Ukryj Podgląd</button>
                            </div>
                            <div id="wikiPagePreview" class="mt-2 p-4 border border-[var(--border-card)] rounded-md bg-[var(--bg-primary)] min-h-[100px] prose prose-sm max-w-none hidden"></div>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                            <button type="button" id="backToWikiPageListButton" class="btn btn-secondary w-full sm:w-auto">Wróć do Listy</button>
                            <button type="submit" id="saveWikiPageButton" class="btn btn-primary w-full sm:w-auto">
                                <span class="button-text">Utwórz Stronę Wiki</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                    <div id="wikiPageUpdateStatus" class="text-sm mt-3"></div>
                </div>
            </div>

            <div id="supportManagement" class="tab-content">
                 {/* ... (existing supportManagement content) ... */}
            </div>

            <div id="shopManagement" class="tab-content">
                {/* ... (existing shopManagement content) ... */}
            </div>

            <div id="warningsManagement" class="tab-content">
                {/* ... (existing warningsManagement content) ... */}
            </div>

            <div id="botConfigManagement" class="tab-content">
                {/* ... (existing botConfigManagement content) ... */}
            </div>

            <div id="adminMessage" class="hidden mt-6"></div>
        </div>
    </main>

    <footer class="py-6 text-center text-sm text-text-secondary border-t border-[var(--border-card)] mt-auto">
        &copy; <span id="currentYear"></span> Kroniki Elary - Panel Administracyjny
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" integrity="sha512-H+rglffZ6f5JvnrFnbqwkdnKOBK6I99CfA6EED2PYG0i2XfHPDhOBW9JWW2NfW9pdUqCwhKSoLgImY1hD/x77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.5/marked.min.js" integrity="sha512-Q3K7ZgbB5KzEh0F9S4vN2QGg/1/6gL8bZj7n3D0l5PjBwW03R/0Bf1u/EIsHjk6WlT4fNlP7LXZgA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // --- Global Admin Panel Logic & Auth ---
        // (Existing functions setActiveTab, updateAuthDisplay, setupMobileMenu, setupDropdownDismiss, displayAdminMessage, toggleButtonLoadingState)
        // ...
        function setActiveTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.tab === tabName) button.classList.add('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabName) content.classList.add('active');
            });
            localStorage.setItem('activeAdminTab', tabName); // Save active tab
        }

        async function updateAuthDisplay() {
            // ... (existing implementation, ensure GUILD_ID is correctly defined/fetched if used)
        }

        function setupMobileMenu() { /* ... (existing implementation) ... */ }
        function setupDropdownDismiss() { /* ... (existing implementation) ... */ }
        function displayAdminMessage(message, type = 'info', duration = 5000) { /* ... (existing implementation) ... */ }
        function toggleButtonLoadingState(button, isLoading) { /* ... (existing implementation) ... */ }

        // --- Content Management Logic ---
        // (Existing functions fetchContentKeys, loadContent, event listeners for content management)
        // ...

        // --- Shop Management Logic ---
        // (Existing functions fetchShopItems, renderShopItemsTable, populateShopItemForm, addEventListenersToShopItemButtons, event listeners for shop management)
        // ...

        // --- Warnings Management Logic ---
        // (Existing functions addWarning, removeWarning, searchWarnings, event listeners for warnings management)
        // ...

        // --- Bot Config Management Logic ---
        // (Existing functions loadBotConfig, saveXpConfig, saveChannelXpConfig, removeChannelXpConfig, saveOtherConfig, event listeners for bot config)
        // ...

        // --- Article Management Specific Logic ---
        let currentAdminArticlePage = 1;
        let editingArticleId = null;
        let editingCategoryId = null;
        // Wiki Management State
        let currentAdminWikiPage = 1;
        let editingWikiPageId = null;


        const adminArticleListContainer = document.getElementById('adminArticleListContainer');
        const adminArticleFormContainer = document.getElementById('adminArticleFormContainer');
        const articlesTableContainer = document.getElementById('articlesTableContainer');
        const articleListPaginationControls = document.getElementById('articleListPaginationControls');
        const articleListLoading = document.getElementById('articleListLoading');
        const articleListError = document.getElementById('articleListError');
        const articleListEmpty = document.getElementById('articleListEmpty');

        const showCreateArticleFormButton = document.getElementById('showCreateArticleFormButton');
        const articleFormTitle = document.getElementById('articleFormTitle');
        const adminArticleForm = document.getElementById('adminArticleForm');
        const articleTitleInput = document.getElementById('articleTitle');
        const articleSlugInput = document.getElementById('articleSlug');
        const articleContentInput = document.getElementById('articleContent');
        const articleStatusInput = document.getElementById('articleStatus');
        const articleIsFeaturedInput = document.getElementById('articleIsFeatured');
        const articleCategoriesSelect = document.getElementById('articleCategoriesSelect');
        const saveArticleButton = document.getElementById('saveArticleButton');
        const backToArticleListButton = document.getElementById('backToArticleListButton');

        const togglePreviewButton = document.getElementById('togglePreviewButton');
        const articlePreview = document.getElementById('articlePreview');

        // Category Management Elements
        const adminCategoryManagementSection = document.getElementById('adminCategoryManagementSection');
        const adminCategoryForm = document.getElementById('adminCategoryForm');
        const editingCategoryIdInput = document.getElementById('editingCategoryId');
        const categoryNameInput = document.getElementById('categoryName');
        const categorySlugInput = document.getElementById('categorySlug');
        const saveCategoryButton = document.getElementById('saveCategoryButton');
        const clearCategoryFormButton = document.getElementById('clearCategoryFormButton');
        const adminCategoriesListContainer = document.getElementById('adminCategoriesListContainer');
        const categoryListLoading = document.getElementById('categoryListLoading');
        const categoryListError = document.getElementById('categoryListError');
        const categoryListEmpty = document.getElementById('categoryListEmpty');

        // Wiki Management Elements
        const adminWikiPageListContainer = document.getElementById('adminWikiPageListContainer');
        const adminWikiPageFormContainer = document.getElementById('adminWikiPageFormContainer');
        const wikiPagesTableContainer = document.getElementById('wikiPagesTableContainer');
        const wikiPageListPaginationControls = document.getElementById('wikiPageListPaginationControls');
        const wikiPageListLoading = document.getElementById('wikiPageListLoading');
        const wikiPageListError = document.getElementById('wikiPageListError');
        const wikiPageListEmpty = document.getElementById('wikiPageListEmpty');
        const showCreateWikiPageFormButton = document.getElementById('showCreateWikiPageFormButton');
        const wikiPageFormTitle = document.getElementById('wikiPageFormTitle');
        const adminWikiPageForm = document.getElementById('adminWikiPageForm');
        const wikiPageTitleInput = document.getElementById('wikiPageTitle');
        const wikiPageSlugInput = document.getElementById('wikiPageSlug');
        const wikiPageContentInput = document.getElementById('wikiPageContent');
        const saveWikiPageButton = document.getElementById('saveWikiPageButton');
        const backToWikiPageListButton = document.getElementById('backToWikiPageListButton');
        const toggleWikiPreviewButton = document.getElementById('toggleWikiPreviewButton');
        const wikiPagePreview = document.getElementById('wikiPagePreview');
        const wikiPageUpdateStatus = document.getElementById('wikiPageUpdateStatus');


        if (togglePreviewButton && articleContentInput && articlePreview) {
            togglePreviewButton.addEventListener('click', () => {
                articlePreview.classList.toggle('hidden');
                if (!articlePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    articlePreview.innerHTML = DOMPurify.sanitize(marked.parse(articleContentInput.value));
                }
            });
            articleContentInput.addEventListener('input', () => {
                 if (!articlePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    articlePreview.innerHTML = DOMPurify.sanitize(marked.parse(articleContentInput.value));
                }
            });
        }

        if (toggleWikiPreviewButton && wikiPageContentInput && wikiPagePreview) {
            toggleWikiPreviewButton.addEventListener('click', () => {
                wikiPagePreview.classList.toggle('hidden');
                if (!wikiPagePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    wikiPagePreview.innerHTML = DOMPurify.sanitize(marked.parse(wikiPageContentInput.value));
                }
            });
            wikiPageContentInput.addEventListener('input', () => {
                if (!wikiPagePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    wikiPagePreview.innerHTML = DOMPurify.sanitize(marked.parse(wikiPageContentInput.value));
                }
            });
        }


        function showArticleListScreen() {
            if(adminArticleFormContainer) adminArticleFormContainer.style.display = 'none';
            if(adminArticleListContainer) adminArticleListContainer.style.display = 'block';
            if(adminCategoryManagementSection) adminCategoryManagementSection.style.display = 'block';
            editingArticleId = null;
            fetchAdminArticles(currentAdminArticlePage);
            fetchAdminCategories();
            populateArticleCategorySelect();
            if (articlePreview && !articlePreview.classList.contains('hidden')) {
                articlePreview.classList.add('hidden');
            }
        }

        async function showArticleFormScreen(articleId = null) {
            if(adminArticleListContainer) adminArticleListContainer.style.display = 'none';
            if(adminCategoryManagementSection) adminCategoryManagementSection.style.display = 'none';
            if(adminArticleFormContainer) adminArticleFormContainer.style.display = 'block';
            if(adminArticleForm) adminArticleForm.reset();
            editingArticleId = articleId;

            await populateArticleCategorySelect();
            if (articleCategoriesSelect) {
                Array.from(articleCategoriesSelect.options).forEach(opt => opt.selected = false);
            }

            const formTitleEl = document.getElementById('articleFormTitle');
            const saveButtonTextSpan = saveArticleButton.querySelector('.button-text');

            if (articleId) {
                if(formTitleEl) formTitleEl.textContent = 'Edytuj Artykuł';
                if(saveButtonTextSpan) saveButtonTextSpan.textContent = 'Zaktualizuj Artykuł';
                toggleButtonLoadingState(saveArticleButton, true);
                try {
                    const response = await fetch(new URL(`/api/admin/articles/${articleId}`, window.location.href).href);
                    if (!response.ok) throw new Error(`Błąd ładowania artykułu: ${response.status}`);
                    const article = await response.json();
                    if(articleTitleInput) articleTitleInput.value = article.title;
                    if(articleSlugInput) articleSlugInput.value = article.slug;
                    if(articleContentInput) articleContentInput.value = article.content;
                    if(articleStatusInput) articleStatusInput.value = article.status;
                    if(articleIsFeaturedInput) articleIsFeaturedInput.checked = article.isFeatured || false;

                    if (article.Categories && articleCategoriesSelect) {
                        const categoryIds = article.Categories.map(cat => cat.id.toString());
                        Array.from(articleCategoriesSelect.options).forEach(opt => {
                            if (categoryIds.includes(opt.value)) opt.selected = true;
                        });
                    }
                    if (articlePreview && !articlePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                         articlePreview.innerHTML = DOMPurify.sanitize(marked.parse(article.content));
                    }
                } catch (error) {
                    console.error("Błąd ładowania artykułu do edycji:", error);
                    displayAdminMessage(`Nie udało się załadować artykułu: ${error.message}`, 'error');
                    showArticleListScreen();
                } finally {
                    toggleButtonLoadingState(saveArticleButton, false);
                }
            } else {
                if(formTitleEl) formTitleEl.textContent = 'Utwórz Nowy Artykuł';
                if(saveButtonTextSpan) saveButtonTextSpan.textContent = 'Utwórz Artykuł';
                if(articleIsFeaturedInput) articleIsFeaturedInput.checked = false;
                if (articlePreview && !articlePreview.classList.contains('hidden')) {
                    articlePreview.classList.add('hidden');
                }
            }
        }

        async function fetchAdminArticles(page = 1) {
            currentAdminArticlePage = page;
            if (!articlesTableContainer || !articleListLoading || !articleListError || !articleListEmpty || !articleListPaginationControls) return;
            articleListLoading.classList.remove('hidden');
            articlesTableContainer.innerHTML = '';
            articleListError.classList.add('hidden');
            articleListEmpty.classList.add('hidden');
            articleListPaginationControls.innerHTML = '';
            try {
                const response = await fetch(new URL(`/api/admin/articles?page=${page}&limit=10`, window.location.href).href);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.articles && data.articles.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'admin-table w-full';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th class="w-3/12">Tytuł</th>
                                <th class="w-2/12">Autor</th>
                                <th class="w-1/12">Status</th>
                                <th class="w-1/12 text-center">Polecany?</th>
                                <th class="w-2/12">Slug</th>
                                <th class="w-2/12">Ostatnia modyfikacja</th>
                                <th class="w-2/12">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.articles.map(article => `
                                <tr>
                                    <td class="font-medium text-primary">${article.title}</td>
                                    <td>${article.authorName}</td>
                                    <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${article.status === 'published' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${article.status}</span></td>
                                    <td class="text-center">${article.isFeatured ? '<span class="text-green-400 font-bold">★</span>' : '<span class="text-secondary">-</span>'}</td>
                                    <td>${article.slug}</td>
                                    <td>${new Date(article.updatedAt).toLocaleString('pl-PL')}</td>
                                    <td class="whitespace-nowrap">
                                        <button class="btn btn-secondary btn-action-sm edit-article-btn" data-id="${article.id}">Edytuj</button>
                                        <button class="btn btn-danger btn-action-sm delete-article-btn" data-id="${article.id}" data-title="${article.title}">Usuń</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    articlesTableContainer.appendChild(table);
                    renderArticlePaginationControls(data.totalPages, data.currentPage);
                    document.querySelectorAll('.edit-article-btn').forEach(btn => btn.addEventListener('click', () => showArticleFormScreen(btn.dataset.id)));
                    document.querySelectorAll('.delete-article-btn').forEach(btn => btn.addEventListener('click', () => deleteArticle(btn.dataset.id, btn.dataset.title)));
                } else {
                    articleListEmpty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd ładowania listy artykułów:', error);
                articleListError.textContent = `Nie udało się załadować listy artykułów: ${error.message}`;
                articleListError.classList.remove('hidden');
            } finally {
                articleListLoading.classList.add('hidden');
            }
        }

        function renderArticlePaginationControls(totalPages, page) {
            if (totalPages <= 1) { articleListPaginationControls.innerHTML = ''; return; }
            let paginationHTML = '';
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 1 ? 'disabled' : ''} onclick="changeAdminArticlePage(${page - 1})">Poprzednia</button>`;
            paginationHTML += `<span class="text-sm text-secondary">Strona ${page} z ${totalPages}</span>`;
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page === totalPages ? 'disabled' : ''} onclick="changeAdminArticlePage(${page + 1})">Następna</button>`;
            articleListPaginationControls.innerHTML = paginationHTML;
        }

        window.changeAdminArticlePage = (newPage) => { fetchAdminArticles(newPage); };

        async function handleArticleFormSubmit(event) {
            event.preventDefault();
            if (!saveArticleButton) return;
            toggleButtonLoadingState(saveArticleButton, true);
            const selectedCategoryIds = Array.from(articleCategoriesSelect.selectedOptions).map(opt => parseInt(opt.value, 10));
            const articleData = {
                title: articleTitleInput.value,
                content: articleContentInput.value,
                slug: articleSlugInput.value.trim() === '' ? null : articleSlugInput.value.trim(),
                status: articleStatusInput.value,
                isFeatured: articleIsFeaturedInput.checked,
                categoryIds: selectedCategoryIds
            };
            let url, method;
            if (editingArticleId) {
                url = new URL(`/api/admin/articles/${editingArticleId}`, window.location.href).href;
                method = 'PUT';
            } else {
                url = new URL('/api/admin/articles', window.location.href).href;
                method = 'POST';
            }
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(articleData) });
                const result = await response.json();
                if (response.ok) {
                    displayAdminMessage(`Artykuł "${result.title}" ${editingArticleId ? 'zaktualizowany' : 'utworzony'} pomyślnie!`, 'success');
                    showArticleListScreen();
                } else {
                    displayAdminMessage(`Błąd: ${result.error || 'Nieznany błąd serwera'}`, 'error');
                }
            } catch (error) {
                console.error('Błąd zapisu artykułu:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                toggleButtonLoadingState(saveArticleButton, false);
            }
        }

        async function deleteArticle(articleId, articleTitle) {
            if (!confirm(`Czy na pewno chcesz usunąć artykuł "${articleTitle}" (ID: ${articleId})? Tej operacji nie można cofnąć.`)) return;
            const deleteButton = document.querySelector(`.delete-article-btn[data-id="${articleId}"]`);
            if(deleteButton) toggleButtonLoadingState(deleteButton, true);
            try {
                const response = await fetch(new URL(`/api/admin/articles/${articleId}`, window.location.href).href, { method: 'DELETE' });
                if (response.ok) {
                    displayAdminMessage(`Artykuł "${articleTitle}" usunięty pomyślnie.`, 'success');
                    fetchAdminArticles(currentAdminArticlePage);
                } else {
                    const result = await response.json().catch(() => ({error: 'Nieznany błąd serwera'}));
                    displayAdminMessage(`Błąd usuwania artykułu: ${result.error || response.status}`, 'error');
                }
            } catch (error) {
                console.error('Błąd sieci podczas usuwania artykułu:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                 if(deleteButton) toggleButtonLoadingState(deleteButton, false);
            }
        }

        async function fetchAdminCategories() {
            if (!adminCategoriesListContainer || !categoryListLoading || !categoryListError || !categoryListEmpty) return;
            categoryListLoading.classList.remove('hidden');
            adminCategoriesListContainer.innerHTML = '';
            categoryListError.classList.add('hidden');
            categoryListEmpty.classList.add('hidden');
            try {
                const response = await fetch(new URL('/api/admin/categories', window.location.href).href);
                if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                const categories = await response.json();
                if (categories && categories.length > 0) {
                    adminCategoriesListContainer.innerHTML = `
                        <table class="admin-table w-full text-sm">
                            <thead><tr><th>ID</th><th>Nazwa</th><th>Slug</th><th>Akcje</th></tr></thead>
                            <tbody>
                                ${categories.map(cat => `
                                    <tr><td>${cat.id}</td><td>${cat.name}</td><td>${cat.slug}</td>
                                    <td class="whitespace-nowrap">
                                        <button class="btn btn-secondary btn-action-sm edit-category-btn" data-id="${cat.id}" data-name="${cat.name}" data-slug="${cat.slug}">Edytuj</button>
                                        <button class="btn btn-danger btn-action-sm delete-category-btn" data-id="${cat.id}" data-name="${cat.name}">Usuń</button>
                                    </td></tr>`).join('')}
                            </tbody></table>`;
                    adminCategoriesListContainer.querySelectorAll('.edit-category-btn').forEach(btn => btn.addEventListener('click', () => editCategory({id: btn.dataset.id, name: btn.dataset.name, slug: btn.dataset.slug})));
                    adminCategoriesListContainer.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', () => deleteCategory(btn.dataset.id, btn.dataset.name)));
                } else {
                    categoryListEmpty.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Błąd ładowania kategorii:", error);
                categoryListError.textContent = `Nie udało się załadować kategorii: ${error.message}`;
                categoryListError.classList.remove('hidden');
            } finally {
                categoryListLoading.classList.add('hidden');
            }
        }

        async function handleCategoryFormSubmit(event) {
            event.preventDefault();
            if (!saveCategoryButton) return;
            toggleButtonLoadingState(saveCategoryButton, true);
            const categoryData = { name: categoryNameInput.value, slug: categorySlugInput.value.trim() === '' ? null : categorySlugInput.value.trim() };
            let url, method;
            if (editingCategoryId) {
                url = new URL(`/api/admin/categories/${editingCategoryId}`, window.location.href).href;
                method = 'PUT';
            } else {
                url = new URL('/api/admin/categories', window.location.href).href;
                method = 'POST';
            }
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(categoryData) });
                const result = await response.json();
                if (response.ok) {
                    displayAdminMessage(`Kategoria "${result.name}" ${editingCategoryId ? 'zaktualizowana' : 'utworzona'}!`, 'success');
                    clearCategoryForm();
                    await fetchAdminCategories();
                    await populateArticleCategorySelect();
                } else {
                    displayAdminMessage(`Błąd: ${result.error || 'Nieznany błąd serwera'}`, 'error');
                }
            } catch (error) {
                console.error('Błąd zapisu kategorii:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                toggleButtonLoadingState(saveCategoryButton, false);
            }
        }

        function editCategory(category) {
            if(editingCategoryIdInput) editingCategoryIdInput.value = category.id;
            editingCategoryId = category.id;
            if(categoryNameInput) categoryNameInput.value = category.name;
            if(categorySlugInput) categorySlugInput.value = category.slug;
            if(saveCategoryButton) saveCategoryButton.querySelector('.button-text').textContent = 'Zaktualizuj Kategorię';
            if(categoryNameInput) categoryNameInput.focus();
        }

        function clearCategoryForm() {
            if(adminCategoryForm) adminCategoryForm.reset();
            if(editingCategoryIdInput) editingCategoryIdInput.value = '';
            editingCategoryId = null;
            if(saveCategoryButton) saveCategoryButton.querySelector('.button-text').textContent = 'Utwórz Kategorię';
        }

        if(clearCategoryFormButton) clearCategoryFormButton.addEventListener('click', clearCategoryForm);

        async function deleteCategory(categoryId, categoryName) {
            if (!confirm(`Czy na pewno chcesz usunąć kategorię "${categoryName}" (ID: ${categoryId})? Spowoduje to usunięcie jej powiązań z artykułami.`)) return;
            try {
                const response = await fetch(new URL(`/api/admin/categories/${categoryId}`, window.location.href).href, { method: 'DELETE' });
                if (response.ok) {
                    displayAdminMessage(`Kategoria "${categoryName}" usunięta.`, 'success');
                    await fetchAdminCategories();
                    await populateArticleCategorySelect();
                } else {
                    const result = await response.json().catch(()=>({error: 'Nieznany błąd serwera'}));
                    displayAdminMessage(`Błąd usuwania kategorii: ${result.error || response.status}`, 'error');
                }
            } catch (error) {
                console.error('Błąd sieci podczas usuwania kategorii:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            }
        }

        async function populateArticleCategorySelect() {
            if (!articleCategoriesSelect) return;
            try {
                const response = await fetch(new URL('/api/admin/categories', window.location.href).href);
                if (!response.ok) throw new Error('Nie udało się załadować kategorii dla formularza artykułu.');
                const categories = await response.json();
                articleCategoriesSelect.innerHTML = '';
                if (categories && categories.length > 0) {
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        articleCategoriesSelect.appendChild(option);
                    });
                } else {
                    articleCategoriesSelect.innerHTML = '<option value="" disabled>Brak kategorii. Dodaj je poniżej.</option>';
                }
            } catch (error) {
                console.error("Błąd populowania selektora kategorii:", error);
                articleCategoriesSelect.innerHTML = '<option value="" disabled>Błąd ładowania kategorii.</option>';
            }
        }

        if (showCreateArticleFormButton) showCreateArticleFormButton.addEventListener('click', () => showArticleFormScreen());
        if (backToArticleListButton) backToArticleListButton.addEventListener('click', showArticleListScreen);
        if (adminArticleForm) adminArticleForm.addEventListener('submit', handleArticleFormSubmit);
        if (adminCategoryForm) adminCategoryForm.addEventListener('submit', handleCategoryFormSubmit);

        const originalSetActiveTab = setActiveTab;
        setActiveTab = (tabName) => {
            originalSetActiveTab(tabName);
            if (tabName === 'articleManagement') {
                showArticleListScreen();
            } else if (tabName === 'wikiManagement') {
                showWikiPageListScreen();
            }
            // Add other else if for new tabs as needed
        };

        // --- Wiki Management Specific Logic ---
        function showWikiPageListScreen() {
            if(adminWikiPageFormContainer) adminWikiPageFormContainer.style.display = 'none';
            if(adminWikiPageListContainer) adminWikiPageListContainer.style.display = 'block';
            editingWikiPageId = null;
            fetchAdminWikiPages(currentAdminWikiPage);
            if (wikiPagePreview && !wikiPagePreview.classList.contains('hidden')) {
                wikiPagePreview.classList.add('hidden');
            }
        }

        async function showWikiPageFormScreen(pageId = null) {
            if(adminWikiPageListContainer) adminWikiPageListContainer.style.display = 'none';
            if(adminWikiPageFormContainer) adminWikiPageFormContainer.style.display = 'block';
            if(adminWikiPageForm) adminWikiPageForm.reset();
            editingWikiPageId = pageId;

            const formTitleEl = document.getElementById('wikiPageFormTitle');
            const saveBtnText = saveWikiPageButton.querySelector('.button-text');

            if (pageId) {
                if(formTitleEl) formTitleEl.textContent = 'Edytuj Stronę Wiki';
                if(saveBtnText) saveBtnText.textContent = 'Zaktualizuj Stronę Wiki';
                toggleButtonLoadingState(saveWikiPageButton, true);
                try {
                    const response = await fetch(new URL(`/api/admin/wiki/pages/${pageId}`, window.location.href).href);
                    if (!response.ok) throw new Error(`Błąd ładowania strony wiki: ${response.status}`);
                    const pageData = await response.json();
                    if(wikiPageTitleInput) wikiPageTitleInput.value = pageData.title;
                    if(wikiPageSlugInput) wikiPageSlugInput.value = pageData.slug;
                    if(wikiPageContentInput) wikiPageContentInput.value = pageData.content;
                    if (wikiPagePreview && !wikiPagePreview.classList.contains('hidden') && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                        wikiPagePreview.innerHTML = DOMPurify.sanitize(marked.parse(pageData.content));
                    }
                } catch (error) {
                    console.error("Błąd ładowania strony wiki do edycji:", error);
                    displayAdminMessage(`Nie udało się załadować strony wiki: ${error.message}`, 'error');
                    showWikiPageListScreen();
                } finally {
                    toggleButtonLoadingState(saveWikiPageButton, false);
                }
            } else {
                if(formTitleEl) formTitleEl.textContent = 'Utwórz Nową Stronę Wiki';
                if(saveBtnText) saveBtnText.textContent = 'Utwórz Stronę Wiki';
                if (wikiPagePreview && !wikiPagePreview.classList.contains('hidden')) {
                    wikiPagePreview.classList.add('hidden');
                }
            }
        }

        async function fetchAdminWikiPages(page = 1) {
            currentAdminWikiPage = page;
            if (!wikiPagesTableContainer || !wikiPageListLoading || !wikiPageListError || !wikiPageListEmpty || !wikiPageListPaginationControls) return;
            wikiPageListLoading.classList.remove('hidden');
            wikiPagesTableContainer.innerHTML = '';
            wikiPageListError.classList.add('hidden');
            wikiPageListEmpty.classList.add('hidden');
            wikiPageListPaginationControls.innerHTML = '';
            try {
                const response = await fetch(new URL(`/api/admin/wiki/pages?page=${page}&limit=10`, window.location.href).href);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.entries && data.entries.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'admin-table w-full';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th><th>Tytuł</th><th>Slug</th><th>Autor</th><th>Ost. Edytor</th><th>Ost. Aktualizacja</th><th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.entries.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td class="font-medium text-primary">${p.title}</td>
                                    <td>${p.slug}</td>
                                    <td>${p.authorName}</td>
                                    <td>${p.lastEditorName || '-'}</td>
                                    <td>${new Date(p.updatedAt).toLocaleString('pl-PL')}</td>
                                    <td class="whitespace-nowrap">
                                        <button class="btn btn-secondary btn-action-sm edit-wikipage-btn" data-id="${p.id}">Edytuj</button>
                                        <button class="btn btn-danger btn-action-sm delete-wikipage-btn" data-id="${p.id}" data-title="${p.title}">Usuń</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    wikiPagesTableContainer.appendChild(table);
                    renderWikiPagePaginationControls(data.totalPages, data.currentPage);
                    document.querySelectorAll('.edit-wikipage-btn').forEach(btn => btn.addEventListener('click', () => showWikiPageFormScreen(btn.dataset.id)));
                    document.querySelectorAll('.delete-wikipage-btn').forEach(btn => btn.addEventListener('click', () => deleteWikiPage(btn.dataset.id, btn.dataset.title)));
                } else {
                    wikiPageListEmpty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd ładowania listy stron wiki:', error);
                wikiPageListError.textContent = `Nie udało się załadować listy stron wiki: ${error.message}`;
                wikiPageListError.classList.remove('hidden');
            } finally {
                wikiPageListLoading.classList.add('hidden');
            }
        }

        function renderWikiPagePaginationControls(totalPages, page) {
            if (totalPages <= 1) { wikiPageListPaginationControls.innerHTML = ''; return; }
            let paginationHTML = '';
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 1 ? 'disabled' : ''} onclick="changeAdminWikiPage(${page - 1})">Poprzednia</button>`;
            paginationHTML += `<span class="text-sm text-secondary">Strona ${page} z ${totalPages}</span>`;
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page === totalPages ? 'disabled' : ''} onclick="changeAdminWikiPage(${page + 1})">Następna</button>`;
            wikiPageListPaginationControls.innerHTML = paginationHTML;
        }
        window.changeAdminWikiPage = (newPage) => { fetchAdminWikiPages(newPage); };

        async function handleWikiPageFormSubmit(event) {
            event.preventDefault();
            if (!saveWikiPageButton) return;
            toggleButtonLoadingState(saveWikiPageButton, true);
            const wikiPageData = {
                title: wikiPageTitleInput.value,
                content: wikiPageContentInput.value,
                slug: wikiPageSlugInput.value.trim() === '' ? null : wikiPageSlugInput.value.trim(),
            };
            let url, method;
            if (editingWikiPageId) {
                url = new URL(`/api/admin/wiki/pages/${editingWikiPageId}`, window.location.href).href;
                method = 'PUT';
            } else {
                url = new URL('/api/admin/wiki/pages', window.location.href).href;
                method = 'POST';
            }
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(wikiPageData) });
                const result = await response.json();
                if (response.ok) {
                    displayAdminMessage(`Strona wiki "${result.title}" ${editingWikiPageId ? 'zaktualizowana' : 'utworzona'} pomyślnie!`, 'success');
                    showWikiPageListScreen();
                } else {
                    displayAdminMessage(`Błąd: ${result.error || 'Nieznany błąd serwera'}`, 'error');
                }
            } catch (error) {
                console.error('Błąd zapisu strony wiki:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                toggleButtonLoadingState(saveWikiPageButton, false);
            }
        }

        async function deleteWikiPage(pageId, pageTitle) {
            if (!confirm(`Czy na pewno chcesz usunąć stronę wiki "${pageTitle}" (ID: ${pageId})? Tej operacji nie można cofnąć.`)) return;
            const deleteButton = document.querySelector(`.delete-wikipage-btn[data-id="${pageId}"]`);
            if(deleteButton) toggleButtonLoadingState(deleteButton, true);
            try {
                const response = await fetch(new URL(`/api/admin/wiki/pages/${pageId}`, window.location.href).href, { method: 'DELETE' });
                if (response.ok) {
                    displayAdminMessage(`Strona wiki "${pageTitle}" usunięta pomyślnie.`, 'success');
                    fetchAdminWikiPages(currentAdminWikiPage);
                } else {
                    const result = await response.json().catch(() => ({error: 'Nieznany błąd serwera'}));
                    displayAdminMessage(`Błąd usuwania strony wiki: ${result.error || response.status}`, 'error');
                }
            } catch (error) {
                console.error('Błąd sieci podczas usuwania strony wiki:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                 if(deleteButton) toggleButtonLoadingState(deleteButton, false);
            }
        }

        if(showCreateWikiPageFormButton) showCreateWikiPageFormButton.addEventListener('click', () => showWikiPageFormScreen());
        if(backToWikiPageListButton) backToWikiPageListButton.addEventListener('click', showWikiPageListScreen);
        if(adminWikiPageForm) adminWikiPageForm.addEventListener('submit', handleWikiPageFormSubmit);

        // --- Document Ready ---
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            if (!document.documentElement.classList.contains('light') && !document.documentElement.classList.contains('dark')) {
                 document.documentElement.classList.add('dark');
            }
            await updateAuthDisplay();
            setupMobileMenu();
            setupDropdownDismiss();
            const initialAdminTab = localStorage.getItem('activeAdminTab') || 'contentManagement';
            setActiveTab(initialAdminTab);
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => setActiveTab(button.dataset.tab));
            });
        });
    </script>
</body>
</html>
