<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #293548; 
            --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6; 
            --border-card: rgba(167, 139, 250, 0.25); 
            --btn-primary-bg: #8B5CF6; 
            --btn-primary-hover-bg: #7C3AED; 
            --btn-danger-bg: #EF4444; 
            --btn-danger-hover-bg: #DC2626; 
            --btn-success-bg: #22C55E;
            --btn-success-hover-bg: #16A34A;
            --btn-warning-bg: #F59E0B; /* Amber 500 */
            --btn-warning-hover-bg: #D97706; /* Amber 600 */
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.25); 
            --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
        }
        html.light { 
            /* Light theme is kept same as dark for admin panel for now */
            --bg-primary: #0F172A; --bg-secondary: #1E293B; --bg-card: #293548; --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; --text-secondary: #94A3B8; --text-accent: #A78BFA; --text-accent-hover: #8B5CF6;
            --border-accent: #8B5CF6; --border-card: rgba(167, 139, 250, 0.25);
            --btn-primary-bg: #8B5CF6; --btn-primary-hover-bg: #7C3AED; --btn-danger-bg: #EF4444; --btn-danger-hover-bg: #DC2626;
            --btn-success-bg: #22C55E; --btn-success-hover-bg: #16A34A; --btn-warning-bg: #F59E0B; --btn-warning-hover-bg: #D97706;
            --btn-discord-bg: #5865F2; --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0; --shadow-color: rgba(167, 139, 250, 0.25); --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 600; }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(18px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 5px 15px -4px rgba(15,23,42,0.2); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.65rem 1.1rem; border-radius: 0.6rem; font-weight: 500; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent),0.12); }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 3px; bottom: 5px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1.5px; }
        .nav-link.active::after { width: 60%; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.5rem; box-shadow: 0 10px 25px -5px var(--shadow-strong-color), 0 8px 10px -6px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s linear 0.2s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition-delay: 0s; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.15s ease, color 0.15s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent),0.1); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-secondary); border: 1px solid var(--border-card); color: var(--text-primary); border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--border-accent); box-shadow: 0 0 0 3px rgba(var(--rgb-accent),0.3); }
        .form-label { color: var(--text-secondary); margin-bottom: 0.5rem; display: block; font-weight: 500; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease; letter-spacing: 0.03em; }
        .btn-primary { background-color: var(--btn-primary-bg); color: white; } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px var(--shadow-strong-color); }
        .btn-secondary { background-color: var(--bg-card); border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.75rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: rgba(var(--rgb-accent),0.15); transform: translateY(-2px); box-shadow: 0 6px 12px -3px var(--shadow-color); }
        .btn-success { background-color: var(--btn-success-bg); color: white; } .btn-success:hover { background-color: var(--btn-success-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(34,197,94,0.4); }
        .btn-danger { background-color: var(--btn-danger-bg); color: white; } .btn-danger:hover { background-color: var(--btn-danger-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(239,68,68,0.4); }
        .btn-warning { background-color: var(--btn-warning-bg); color: white; } .btn-warning:hover { background-color: var(--btn-warning-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(245,158,11,0.4); }
        .btn-discord { background-color: #5865F2; color: white; } .btn-discord:hover { background-color: #4752C4; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(88,101,242,0.4); }
        #adminMessage { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; text-align: center; font-weight: 500; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateY(10px); }
        #adminMessage.visible { opacity: 1; transform: translateY(0); }
        #adminMessage.success { background-color: rgba(52, 211, 153, 0.15); color: #34D399; border: 1px solid rgba(52, 211, 153, 0.4); }
        #adminMessage.error { background-color: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        #adminMessage.info { background-color: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.4); }
        #mobileMenu { transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none;  }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .loading-spinner { border: 3px solid rgba(var(--rgb-accent), 0.3); border-top-color: var(--text-accent); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .admin-table th, .admin-table td { border: 1px solid var(--border-card); padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: rgba(var(--rgb-accent), 0.1); color: var(--text-accent); font-weight: 600; }
        .admin-table td .form-input, .admin-table td .form-select { padding: 0.5rem; font-size: 0.875rem; }
        .admin-table td .btn { padding: 0.4rem 0.8rem; font-size: 0.875rem; margin-left: 0.5rem; }
        .admin-table .item-icon-preview { font-size: 1.5rem; width: 2rem; text-align: center; }
        .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; }
        .tab-button:hover { color: var(--text-accent); }
        .tab-button.active { color: var(--text-accent); border-bottom-color: var(--text-accent); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: var(--text-primary); margin-top: 1.25em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; } .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; } .prose li { margin-bottom: 0.25em; }
        .prose a { color: var(--text-accent); } .prose strong { color: var(--text-primary); } .prose code { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 0.25rem; }
        .prose pre { background-color: var(--bg-secondary); padding: 0.75em; border-radius: 0.375rem; overflow-x: auto; }
        .tox .tox-edit-area__iframe { background-color: var(--bg-secondary) !important; }
        .tox .tox-edit-area__iframe body { color: var(--text-primary) !important; }
        .status-badge { padding: 0.2em 0.6em; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;}
        .status-published { background-color: rgba(34,197,94,0.2); color: #22C55E; } /* green */
        .status-draft { background-color: rgba(251,191,36,0.2); color: #FBBF24; } /* amber */
        .status-pending_approval { background-color: rgba(59,130,246,0.2); color: #3B82F6; } /* blue */
        .status-pending { background-color: rgba(59,130,246,0.2); color: #3B82F6; } /* blue for fanart */
        .status-approved { background-color: rgba(34,197,94,0.2); color: #22C55E; } /* green for fanart */
        .status-rejected { background-color: rgba(239,68,68,0.2); color: #EF4444; } /* red for fanart */
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header id="navbar" class="sticky top-0 z-50 py-3 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span> <span class="text-sm text-red-400 font-normal">[Panel Admina]</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <div id="auth-section-nav" class="ml-4 relative"></div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative"></div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otwórz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button data-tab="contentManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Treścią</button>
                <button data-tab="articleManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Artykułami</button>
                <button data-tab="wikiManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wiki</button>
                <button data-tab="fanArtManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Galerią</button>
                <button data-tab="supportManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wsparciem</button>
                <button data-tab="shopManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Sklepem</button>
                <button data-tab="warningsManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Ostrzeżeniami</button>
                <button data-tab="botConfigManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Konfiguracja Bota</button>
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona Główna Serwisu</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 sm:px-6 py-8">
        <div id="admin-panel-container">
            <div class="mb-6 border-b border-[var(--border-card)]">
                <nav class="flex -mb-px space-x-1 flex-wrap" aria-label="Tabs">
                    <button data-tab="contentManagement" class="tab-button active">Zarządzanie Treścią</button>
                    <button data-tab="articleManagement" class="tab-button">Zarządzanie Artykułami</button>
                    <button data-tab="wikiManagement" class="tab-button">Zarządzanie Wiki</button>
                    <button data-tab="fanArtManagement" class="tab-button">Zarządzanie Galerią</button>
                    <button data-tab="supportManagement" class="tab-button">Zarządzanie Wsparciem</button>
                    <button data-tab="shopManagement" class="tab-button">Zarządzanie Sklepem</button>
                    <button data-tab="warningsManagement" class="tab-button">Zarządzanie Ostrzeżeniami</button>
                    <button data-tab="botConfigManagement" class="tab-button">Konfiguracja Bota</button>
                </nav>
            </div>

            <div id="admin-login-prompt" class="text-center py-12" style="display:none;">
                <h2 class="text-2xl font-semibold text-primary mb-4">Dostęp Wymaga Uwierzytelnienia</h2>
                <p class="text-secondary mb-6">Musisz być zalogowany jako administrator, aby uzyskać dostęp do tego panelu.</p>
                <a href="/auth/discord/login?redirect=/admin.html" class="btn-discord !text-white px-6 py-3 rounded-lg text-md inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg>
                    Zaloguj przez Discord
                </a>
            </div>

            <div id="contentManagement" class="tab-content">
                {/* ... existing content ... */}
            </div>

            <div id="articleManagement" class="tab-content">
                {/* ... existing content ... */}
            </div>

            <div id="wikiManagement" class="tab-content">
                {/* ... existing content ... */}
            </div>

            <div id="fanArtManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Galerią Fan Art</h1>
                <div id="adminFanArtListContainer" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-accent">Oczekujące Fan Arty</h2>
                        {/* Add filters for other statuses later if needed */}
                    </div>
                    <div id="fanArtSubmissionsTableContainer" class="overflow-x-auto">
                        {/* Table will be rendered here by JavaScript */}
                    </div>
                    <div id="fanArtPaginationControls" class="mt-6 flex justify-center items-center space-x-3">
                        {/* Pagination will be rendered here */}
                    </div>
                    <div id="fanArtListLoading" class="text-center py-6 text-secondary hidden"><span class="loading-spinner !w-8 !h-8"></span> Ładowanie zgłoszeń...</div>
                    <div id="fanArtListError" class="text-center py-6 text-red-400 hidden"></div>
                    <div id="fanArtListEmpty" class="text-center py-6 text-secondary hidden">Brak fan artów oczekujących na akceptację.</div>
                </div>
            </div>

            <div id="supportManagement" class="tab-content">
                 {/* ... (existing supportManagement content) ... */}
            </div>

            <div id="shopManagement" class="tab-content">
                {/* ... (existing shopManagement content) ... */}
            </div>

            <div id="warningsManagement" class="tab-content">
                {/* ... (existing warningsManagement content) ... */}
            </div>

            <div id="botConfigManagement" class="tab-content">
                {/* ... (existing botConfigManagement content) ... */}
            </div>

            <div id="adminMessage" class="hidden mt-6"></div>
        </div>
    </main>

    <footer class="py-6 text-center text-sm text-text-secondary border-t border-[var(--border-card)] mt-auto">
        &copy; <span id="currentYear"></span> Kroniki Elary - Panel Administracyjny
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" integrity="sha512-H+rglffZ6f5JvnrFnbqwkdnKOBK6I99CfA6EED2PYG0i2XfHPDhOBW9JWW2NfW9pdUqCwhKSoLgImY1hD/x77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.5/marked.min.js" integrity="sha512-Q3K7ZgbB5KzEh0F9S4vN2QGg/1/6gL8bZj7n3D0l5PjBwW03R/0Bf1u/EIsHjk6WlT4fNlP7LXZgA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // --- Global Admin Panel Logic & Auth ---
        function setActiveTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.tab === tabName) button.classList.add('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                // Destroy TinyMCE instances if the tab is being hidden
                if (content.id === 'articleManagement' && content.id !== tabName) {
                    if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                        tinymce.get('articleContent').remove();
                    }
                }
                if (content.id === 'wikiManagement' && content.id !== tabName) {
                    if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                        tinymce.get('wikiPageContent').remove();
                    }
                }
                content.classList.remove('active');
                if (content.id === tabName) content.classList.add('active');
            });
            localStorage.setItem('activeAdminTab', tabName);
        }

        async function updateAuthDisplay() { /* ... (existing implementation) ... */ }
        function setupMobileMenu() { /* ... (existing implementation) ... */ }
        function setupDropdownDismiss() { /* ... (existing implementation) ... */ }
        function displayAdminMessage(message, type = 'info', duration = 5000) { /* ... (existing implementation) ... */ }
        function toggleButtonLoadingState(button, isLoading, loadingText = "Ładowanie...") { /* ... (existing implementation, ensure loadingText is handled) ... */ }

        // --- Content Management Logic ---
        /* ... (existing implementation) ... */

        // --- Shop Management Logic ---
        /* ... (existing implementation) ... */

        // --- Warnings Management Logic ---
        /* ... (existing implementation) ... */

        // --- Bot Config Management Logic ---
        /* ... (existing implementation) ... */

        // --- Article Management Specific Logic ---
        /* ... (existing implementation including TinyMCE) ... */

        // --- Wiki Management Specific Logic ---
        /* ... (existing implementation including TinyMCE & Categories) ... */

        // --- Fan Art Gallery Management Logic ---
        let currentAdminFanArtPage = 1;
        // let currentFanArtFilter = 'pending'; // For future use if more filters are added

        const adminFanArtListContainer = document.getElementById('adminFanArtListContainer');
        const fanArtSubmissionsTableContainer = document.getElementById('fanArtSubmissionsTableContainer');
        const fanArtPaginationControls = document.getElementById('fanArtPaginationControls');
        const fanArtListLoading = document.getElementById('fanArtListLoading');
        const fanArtListError = document.getElementById('fanArtListError');
        const fanArtListEmpty = document.getElementById('fanArtListEmpty');

        async function fetchAdminFanArtSubmissions(page = 1) {
            currentAdminFanArtPage = page;
            // const status = currentFanArtFilter; // Use this if filter UI is added

            if (!fanArtSubmissionsTableContainer || !fanArtListLoading || !fanArtListError || !fanArtListEmpty || !fanArtPaginationControls) return;

            fanArtListLoading.classList.remove('hidden');
            fanArtSubmissionsTableContainer.innerHTML = '';
            fanArtListError.classList.add('hidden');
            fanArtListEmpty.classList.add('hidden');
            fanArtPaginationControls.innerHTML = '';

            try {
                // For now, only fetching 'pending' as per subtask. API might need ?status=pending
                const response = await fetch(new URL(`/api/admin/gallery/pending?page=${page}&limit=10`, window.location.href).href);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json(); // Assuming API returns { entries: [], totalPages: X, currentPage: Y }

                if (data.entries && data.entries.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'admin-table w-full';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th class="w-1/12">Podgląd</th>
                                <th class="w-3/12">Tytuł</th>
                                <th class="w-3/12">Opis</th>
                                <th class="w-2/12">Zgłoszony przez</th>
                                <th class="w-1/12">Data</th>
                                <th class="w-2/12">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.entries.map(item => `
                                <tr>
                                    <td><img src="${item.imageUrl}" alt="${item.title || 'Fan Art'}" class="h-16 w-auto object-contain rounded-sm"></td>
                                    <td class="font-medium text-primary">${item.title}</td>
                                    <td class="text-sm">${item.description ? item.description.substring(0, 100) + (item.description.length > 100 ? '...' : '') : '-'}</td>
                                    <td>${item.discordUserName} (${item.discordUserId})</td>
                                    <td>${new Date(item.createdAt).toLocaleDateString('pl-PL')}</td>
                                    <td class="whitespace-nowrap">
                                        <button class="btn btn-success btn-action-sm approve-fanart-btn" data-id="${item.id}">Akceptuj</button>
                                        <button class="btn btn-warning btn-action-sm reject-fanart-btn" data-id="${item.id}">Odrzuć</button>
                                        <button class="btn btn-danger btn-action-sm delete-fanart-btn" data-id="${item.id}" data-title="${item.title}">Usuń</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    fanArtSubmissionsTableContainer.appendChild(table);
                    renderFanArtPaginationControls(data.totalPages, data.currentPage);

                    document.querySelectorAll('.approve-fanart-btn').forEach(btn => btn.addEventListener('click', () => moderateFanArt(btn.dataset.id, 'approve')));
                    document.querySelectorAll('.reject-fanart-btn').forEach(btn => btn.addEventListener('click', () => moderateFanArt(btn.dataset.id, 'reject')));
                    document.querySelectorAll('.delete-fanart-btn').forEach(btn => btn.addEventListener('click', () => deleteFanArtPermanently(btn.dataset.id, btn.dataset.title)));

                } else {
                    fanArtListEmpty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd ładowania zgłoszeń fan art:', error);
                fanArtListError.textContent = `Nie udało się załadować zgłoszeń: ${error.message}`;
                fanArtListError.classList.remove('hidden');
            } finally {
                fanArtListLoading.classList.add('hidden');
            }
        }

        function renderFanArtPaginationControls(totalPages, page) {
            if (totalPages <= 1 || !fanArtPaginationControls) {
                if(fanArtPaginationControls) fanArtPaginationControls.innerHTML = '';
                return;
            }
            let paginationHTML = '';
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${page === 1 ? 'disabled' : ''} onclick="changeAdminFanArtPage(${page - 1})">Poprzednia</button>`;
            paginationHTML += `<span class="text-sm text-secondary">Strona ${page} z ${totalPages}</span>`;
            paginationHTML += `<button class="btn btn-secondary btn-action-sm ${page === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${page === totalPages ? 'disabled' : ''} onclick="changeAdminFanArtPage(${page + 1})">Następna</button>`;
            fanArtPaginationControls.innerHTML = paginationHTML;
        }
        window.changeAdminFanArtPage = (newPage) => { fetchAdminFanArtSubmissions(newPage); }; // Using currentFanArtFilter implicitly

        async function moderateFanArt(itemId, action) {
            const actionText = action === 'approve' ? 'zaakceptować' : 'odrzucić';
            if (!confirm(`Czy na pewno chcesz ${actionText} ten fan art (ID: ${itemId})?`)) return;

            const buttonSelector = action === 'approve' ? `.approve-fanart-btn[data-id="${itemId}"]` : `.reject-fanart-btn[data-id="${itemId}"]`;
            const button = document.querySelector(buttonSelector);
            if(button) toggleButtonLoadingState(button, true, action === 'approve' ? "Akceptowanie..." : "Odrzucanie...");

            try {
                const response = await fetch(`/api/admin/gallery/${itemId}/${action}`, { method: 'PUT' });
                if (response.ok) {
                    displayAdminMessage(`Fan art ${action === 'approve' ? 'zaakceptowany' : 'odrzucony'} pomyślnie.`, 'success');
                    fetchAdminFanArtSubmissions(currentAdminFanArtPage); // Refresh current page & filter
                } else {
                    const result = await response.json().catch(() => ({ error: 'Nieznany błąd serwera' }));
                    displayAdminMessage(`Błąd moderacji fan artu: ${result.error || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error(`Błąd sieci podczas moderacji fan artu (${action}):`, error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                 if(button) toggleButtonLoadingState(button, false, action === 'approve' ? "Akceptuj" : "Odrzuć");
            }
        }

        async function deleteFanArtPermanently(itemId, itemTitle) {
            if (!confirm(`Czy na pewno chcesz USUNĄĆ PERMANENTNIE fan art "${itemTitle}" (ID: ${itemId})? Tej operacji nie można cofnąć i plik zostanie usunięty z serwera.`)) return;
            const deleteButton = document.querySelector(`.delete-fanart-btn[data-id="${itemId}"]`);
            if(deleteButton) toggleButtonLoadingState(deleteButton, true, "Usuwanie...");

            try {
                const response = await fetch(`/api/admin/gallery/${itemId}`, { method: 'DELETE' });
                if (response.ok) { // Could be 200 with message or 204
                    displayAdminMessage(`Fan art "${itemTitle}" usunięty permanentnie.`, 'success');
                    fetchAdminFanArtSubmissions(currentAdminFanArtPage); // Refresh current page & filter
                } else {
                    const result = await response.json().catch(() => ({ error: 'Nieznany błąd serwera' }));
                    displayAdminMessage(`Błąd usuwania fan artu: ${result.error || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Błąd sieci podczas usuwania fan artu:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                if(deleteButton) toggleButtonLoadingState(deleteButton, false, "Usuń Permanentnie");
            }
        }


        const originalSetActiveTab = setActiveTab;
        setActiveTab = (tabName) => {
            const currentActiveTab = localStorage.getItem('activeAdminTab');
            // Destroy TinyMCE instances if the tab is being hidden
            if (currentActiveTab === 'articleManagement' && tabName !== 'articleManagement') {
                if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                    tinymce.get('articleContent').remove();
                }
            }
            if (currentActiveTab === 'wikiManagement' && tabName !== 'wikiManagement') {
                 if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                    tinymce.get('wikiPageContent').remove();
                }
            }

            originalSetActiveTab(tabName);
            if (tabName === 'articleManagement') {
                showArticleListScreen();
            } else if (tabName === 'wikiManagement') {
                showWikiPageListScreen();
            } else if (tabName === 'fanArtManagement') {
                fetchAdminFanArtSubmissions(); // Default to page 1, status 'pending'
            }
        };

        // --- Document Ready ---
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            if (!document.documentElement.classList.contains('light') && !document.documentElement.classList.contains('dark')) {
                 document.documentElement.classList.add('dark');
            }
            // Ensure existing implementations of updateAuthDisplay etc. are available or defined above
            // Example: if updateAuthDisplay is not defined above, this will error.
            // For this exercise, assuming they are defined above or this is the only relevant part.
            await updateAuthDisplay();
            setupMobileMenu();
            setupDropdownDismiss();
            const initialAdminTab = localStorage.getItem('activeAdminTab') || 'contentManagement';
            setActiveTab(initialAdminTab);
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => setActiveTab(button.dataset.tab));
            });
        });
    </script>
</body>
</html>
