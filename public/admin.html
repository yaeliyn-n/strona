<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administracyjny - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #293548; 
            --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6; 
            --border-card: rgba(167, 139, 250, 0.25); 
            --btn-primary-bg: #8B5CF6; 
            --btn-primary-hover-bg: #7C3AED; 
            --btn-danger-bg: #EF4444; 
            --btn-danger-hover-bg: #DC2626; 
            --btn-success-bg: #22C55E;
            --btn-success-hover-bg: #16A34A;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.25); 
            --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
        }
        html.light { 
            /* Light theme is kept same as dark for admin panel for now */
            --bg-primary: #0F172A; --bg-secondary: #1E293B; --bg-card: #293548; --bg-header: rgba(15, 23, 42, 0.92);
            --text-primary: #E2E8F0; --text-secondary: #94A3B8; --text-accent: #A78BFA; --text-accent-hover: #8B5CF6;
            --border-accent: #8B5CF6; --border-card: rgba(167, 139, 250, 0.25);
            --btn-primary-bg: #8B5CF6; --btn-primary-hover-bg: #7C3AED; --btn-danger-bg: #EF4444; --btn-danger-hover-bg: #DC2626;
            --btn-success-bg: #22C55E; --btn-success-hover-bg: #16A34A; --btn-discord-bg: #5865F2; --btn-discord-hover-bg: #4752C4;
            --svg-icon-fill: #E2E8F0; --shadow-color: rgba(167, 139, 250, 0.25); --shadow-strong-color: rgba(167, 139, 250, 0.4);
            --modal-backdrop: rgba(15, 23, 42, 0.85);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        h1, h2, h3 { font-family: 'Lora', serif; font-weight: 600; }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(18px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 5px 15px -4px rgba(15,23,42,0.2); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.65rem 1.1rem; border-radius: 0.6rem; font-weight: 500; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent),0.12); }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 3px; bottom: 5px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1.5px; }
        .nav-link.active::after { width: 60%; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.5rem; box-shadow: 0 10px 25px -5px var(--shadow-strong-color), 0 8px 10px -6px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s linear 0.2s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition-delay: 0s; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.15s ease, color 0.15s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent),0.1); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; }
        .form-input, .form-select, .form-textarea { background-color: var(--bg-secondary); border: 1px solid var(--border-card); color: var(--text-primary); border-radius: 0.375rem; padding: 0.75rem 1rem; width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--border-accent); box-shadow: 0 0 0 3px rgba(var(--rgb-accent),0.3); }
        .form-label { color: var(--text-secondary); margin-bottom: 0.5rem; display: block; font-weight: 500; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.25s ease, transform 0.25s ease, box-shadow 0.25s ease; letter-spacing: 0.03em; }
        .btn-primary { background-color: var(--btn-primary-bg); color: white; } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: translateY(-2px); box-shadow: 0 8px 15px -3px var(--shadow-strong-color); }
        .btn-secondary { background-color: var(--bg-card); border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.75rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: rgba(var(--rgb-accent),0.15); transform: translateY(-2px); box-shadow: 0 6px 12px -3px var(--shadow-color); }
        .btn-success { background-color: #22C55E; color: white; } .btn-success:hover { background-color: #16A34A; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(34,197,94,0.4); }
        .btn-danger { background-color: #EF4444; color: white; } .btn-danger:hover { background-color: #DC2626; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(239,68,68,0.4); }
        .btn-discord { background-color: #5865F2; color: white; } .btn-discord:hover { background-color: #4752C4; transform: translateY(-2px); box-shadow: 0 8px 15px -3px rgba(88,101,242,0.4); }
        #adminMessage { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; text-align: center; font-weight: 500; transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; transform: translateY(10px); }
        #adminMessage.visible { opacity: 1; transform: translateY(0); }
        #adminMessage.success { background-color: rgba(52, 211, 153, 0.15); color: #34D399; border: 1px solid rgba(52, 211, 153, 0.4); }
        #adminMessage.error { background-color: rgba(239, 68, 68, 0.15); color: #EF4444; border: 1px solid rgba(239, 68, 68, 0.4); }
        #adminMessage.info { background-color: rgba(59, 130, 246, 0.15); color: #3B82F6; border: 1px solid rgba(59, 130, 246, 0.4); }
        #mobileMenu { transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none;  }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .loading-spinner { border: 3px solid rgba(var(--rgb-accent), 0.3); border-top-color: var(--text-accent); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 0.5rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .admin-table th, .admin-table td { border: 1px solid var(--border-card); padding: 0.75rem 1rem; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: rgba(var(--rgb-accent), 0.1); color: var(--text-accent); font-weight: 600; }
        .admin-table td .form-input, .admin-table td .form-select { padding: 0.5rem; font-size: 0.875rem; }
        .admin-table td .btn { padding: 0.4rem 0.8rem; font-size: 0.875rem; margin-left: 0.5rem; }
        .admin-table .item-icon-preview { font-size: 1.5rem; width: 2rem; text-align: center; }
        .tab-button { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-secondary); font-weight: 500; transition: color 0.2s ease, border-color 0.2s ease; }
        .tab-button:hover { color: var(--text-accent); }
        .tab-button.active { color: var(--text-accent); border-bottom-color: var(--text-accent); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 { color: var(--text-primary); margin-top: 1.25em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; } .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; } .prose li { margin-bottom: 0.25em; }
        .prose a { color: var(--text-accent); } .prose strong { color: var(--text-primary); } .prose code { background-color: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 0.25rem; }
        .prose pre { background-color: var(--bg-secondary); padding: 0.75em; border-radius: 0.375rem; overflow-x: auto; }
        /* Ensure TinyMCE content is visible in dark mode */
        .tox .tox-edit-area__iframe { background-color: var(--bg-secondary) !important; }
        .tox .tox-edit-area__iframe body { color: var(--text-primary) !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header id="navbar" class="sticky top-0 z-50 py-3 shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span> <span class="text-sm text-red-400 font-normal">[Panel Admina]</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <div id="auth-section-nav" class="ml-4 relative"></div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative"></div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otwórz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <button data-tab="contentManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Treścią</button>
                <button data-tab="articleManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Artykułami</button>
                <button data-tab="wikiManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wiki</button>
                <button data-tab="supportManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Wsparciem</button>
                <button data-tab="shopManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Sklepem</button>
                <button data-tab="warningsManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Zarządzanie Ostrzeżeniami</button>
                <button data-tab="botConfigManagement" class="tab-button block w-full text-left py-2.5 px-3 text-base font-medium">Konfiguracja Bota</button>
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona Główna Serwisu</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 sm:px-6 py-8">
        <div id="admin-panel-container">
            <div class="mb-6 border-b border-[var(--border-card)]">
                <nav class="flex -mb-px space-x-1 flex-wrap" aria-label="Tabs">
                    <button data-tab="contentManagement" class="tab-button active">Zarządzanie Treścią</button>
                    <button data-tab="articleManagement" class="tab-button">Zarządzanie Artykułami</button>
                    <button data-tab="wikiManagement" class="tab-button">Zarządzanie Wiki</button>
                    <button data-tab="supportManagement" class="tab-button">Zarządzanie Wsparciem</button>
                    <button data-tab="shopManagement" class="tab-button">Zarządzanie Sklepem</button>
                    <button data-tab="warningsManagement" class="tab-button">Zarządzanie Ostrzeżeniami</button>
                    <button data-tab="botConfigManagement" class="tab-button">Konfiguracja Bota</button>
                </nav>
            </div>

            <div id="admin-login-prompt" class="text-center py-12" style="display:none;">
                <h2 class="text-2xl font-semibold text-primary mb-4">Dostęp Wymaga Uwierzytelnienia</h2>
                <p class="text-secondary mb-6">Musisz być zalogowany jako administrator, aby uzyskać dostęp do tego panelu.</p>
                <a href="/auth/discord/login?redirect=/admin.html" class="btn-discord !text-white px-6 py-3 rounded-lg text-md inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg>
                    Zaloguj przez Discord
                </a>
            </div>

            <div id="contentManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Treścią Strony</h1>
                {/* ... (existing contentManagement content) ... */}
            </div>

            <div id="articleManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Artykułami</h1>
                <div id="adminArticleListContainer" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-accent">Lista Artykułów</h2>
                        <button id="showCreateArticleFormButton" class="btn btn-success">Utwórz Nowy Artykuł</button>
                    </div>
                    <div id="articlesTableContainer" class="overflow-x-auto"></div>
                    <div id="articleListPaginationControls" class="mt-6 flex justify-center items-center space-x-3"></div>
                    <div id="articleListLoading" class="text-center py-6 text-secondary hidden"><span class="loading-spinner !w-8 !h-8"></span> Ładowanie artykułów...</div>
                    <div id="articleListError" class="text-center py-6 text-red-400 hidden"></div>
                    <div id="articleListEmpty" class="text-center py-6 text-secondary hidden">Brak artykułów do wyświetlenia.</div>
                </div>

                <div id="adminArticleFormContainer" style="display:none;" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl mt-8">
                    <h2 id="articleFormTitle" class="text-2xl font-semibold text-accent mb-6">Utwórz Nowy Artykuł</h2>
                    <form id="adminArticleForm" class="space-y-6">
                        <div>
                            <label for="articleTitle" class="form-label">Tytuł Artykułu:</label>
                            <input type="text" id="articleTitle" name="title" class="form-input" required>
                        </div>
                        <div>
                            <label for="articleSlug" class="form-label">Slug (URL):</label>
                            <input type="text" id="articleSlug" name="slug" class="form-input" placeholder="Pozostaw puste, aby wygenerować automatycznie">
                            <p class="text-xs text-secondary mt-1">Unikalny identyfikator w URL, np. 'moj-pierwszy-artykul'.</p>
                        </div>
                        <div>
                            <label for="articleContent" class="form-label">Treść Artykułu:</label>
                            <textarea id="articleContent" name="content" rows="15" class="form-textarea" placeholder="Wpisz treść artykułu..."></textarea>
                        </div>
                        <div>
                            <label for="articleCategoriesSelect" class="form-label">Kategorie Artykułu:</label>
                            <select multiple id="articleCategoriesSelect" class="form-select h-32"></select>
                            <p class="text-xs text-secondary mt-1">Przytrzymaj Ctrl (lub Cmd na Mac), aby wybrać wiele.</p>
                        </div>
                        <div>
                            <label for="articleStatus" class="form-label">Status:</label>
                            <select id="articleStatus" name="status" class="form-select">
                                <option value="draft">Szkic (Draft)</option>
                                <option value="published">Opublikowany (Published)</option>
                            </select>
                        </div>
                        <div>
                            <label for="articleIsFeatured" class="form-label flex items-center">
                                <input type="checkbox" id="articleIsFeatured" name="isFeatured" class="mr-2 h-4 w-4 text-accent rounded border-[var(--border-card)] focus:ring-accent">
                                Oznacz jako Polecany (Featured)
                            </label>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                            <button type="button" id="backToArticleListButton" class="btn btn-secondary w-full sm:w-auto">Wróć do Listy</button>
                            <button type="submit" id="saveArticleButton" class="btn btn-primary w-full sm:w-auto">
                                <span class="button-text">Utwórz Artykuł</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="adminCategoryManagementSection" class="mt-12 bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <h2 class="text-2xl font-semibold text-accent mb-6">Zarządzanie Kategoriami Artykułów</h2>
                    <form id="adminCategoryForm" class="mb-8 space-y-4 md:space-y-0 md:flex md:items-end md:space-x-3">
                        <input type="hidden" id="editingCategoryId">
                        <div class="flex-grow">
                            <label for="categoryName" class="form-label">Nazwa Kategorii Artykułu:</label>
                            <input type="text" id="categoryName" name="name" class="form-input" required>
                        </div>
                        <div class="flex-grow">
                            <label for="categorySlug" class="form-label">Slug Kategorii Artykułu:</label>
                            <input type="text" id="categorySlug" name="slug" class="form-input" placeholder="Automatycznie z nazwy">
                        </div>
                        <div class="flex space-x-2 pt-4 md:pt-0">
                             <button type="submit" id="saveCategoryButton" class="btn btn-success whitespace-nowrap">
                                <span class="button-text">Dodaj Kategorię</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                            <button type="button" id="clearCategoryFormButton" class="btn btn-secondary whitespace-nowrap">Wyczyść</button>
                        </div>
                    </form>
                    <div id="adminCategoriesListContainer" class="overflow-x-auto"></div>
                    <div id="categoryListLoading" class="text-center py-4 text-secondary hidden"><span class="loading-spinner"></span> Ładowanie kategorii...</div>
                    <div id="categoryListError" class="text-center py-4 text-red-400 hidden"></div>
                    <div id="categoryListEmpty" class="text-center py-4 text-secondary hidden">Brak kategorii.</div>
                </div>
            </div>

            <div id="wikiManagement" class="tab-content">
                <h1 class="text-3xl font-bold text-primary mb-8 text-center">Panel Zarządzania Stronami Wiki</h1>
                <div id="adminWikiPageListContainer" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-accent">Lista Stron Wiki</h2>
                        <button id="showCreateWikiPageFormButton" class="btn btn-success">Utwórz Nową Stronę Wiki</button>
                    </div>
                    <div id="wikiPagesTableContainer" class="overflow-x-auto"></div>
                    <div id="wikiPageListPaginationControls" class="mt-6 flex justify-center items-center space-x-3"></div>
                    <div id="wikiPageListLoading" class="text-center py-6 text-secondary hidden"><span class="loading-spinner !w-8 !h-8"></span> Ładowanie stron wiki...</div>
                    <div id="wikiPageListError" class="text-center py-6 text-red-400 hidden"></div>
                    <div id="wikiPageListEmpty" class="text-center py-6 text-secondary hidden">Brak stron wiki do wyświetlenia.</div>
                </div>

                <div id="adminWikiPageFormContainer" style="display:none;" class="bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl mt-8">
                    <h2 id="wikiPageFormTitle" class="text-2xl font-semibold text-accent mb-6">Utwórz Nową Stronę Wiki</h2>
                    <form id="adminWikiPageForm" class="space-y-6">
                        <div>
                            <label for="wikiPageTitle" class="form-label">Tytuł Strony:</label>
                            <input type="text" id="wikiPageTitle" name="title" class="form-input" required>
                        </div>
                        <div>
                            <label for="wikiPageSlug" class="form-label">Slug (URL):</label>
                            <input type="text" id="wikiPageSlug" name="slug" class="form-input" placeholder="Pozostaw puste, aby wygenerować automatycznie">
                            <p class="text-xs text-secondary mt-1">Unikalny identyfikator w URL, np. 'moja-strona-wiki'.</p>
                        </div>
                        <div>
                            <label for="wikiPageContent" class="form-label">Treść Strony:</label>
                            <textarea id="wikiPageContent" name="content" rows="15" class="form-textarea" placeholder="Wpisz treść strony..."></textarea>
                        </div>
                        <div>
                            <label for="wikiPageCategoryIdSelect" class="form-label">Kategoria Wiki:</label>
                            <select id="wikiPageCategoryIdSelect" class="form-select">
                                <option value="">-- Brak Kategorii --</option>
                            </select>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                            <button type="button" id="backToWikiPageListButton" class="btn btn-secondary w-full sm:w-auto">Wróć do Listy</button>
                            <button type="submit" id="saveWikiPageButton" class="btn btn-primary w-full sm:w-auto">
                                <span class="button-text">Utwórz Stronę Wiki</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                    <div id="wikiPageUpdateStatus" class="text-sm mt-3"></div>
                </div>

                <div id="adminWikiCategoryManagementSection" class="mt-12 bg-bg-card p-6 sm:p-8 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold text-accent mb-4">Zarządzanie Kategoriami Wiki</h3>
                    <form id="adminWikiCategoryForm" class="mb-8 space-y-4 md:space-y-0 md:flex md:items-end md:space-x-3">
                        <input type="hidden" id="editingWikiCategoryId">
                        <div class="flex-grow">
                            <label for="wikiCategoryName" class="form-label">Nazwa Kategorii Wiki:</label>
                            <input type="text" id="wikiCategoryName" class="form-input" required>
                        </div>
                        <div class="flex-grow">
                            <label for="wikiCategorySlug" class="form-label">Slug Kategorii Wiki:</label>
                            <input type="text" id="wikiCategorySlug" class="form-input" placeholder="Automatycznie z nazwy">
                        </div>
                        <div class="flex space-x-2 pt-4 md:pt-0">
                            <button type="submit" id="saveWikiCategoryButton" class="btn btn-success whitespace-nowrap">
                                <span class="button-text">Dodaj Kategorię Wiki</span>
                                <span class="loading-spinner hidden"></span>
                            </button>
                            <button type="button" id="clearWikiCategoryFormButton" class="btn btn-secondary whitespace-nowrap">Wyczyść</button>
                        </div>
                    </form>
                    <div id="adminWikiCategoriesListContainer" class="overflow-x-auto"></div>
                    <div id="wikiCategoryListLoading" class="text-center py-4 text-secondary hidden"><span class="loading-spinner"></span> Ładowanie kategorii wiki...</div>
                    <div id="wikiCategoryListError" class="text-center py-4 text-red-400 hidden"></div>
                    <div id="wikiCategoryListEmpty" class="text-center py-4 text-secondary hidden">Brak kategorii wiki.</div>
                </div>
            </div>


            <div id="supportManagement" class="tab-content">
                 {/* ... (existing supportManagement content) ... */}
            </div>

            <div id="shopManagement" class="tab-content">
                {/* ... (existing shopManagement content) ... */}
            </div>

            <div id="warningsManagement" class="tab-content">
                {/* ... (existing warningsManagement content) ... */}
            </div>

            <div id="botConfigManagement" class="tab-content">
                {/* ... (existing botConfigManagement content) ... */}
            </div>

            <div id="adminMessage" class="hidden mt-6"></div>
        </div>
    </main>

    <footer class="py-6 text-center text-sm text-text-secondary border-t border-[var(--border-card)] mt-auto">
        &copy; <span id="currentYear"></span> Kroniki Elary - Panel Administracyjny
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" integrity="sha512-H+rglffZ6f5JvnrFnbqwkdnKOBK6I99CfA6EED2PYG0i2XfHPDhOBW9JWW2NfW9pdUqCwhKSoLgImY1hD/x77g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.5/marked.min.js" integrity="sha512-Q3K7ZgbB5KzEh0F9S4vN2QGg/1/6gL8bZj7n3D0l5PjBwW03R/0Bf1u/EIsHjk6WlT4fNlP7LXZgA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // --- Global Admin Panel Logic & Auth ---
        function setActiveTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.tab === tabName) button.classList.add('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                // Destroy TinyMCE instances if the tab is being hidden
                if (content.id === 'articleManagement' && content.id !== tabName) {
                    if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                        tinymce.get('articleContent').remove();
                    }
                }
                if (content.id === 'wikiManagement' && content.id !== tabName) {
                    if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                        tinymce.get('wikiPageContent').remove();
                    }
                }
                content.classList.remove('active');
                if (content.id === tabName) content.classList.add('active');
            });
            localStorage.setItem('activeAdminTab', tabName);
        }

        async function updateAuthDisplay() { /* ... (existing implementation) ... */ }
        function setupMobileMenu() { /* ... (existing implementation) ... */ }
        function setupDropdownDismiss() { /* ... (existing implementation) ... */ }
        function displayAdminMessage(message, type = 'info', duration = 5000) { /* ... (existing implementation) ... */ }
        function toggleButtonLoadingState(button, isLoading) { /* ... (existing implementation) ... */ }

        // --- Content Management Logic ---
        /* ... (existing implementation) ... */

        // --- Shop Management Logic ---
        /* ... (existing implementation) ... */

        // --- Warnings Management Logic ---
        /* ... (existing implementation) ... */

        // --- Bot Config Management Logic ---
        /* ... (existing implementation) ... */

        // --- Article Management Specific Logic ---
        let currentAdminArticlePage = 1;
        let editingArticleId = null;
        let currentFetchedArticleForEditor = null;
        let editingCategoryId = null;

        const adminArticleListContainer = document.getElementById('adminArticleListContainer');
        const adminArticleFormContainer = document.getElementById('adminArticleFormContainer');
        const articlesTableContainer = document.getElementById('articlesTableContainer');
        const articleListPaginationControls = document.getElementById('articleListPaginationControls');
        const articleListLoading = document.getElementById('articleListLoading');
        const articleListError = document.getElementById('articleListError');
        const articleListEmpty = document.getElementById('articleListEmpty');
        const showCreateArticleFormButton = document.getElementById('showCreateArticleFormButton');
        const articleFormTitle = document.getElementById('articleFormTitle');
        const adminArticleForm = document.getElementById('adminArticleForm');
        const articleTitleInput = document.getElementById('articleTitle');
        const articleSlugInput = document.getElementById('articleSlug');
        const articleContentInput = document.getElementById('articleContent');
        const articleStatusInput = document.getElementById('articleStatus');
        const articleIsFeaturedInput = document.getElementById('articleIsFeatured');
        const articleCategoriesSelect = document.getElementById('articleCategoriesSelect');
        const saveArticleButton = document.getElementById('saveArticleButton');
        const backToArticleListButton = document.getElementById('backToArticleListButton');

        // Article Category Management Elements
        const adminCategoryManagementSection = document.getElementById('adminCategoryManagementSection');
        const adminCategoryForm = document.getElementById('adminCategoryForm');
        const editingCategoryIdInput = document.getElementById('editingCategoryId');
        const categoryNameInput = document.getElementById('categoryName');
        const categorySlugInput = document.getElementById('categorySlug');
        const saveCategoryButton = document.getElementById('saveCategoryButton');
        const clearCategoryFormButton = document.getElementById('clearCategoryFormButton');
        const adminCategoriesListContainer = document.getElementById('adminCategoriesListContainer');
        const categoryListLoading = document.getElementById('categoryListLoading');
        const categoryListError = document.getElementById('categoryListError');
        const categoryListEmpty = document.getElementById('categoryListEmpty');

        // Wiki Management State
        let currentAdminWikiPage = 1;
        let editingWikiPageId = null;
        let currentFetchedWikiPageForEditor = null; // For Wiki Page TinyMCE
        let editingWikiCategoryId = null;

        // Wiki Management Elements
        const adminWikiPageListContainer = document.getElementById('adminWikiPageListContainer');
        const adminWikiPageFormContainer = document.getElementById('adminWikiPageFormContainer');
        const wikiPagesTableContainer = document.getElementById('wikiPagesTableContainer');
        const wikiPageListPaginationControls = document.getElementById('wikiPageListPaginationControls');
        const wikiPageListLoading = document.getElementById('wikiPageListLoading');
        const wikiPageListError = document.getElementById('wikiPageListError');
        const wikiPageListEmpty = document.getElementById('wikiPageListEmpty');
        const showCreateWikiPageFormButton = document.getElementById('showCreateWikiPageFormButton');
        const wikiPageFormTitle = document.getElementById('wikiPageFormTitle');
        const adminWikiPageForm = document.getElementById('adminWikiPageForm');
        const wikiPageTitleInput = document.getElementById('wikiPageTitle');
        const wikiPageSlugInput = document.getElementById('wikiPageSlug');
        const wikiPageContentInput = document.getElementById('wikiPageContent'); // Textarea for Wiki TinyMCE
        const wikiPageCategoryIdSelect = document.getElementById('wikiPageCategoryIdSelect');
        const saveWikiPageButton = document.getElementById('saveWikiPageButton');
        const backToWikiPageListButton = document.getElementById('backToWikiPageListButton');
        const wikiPageUpdateStatus = document.getElementById('wikiPageUpdateStatus');

        // Wiki Category Management Elements
        const adminWikiCategoryManagementSection = document.getElementById('adminWikiCategoryManagementSection');
        const adminWikiCategoryForm = document.getElementById('adminWikiCategoryForm');
        const editingWikiCategoryIdInput = document.getElementById('editingWikiCategoryId'); // For Wiki Category form
        const wikiCategoryNameInput = document.getElementById('wikiCategoryName');
        const wikiCategorySlugInput = document.getElementById('wikiCategorySlug');
        const saveWikiCategoryButton = document.getElementById('saveWikiCategoryButton');
        const clearWikiCategoryFormButton = document.getElementById('clearWikiCategoryFormButton');
        const adminWikiCategoriesListContainer = document.getElementById('adminWikiCategoriesListContainer');
        const wikiCategoryListLoading = document.getElementById('wikiCategoryListLoading');
        const wikiCategoryListError = document.getElementById('wikiCategoryListError');
        const wikiCategoryListEmpty = document.getElementById('wikiCategoryListEmpty');

        function showArticleListScreen() {
            if(adminArticleFormContainer) adminArticleFormContainer.style.display = 'none';
            if(adminArticleListContainer) adminArticleListContainer.style.display = 'block';
            if(adminCategoryManagementSection) adminCategoryManagementSection.style.display = 'block';
            editingArticleId = null;
            currentFetchedArticleForEditor = null;
            if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                tinymce.get('articleContent').remove();
            }
            fetchAdminArticles(currentAdminArticlePage);
            fetchAdminCategories();
            populateArticleCategorySelect();
        }

        async function showArticleFormScreen(articleId = null) {
            if(adminArticleListContainer) adminArticleListContainer.style.display = 'none';
            if(adminCategoryManagementSection) adminCategoryManagementSection.style.display = 'none';
            if(adminArticleFormContainer) adminArticleFormContainer.style.display = 'block';
            if(adminArticleForm) adminArticleForm.reset();
            editingArticleId = articleId;
            currentFetchedArticleForEditor = null;

            await populateArticleCategorySelect();
            if (articleCategoriesSelect) {
                Array.from(articleCategoriesSelect.options).forEach(opt => opt.selected = false);
            }

            const formTitleEl = document.getElementById('articleFormTitle');
            const saveButtonTextSpan = saveArticleButton.querySelector('.button-text');

            if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                tinymce.get('articleContent').remove();
            }
            if(articleContentInput) articleContentInput.value = '';


            if (articleId) {
                if(formTitleEl) formTitleEl.textContent = 'Edytuj Artykuł';
                if(saveButtonTextSpan) saveButtonTextSpan.textContent = 'Zaktualizuj Artykuł';
                toggleButtonLoadingState(saveArticleButton, true);
                try {
                    const response = await fetch(new URL(`/api/admin/articles/${articleId}`, window.location.href).href);
                    if (!response.ok) throw new Error(`Błąd ładowania artykułu: ${response.status}`);
                    const articleDataFromServer = await response.json();
                    currentFetchedArticleForEditor = articleDataFromServer;

                    if(articleTitleInput) articleTitleInput.value = currentFetchedArticleForEditor.title;
                    if(articleSlugInput) articleSlugInput.value = currentFetchedArticleForEditor.slug;
                    if(articleStatusInput) articleStatusInput.value = currentFetchedArticleForEditor.status;
                    if(articleIsFeaturedInput) articleIsFeaturedInput.checked = currentFetchedArticleForEditor.isFeatured || false;

                    if (currentFetchedArticleForEditor.Categories && articleCategoriesSelect) {
                        const categoryIds = currentFetchedArticleForEditor.Categories.map(cat => cat.id.toString());
                        Array.from(articleCategoriesSelect.options).forEach(opt => {
                            if (categoryIds.includes(opt.value)) opt.selected = true;
                        });
                    }
                } catch (error) {
                    console.error("Błąd ładowania artykułu do edycji:", error);
                    displayAdminMessage(`Nie udało się załadować artykułu: ${error.message}`, 'error');
                    showArticleListScreen();
                } finally {
                    toggleButtonLoadingState(saveArticleButton, false);
                }
            } else {
                if(formTitleEl) formTitleEl.textContent = 'Utwórz Nowy Artykuł';
                if(saveButtonTextSpan) saveButtonTextSpan.textContent = 'Utwórz Artykuł';
                if(articleIsFeaturedInput) articleIsFeaturedInput.checked = false;
                currentFetchedArticleForEditor = null;
            }

            if (typeof tinymce !== 'undefined') {
                tinymce.init({
                    selector: '#articleContent',
                    plugins: 'lists link image code help wordcount',
                    toolbar: 'undo redo | blocks | bold italic underline | bullist numlist | link image | code | help',
                    height: 450,
                    skin: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "oxide-dark" : "oxide",
                    content_css: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "dark" : "default",
                    setup: function(editor) {
                        editor.on('init', function() {
                            if (currentFetchedArticleForEditor && currentFetchedArticleForEditor.content) {
                                editor.setContent(currentFetchedArticleForEditor.content);
                            } else {
                                editor.setContent('');
                            }
                        });
                    }
                });
            } else {
                console.error("TinyMCE is not loaded for Articles. Article content will be a plain textarea.");
            }
        }

        async function fetchAdminArticles(page = 1) { /* ... (existing implementation) ... */ }
        function renderArticlePaginationControls(totalPages, page) { /* ... (existing implementation) ... */ }
        window.changeAdminArticlePage = (newPage) => { fetchAdminArticles(newPage); };

        async function handleArticleFormSubmit(event) {
            event.preventDefault();
            if (!saveArticleButton) return;
            toggleButtonLoadingState(saveArticleButton, true);

            const articleEditor = typeof tinymce !== 'undefined' ? tinymce.get('articleContent') : null;
            const content = articleEditor ? articleEditor.getContent() : articleContentInput.value;

            const selectedCategoryIds = Array.from(articleCategoriesSelect.selectedOptions).map(opt => parseInt(opt.value, 10));
            const articleData = {
                title: articleTitleInput.value,
                content: content,
                slug: articleSlugInput.value.trim() === '' ? null : articleSlugInput.value.trim(),
                status: articleStatusInput.value,
                isFeatured: articleIsFeaturedInput.checked,
                categoryIds: selectedCategoryIds
            };
            // ... (rest of the function remains the same)
            let url, method;
            if (editingArticleId) {
                url = new URL(`/api/admin/articles/${editingArticleId}`, window.location.href).href;
                method = 'PUT';
            } else {
                url = new URL('/api/admin/articles', window.location.href).href;
                method = 'POST';
            }
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(articleData) });
                const result = await response.json();
                if (response.ok) {
                    displayAdminMessage(`Artykuł "${result.title}" ${editingArticleId ? 'zaktualizowany' : 'utworzony'} pomyślnie!`, 'success');
                    showArticleListScreen();
                } else {
                    displayAdminMessage(`Błąd: ${result.error || 'Nieznany błąd serwera'}`, 'error');
                }
            } catch (error) {
                console.error('Błąd zapisu artykułu:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                toggleButtonLoadingState(saveArticleButton, false);
            }
        }

        async function deleteArticle(articleId, articleTitle) { /* ... (existing implementation) ... */ }
        async function fetchAdminCategories() { /* ... (existing implementation for Article Categories) ... */ }
        async function handleCategoryFormSubmit(event) { /* ... (existing implementation for Article Categories) ... */ }
        function editCategory(category) { /* ... (existing implementation for Article Categories) ... */ }
        function clearCategoryForm() { /* ... (existing implementation for Article Categories) ... */ }
        if(clearCategoryFormButton) clearCategoryFormButton.addEventListener('click', clearCategoryForm);
        async function deleteCategory(categoryId, categoryName) { /* ... (existing implementation for Article Categories) ... */ }
        async function populateArticleCategorySelect() { /* ... (existing implementation for Article form) ... */ }

        if (showCreateArticleFormButton) showCreateArticleFormButton.addEventListener('click', () => showArticleFormScreen());
        if (backToArticleListButton) backToArticleListButton.addEventListener('click', showArticleListScreen);
        if (adminArticleForm) adminArticleForm.addEventListener('submit', handleArticleFormSubmit);
        if (adminCategoryForm) adminCategoryForm.addEventListener('submit', handleCategoryFormSubmit);

        // --- Wiki Management Specific Logic ---
        function showWikiPageListScreen() {
            if(adminWikiPageFormContainer) adminWikiPageFormContainer.style.display = 'none';
            if(adminWikiCategoryManagementSection) adminWikiCategoryManagementSection.style.display = 'block';
            if(adminWikiPageListContainer) adminWikiPageListContainer.style.display = 'block';
            editingWikiPageId = null;
            currentFetchedWikiPageForEditor = null; // Reset for Wiki
            if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                tinymce.get('wikiPageContent').remove();
            }
            fetchAdminWikiPages(currentAdminWikiPage);
            fetchAdminWikiCategories();
            populateWikiPageCategorySelect();
        }

        async function showWikiPageFormScreen(pageId = null) {
            if(adminWikiPageListContainer) adminWikiPageListContainer.style.display = 'none';
            if(adminWikiCategoryManagementSection) adminWikiCategoryManagementSection.style.display = 'none';
            if(adminWikiPageFormContainer) adminWikiPageFormContainer.style.display = 'block';
            if(adminWikiPageForm) adminWikiPageForm.reset();
            editingWikiPageId = pageId;
            currentFetchedWikiPageForEditor = null; // Reset

            await populateWikiPageCategorySelect();
             if (wikiPageCategoryIdSelect) {
                wikiPageCategoryIdSelect.value = "";
            }

            const formTitleEl = document.getElementById('wikiPageFormTitle');
            const saveBtnText = saveWikiPageButton.querySelector('.button-text');

            if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                tinymce.get('wikiPageContent').remove();
            }
            if(wikiPageContentInput) wikiPageContentInput.value = '';


            if (pageId) {
                if(formTitleEl) formTitleEl.textContent = 'Edytuj Stronę Wiki';
                if(saveBtnText) saveBtnText.textContent = 'Zaktualizuj Stronę Wiki';
                toggleButtonLoadingState(saveWikiPageButton, true);
                try {
                    const response = await fetch(new URL(`/api/admin/wiki/pages/${pageId}`, window.location.href).href);
                    if (!response.ok) throw new Error(`Błąd ładowania strony wiki: ${response.status}`);
                    const pageDataFromServer = await response.json();
                    currentFetchedWikiPageForEditor = pageDataFromServer;

                    if(wikiPageTitleInput) wikiPageTitleInput.value = currentFetchedWikiPageForEditor.title;
                    if(wikiPageSlugInput) wikiPageSlugInput.value = currentFetchedWikiPageForEditor.slug;
                    if(wikiPageCategoryIdSelect && currentFetchedWikiPageForEditor.wikiCategory) {
                        wikiPageCategoryIdSelect.value = currentFetchedWikiPageForEditor.wikiCategory.id;
                    } else if (wikiPageCategoryIdSelect) {
                        wikiPageCategoryIdSelect.value = "";
                    }
                } catch (error) {
                    console.error("Błąd ładowania strony wiki do edycji:", error);
                    displayAdminMessage(`Nie udało się załadować strony wiki: ${error.message}`, 'error');
                    showWikiPageListScreen();
                } finally {
                    toggleButtonLoadingState(saveWikiPageButton, false);
                }
            } else {
                if(formTitleEl) formTitleEl.textContent = 'Utwórz Nową Stronę Wiki';
                if(saveBtnText) saveBtnText.textContent = 'Utwórz Stronę Wiki';
                currentFetchedWikiPageForEditor = null;
            }

            // Initialize TinyMCE for Wiki Page Content
            if (typeof tinymce !== 'undefined') {
                tinymce.init({
                    selector: '#wikiPageContent',
                    plugins: 'lists link image code help wordcount',
                    toolbar: 'undo redo | blocks | bold italic underline | bullist numlist | link image | code | help',
                    height: 450,
                    skin: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "oxide-dark" : "oxide",
                    content_css: (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? "dark" : "default",
                    setup: function(editor) {
                        editor.on('init', function() {
                            if (currentFetchedWikiPageForEditor && currentFetchedWikiPageForEditor.content) {
                                editor.setContent(currentFetchedWikiPageForEditor.content);
                            } else {
                                editor.setContent('');
                            }
                        });
                    }
                });
            } else {
                console.error("TinyMCE is not loaded for Wiki. Wiki content will be a plain textarea.");
            }
        }

        async function fetchAdminWikiPages(page = 1) { /* ... (existing implementation, ensure table includes category column) ... */
            currentAdminWikiPage = page;
            if (!wikiPagesTableContainer || !wikiPageListLoading || !wikiPageListError || !wikiPageListEmpty || !wikiPageListPaginationControls) return;
            wikiPageListLoading.classList.remove('hidden');
            wikiPagesTableContainer.innerHTML = '';
            wikiPageListError.classList.add('hidden');
            wikiPageListEmpty.classList.add('hidden');
            wikiPageListPaginationControls.innerHTML = '';
            try {
                const response = await fetch(new URL(`/api/admin/wiki/pages?page=${page}&limit=10`, window.location.href).href);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.entries && data.entries.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'admin-table w-full';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th><th>Tytuł</th><th>Kategoria</th><th>Slug</th><th>Autor</th><th>Ost. Edytor</th><th>Ost. Aktualizacja</th><th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.entries.map(p => `
                                <tr>
                                    <td>${p.id}</td>
                                    <td class="font-medium text-primary">${p.title}</td>
                                    <td>${p.wikiCategory ? p.wikiCategory.name : '-'}</td>
                                    <td>${p.slug}</td>
                                    <td>${p.authorName}</td>
                                    <td>${p.lastEditorName || '-'}</td>
                                    <td>${new Date(p.updatedAt).toLocaleString('pl-PL')}</td>
                                    <td class="whitespace-nowrap">
                                        <button class="btn btn-secondary btn-action-sm edit-wikipage-btn" data-id="${p.id}">Edytuj</button>
                                        <button class="btn btn-danger btn-action-sm delete-wikipage-btn" data-id="${p.id}" data-title="${p.title}">Usuń</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    wikiPagesTableContainer.appendChild(table);
                    renderWikiPagePaginationControls(data.totalPages, data.currentPage);
                    document.querySelectorAll('.edit-wikipage-btn').forEach(btn => btn.addEventListener('click', () => showWikiPageFormScreen(btn.dataset.id)));
                    document.querySelectorAll('.delete-wikipage-btn').forEach(btn => btn.addEventListener('click', () => deleteWikiPage(btn.dataset.id, btn.dataset.title)));
                } else {
                    wikiPageListEmpty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Błąd ładowania listy stron wiki:', error);
                wikiPageListError.textContent = `Nie udało się załadować listy stron wiki: ${error.message}`;
                wikiPageListError.classList.remove('hidden');
            } finally {
                wikiPageListLoading.classList.add('hidden');
            }
        }

        function renderWikiPagePaginationControls(totalPages, page) { /* ... (existing implementation) ... */ }
        window.changeAdminWikiPage = (newPage) => { fetchAdminWikiPages(newPage); };

        async function handleWikiPageFormSubmit(event) {
            event.preventDefault();
            if (!saveWikiPageButton) return;
            toggleButtonLoadingState(saveWikiPageButton, true);

            const wikiEditor = typeof tinymce !== 'undefined' ? tinymce.get('wikiPageContent') : null;
            const content = wikiEditor ? wikiEditor.getContent() : wikiPageContentInput.value;

            const selectedWikiCategoryId = document.getElementById('wikiPageCategoryIdSelect').value;
            const wikiPageData = {
                title: wikiPageTitleInput.value,
                content: content,
                slug: wikiPageSlugInput.value.trim() === '' ? null : wikiPageSlugInput.value.trim(),
                wikiCategoryId: selectedWikiCategoryId ? parseInt(selectedWikiCategoryId, 10) : null
            };
            // ... (rest of the function remains the same)
            let url, method;
            if (editingWikiPageId) {
                url = new URL(`/api/admin/wiki/pages/${editingWikiPageId}`, window.location.href).href;
                method = 'PUT';
            } else {
                url = new URL('/api/admin/wiki/pages', window.location.href).href;
                method = 'POST';
            }
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(wikiPageData) });
                const result = await response.json();
                if (response.ok) {
                    displayAdminMessage(`Strona wiki "${result.title}" ${editingWikiPageId ? 'zaktualizowana' : 'utworzona'} pomyślnie!`, 'success');
                    showWikiPageListScreen(); // This will also remove TinyMCE instance
                } else {
                    displayAdminMessage(`Błąd: ${result.error || 'Nieznany błąd serwera'}`, 'error');
                }
            } catch (error) {
                console.error('Błąd zapisu strony wiki:', error);
                displayAdminMessage(`Błąd sieci: ${error.message}`, 'error');
            } finally {
                toggleButtonLoadingState(saveWikiPageButton, false);
            }
        }

        async function deleteWikiPage(pageId, pageTitle) { /* ... (existing implementation) ... */ }

        if(showCreateWikiPageFormButton) showCreateWikiPageFormButton.addEventListener('click', () => showWikiPageFormScreen());
        if(backToWikiPageListButton) backToWikiPageListButton.addEventListener('click', showWikiPageListScreen);
        if(adminWikiPageForm) adminWikiPageForm.addEventListener('submit', handleWikiPageFormSubmit);

        // Wiki Category CRUD JS
        async function fetchAdminWikiCategories() { /* ... (existing implementation for Wiki Categories) ... */ }
        async function handleWikiCategoryFormSubmit(event) { /* ... (existing implementation for Wiki Categories) ... */ }
        function editWikiCategory(category) { /* ... (existing implementation for Wiki Categories) ... */ }
        function clearWikiCategoryForm() { /* ... (existing implementation for Wiki Categories) ... */ }
        if(clearWikiCategoryFormButton) clearWikiCategoryFormButton.addEventListener('click', clearWikiCategoryForm);
        async function deleteWikiCategory(categoryId, categoryName) { /* ... (existing implementation for Wiki Categories) ... */ }
        async function populateWikiPageCategorySelect() { /* ... (existing implementation for Wiki Page form) ... */ }
        if(adminWikiCategoryForm) adminWikiCategoryForm.addEventListener('submit', handleWikiCategoryFormSubmit);


        const originalSetActiveTab = setActiveTab;
        setActiveTab = (tabName) => {
            const currentActiveTab = localStorage.getItem('activeAdminTab');
            // Destroy TinyMCE if switching away from article management
            if (currentActiveTab === 'articleManagement' && tabName !== 'articleManagement') {
                if (typeof tinymce !== 'undefined' && tinymce.get('articleContent')) {
                    tinymce.get('articleContent').remove();
                }
            }
            // Destroy TinyMCE if switching away from wiki management
            if (currentActiveTab === 'wikiManagement' && tabName !== 'wikiManagement') {
                 if (typeof tinymce !== 'undefined' && tinymce.get('wikiPageContent')) {
                    tinymce.get('wikiPageContent').remove();
                }
            }

            originalSetActiveTab(tabName);
            if (tabName === 'articleManagement') {
                showArticleListScreen();
            } else if (tabName === 'wikiManagement') {
                showWikiPageListScreen();
            }
        };

        // --- Document Ready ---
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            if (!document.documentElement.classList.contains('light') && !document.documentElement.classList.contains('dark')) {
                 document.documentElement.classList.add('dark');
            }
            await updateAuthDisplay();
            setupMobileMenu();
            setupDropdownDismiss();
            const initialAdminTab = localStorage.getItem('activeAdminTab') || 'contentManagement';
            setActiveTab(initialAdminTab);
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => setActiveTab(button.dataset.tab));
            });
        });
    </script>
</body>
</html>
