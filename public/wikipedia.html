<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Encyklopedia wiedzy o świecie Kronik Elary. Odkryj lore, postacie, systemy i mechaniki naszego serwera Discord.">
    <meta name="keywords" content="kroniki elary, wikipedia, lore, aethelgard, postacie, systemy rpg, boty, discord, anime, manga, przewodniki, kategorie">
    <meta name="author" content="Arcadius & Strażnicy Kronik Elary">
    <title>Wikipedia Kronik Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #111827; 
            --bg-header: rgba(15, 23, 42, 0.92); 
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6;
            --border-card: rgba(167, 139, 250, 0.15); 
            --btn-primary-bg: #8B5CF6;
            --btn-primary-hover-bg: #7C3AED;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #8B5CF6;
            --scrollbar-thumb-hover-bg: #7C3AED;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.15); 
            --shadow-strong-color: rgba(167, 139, 250, 0.3); 
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
        }
        html.light {
            --bg-primary: #F9FAFB; 
            --bg-secondary: #F3F4F6; 
            --bg-card: #FFFFFF; 
            --bg-header: rgba(255, 255, 255, 0.95);
            --text-primary: #1F2937; 
            --text-secondary: #4B5563; 
            --text-accent: #7C3AED; 
            --text-accent-hover: #6D28D9; 
            --border-accent: #7C3AED;
            --border-card: rgba(124, 58, 237, 0.1);
            --btn-primary-bg: #7C3AED;
            --btn-primary-hover-bg: #6D28D9;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #A78BFA;
            --scrollbar-thumb-hover-bg: #8B5CF6;
            --svg-icon-fill: #374151;
            --shadow-color: rgba(124, 58, 237, 0.08);
            --shadow-strong-color: rgba(124, 58, 237, 0.15);
            --modal-backdrop: rgba(249, 250, 251, 0.85);
            --rgb-accent: 124, 58, 237;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.75; }
        h1, h2, h3, h4, h5 { font-family: 'Lora', serif; font-weight: 600; line-height: 1.35; }
        h1 { letter-spacing: -0.025em; font-weight: 700; } h2 { letter-spacing: -0.02em; font-weight: 700; } h3 { font-weight: 600; }
        .hero-wikipedia-bg { background: linear-gradient(rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.98)), url('https://placehold.co/1920x500/0a0f1e/a78bfa?text=Wikipedia+Kronik+Elary') center/cover no-repeat; }
        .section-bg { background-color: var(--bg-secondary); }
        .card-bg { background-color: var(--bg-card); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.3s ease; border: 1px solid var(--border-card); box-shadow: 0 6px 12px -3px var(--shadow-color); overflow: hidden; }
        .card-bg:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 24px -4px var(--shadow-strong-color); }
        .text-accent { color: var(--text-accent); }
        .reveal { opacity: 0; transform: translateY(50px); transition: opacity 0.8s cubic-bezier(0.645, 0.045, 0.355, 1), transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        .loading-spinner { border-color: var(--text-accent) transparent var(--text-accent) transparent; }
        .category-link.active { font-weight: bold; color: var(--text-accent); }
    </style>
</head>
<body class="antialiased">

    <header id="navbar" class="fixed top-0 left-0 right-0 z-50 py-3">
        </header>

    <main>
        <section class="hero-wikipedia-bg pt-32 pb-16 sm:pt-40 sm:pb-24 text-center reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-white mb-6 leading-tight text-shadow-custom">
                    Wikipedia <span class="text-accent">Kronik Elary</span>
                </h1>
                <p class="text-lg md:text-xl text-slate-200 mb-10 max-w-3xl mx-auto text-shadow-custom">
                    Twoje kompendium wiedzy o magicznym świecie Aethelgardu. Przeglądaj oficjalne strony i przewodniki tworzone przez społeczność.
                </p>
            </div>
        </section>

        <section id="dynamic-wiki-content" class="py-16 sm:py-20 section-bg reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="lg:w-1/4">
                        <div id="wiki-category-filter-container" class="p-6 bg-bg-card rounded-lg shadow-lg sticky top-28">
                            <h3 class="text-xl font-semibold text-accent mb-4">Kategorie Wiki</h3>
                            <div id="wiki-category-list-loading" class="text-center py-4 text-secondary">
                                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 loading-spinner mx-auto mb-2"></div>
                                Ładowanie kategorii...
                            </div>
                            <div id="wiki-category-list-error" class="text-red-400 hidden">Nie udało się załadować kategorii.</div>
                            <nav id="wiki-category-links" class="space-y-2"></nav>
                        </div>
                    </aside>
                    <div class="lg:w-3/4">
                        <div class="text-center mb-10">
                            <h2 id="wiki-list-main-title" class="text-3xl sm:text-4xl font-bold text-primary mb-3">Wszystkie Strony Wiki</h2>
                            <p id="wiki-list-subtitle" class="text-lg text-secondary max-w-2xl mx-auto">
                                Poniżej znajdziesz listę wszystkich dostępnych stron informacyjnych i przewodników. Kliknij tytuł, aby przeczytać więcej.
                            </p>
                        </div>

                        <div id="wiki-pages-list-container" class="grid md:grid-cols-2 gap-6">
                            {/* Dynamic content will be injected here */}
                        </div>
                        <div id="wiki-list-loading" class="text-center py-10 text-secondary">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 loading-spinner mx-auto mb-3"></div>
                            Ładowanie stron wiki...
                        </div>
                        <div id="wiki-list-error" class="text-center py-10 text-red-400 hidden">
                            Nie udało się załadować spisu stron. Spróbuj ponownie później.
                        </div>
                        <div id="wiki-list-empty" class="text-center py-10 text-secondary hidden">
                            Brak dostępnych stron wiki lub przewodników w tej kategorii.
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="dolacz-wiki" class="py-16 sm:py-20 reveal">
            <div class="container mx-auto px-4 sm:px-6 text-center">
                <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-6">Masz Pytania lub Chcesz Coś Dodać?</h2>
                <p class="text-lg text-secondary mb-10 max-w-xl mx-auto">
                    Nasza społeczność i Strażnicy są zawsze gotowi pomóc. Dołącz do dyskusji na Discordzie! Możesz także <a href="submit-wiki-page.html" class="text-accent hover:underline font-semibold">zaproponować własną stronę</a> do Wikipedii.
                </p>
                <a href="https://discord.gg/TWOJLINKZAPROSZENIOWY" target="_blank" rel="noopener noreferrer" class="btn-discord font-semibold py-3.5 px-8 text-lg inline-flex items-center shadow-xl">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg>
                    Przejdź na Discord
                </a>
            </div>
        </section>
    </main>

    <footer class="py-12 text-center" style="background-color: var(--bg-header);">
       </footer>

    <div id="eventModal" class="fixed inset-0 z-[60] items-center justify-center hidden p-4 modal"></div>

    <script src="js/main.js" defer></script>
    <script>
        let allWikiCategories = []; // Cache for category names

        async function fetchAllWikiCategories() {
            if (allWikiCategories.length > 0) return allWikiCategories;
            try {
                const response = await fetch('/api/wiki/categories');
                if (!response.ok) throw new Error('Nie udało się pobrać kategorii wiki.');
                allWikiCategories = await response.json();
                return allWikiCategories;
            } catch (error) {
                console.error("Błąd pobierania wszystkich kategorii wiki:", error);
                return []; // Return empty on error
            }
        }

        async function fetchAndDisplayWikiCategoriesFilterList() {
            const container = document.getElementById('wiki-category-links');
            const loadingDiv = document.getElementById('wiki-category-list-loading');
            const errorDiv = document.getElementById('wiki-category-list-error');

            if (!container || !loadingDiv || !errorDiv) return;

            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            container.innerHTML = '';

            const params = new URLSearchParams(window.location.search);
            const currentCategorySlug = params.get('category');

            try {
                const categories = await fetchAllWikiCategories(); // Use cached or fetch
                loadingDiv.classList.add('hidden');

                let listHtml = `<a href="wikipedia.html" class="block py-1.5 text-secondary hover:text-accent category-link ${!currentCategorySlug ? 'active' : ''}">Wszystkie Strony</a>`;
                if (categories && categories.length > 0) {
                    categories.forEach(cat => {
                        listHtml += `<a href="wikipedia.html?category=${cat.slug}" class="block py-1.5 text-secondary hover:text-accent category-link ${currentCategorySlug === cat.slug ? 'active' : ''}">${cat.name}</a>`;
                    });
                } else {
                    listHtml += '<p class="text-sm text-secondary">Brak kategorii.</p>';
                }
                container.innerHTML = listHtml;
            } catch (error) {
                console.error('Error fetching wiki categories for filter list:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = error.message;
            }
        }

        async function fetchAndDisplayWikiPages() {
            const container = document.getElementById('wiki-pages-list-container');
            const loadingDiv = document.getElementById('wiki-list-loading');
            const errorDiv = document.getElementById('wiki-list-error');
            const emptyDiv = document.getElementById('wiki-list-empty');
            const mainTitleEl = document.getElementById('wiki-list-main-title');
            const subtitleEl = document.getElementById('wiki-list-subtitle');

            if (!container || !loadingDiv || !errorDiv || !emptyDiv || !mainTitleEl || !subtitleEl) {
                console.error('Missing required elements for wiki page display.');
                return;
            }

            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            emptyDiv.classList.add('hidden');
            container.innerHTML = '';

            const params = new URLSearchParams(window.location.search);
            const categorySlug = params.get('category');

            let apiUrl = '/api/wiki/pages';
            if (categorySlug) {
                apiUrl += `?category=${categorySlug}`;
                await fetchAllWikiCategories();
                const currentCategory = allWikiCategories.find(c => c.slug === categorySlug);
                if (currentCategory) {
                    mainTitleEl.textContent = `Kategoria Wiki: ${currentCategory.name}`;
                    subtitleEl.textContent = `Strony i przewodniki w kategorii "${currentCategory.name}".`;
                } else {
                    mainTitleEl.textContent = 'Nieznana Kategoria';
                    subtitleEl.textContent = `Strony dla kategorii o slugu "${categorySlug}".`;
                }
            } else {
                mainTitleEl.textContent = 'Wszystkie Strony Wiki i Przewodniki';
                subtitleEl.textContent = 'Poniżej znajdziesz listę wszystkich dostępnych stron informacyjnych i przewodników.';
            }


            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pages = await response.json();

                loadingDiv.classList.add('hidden');

                if (pages && pages.length > 0) {
                    pages.forEach(page => {
                        let categoryLinkHTML = '';
                        if (page.wikiCategory && page.wikiCategory.name && page.wikiCategory.slug) {
                            categoryLinkHTML = `<p class="text-sm text-secondary mt-1">Kategoria: <a href="wikipedia.html?category=${page.wikiCategory.slug}" class="text-accent hover:underline">${page.wikiCategory.name}</a></p>`;
                        }

                        const pageCard = `
                            <a href="wiki-page-view.html?slug=${page.slug}" class="card-bg block p-6 rounded-lg hover:no-underline focus:outline-none focus:ring-2 focus:ring-[var(--border-accent)]">
                                <h3 class="text-xl font-semibold text-accent mb-2">${page.title}</h3>
                                <p class="text-sm text-secondary mb-1">Autor: ${page.authorName}</p>
                                ${page.lastEditorName && page.lastEditorName !== page.authorName ? `<p class="text-sm text-secondary mb-1">Ostatnia edycja: ${page.lastEditorName}</p>` : ''}
                                ${categoryLinkHTML}
                                <p class="text-xs text-secondary mt-2">Ostatnia aktualizacja: ${new Date(page.updatedAt).toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </a>
                        `;
                        container.innerHTML += pageCard;
                    });
                } else {
                    emptyDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error fetching wiki pages:', error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
        }

        function handleStateChange() {
            fetchAndDisplayWikiPages();
            fetchAndDisplayWikiCategoriesFilterList();
        }

        document.addEventListener('DOMContentLoaded', () => {
            handleStateChange();
        });

        window.addEventListener('popstate', handleStateChange);

    </script>
</body>
</html>
