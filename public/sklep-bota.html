<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Skarbiec Artefaktów Mocy - kupuj unikalne przedmioty i bonusy za Gwiezdne Dukaty i Kryształy Elary.">
    <meta name="keywords" content="sklep, bot, discord, kroniki elary, dukaty, kryształy, przedmioty, bonusy">
    <meta name="author" content="Arcadius & Strażnicy Kronik Elary">
    <title>Skarbiec Artefaktów Mocy - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #111827; 
            --bg-header: rgba(15, 23, 42, 0.92); 
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6;
            --border-card: rgba(167, 139, 250, 0.15); 
            --btn-primary-bg: #8B5CF6;
            --btn-primary-hover-bg: #7C3AED;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #8B5CF6;
            --scrollbar-thumb-hover-bg: #7C3AED;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.15); 
            --shadow-strong-color: rgba(167, 139, 250, 0.3); 
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
            --rgb-purple-400: 167, 139, 250; 
            --rgb-stone-400: 168, 162, 158; 
            --rgb-amber-400: 251, 191, 36; 
            --rgb-cyan-400: 34, 211, 238; 
            --text-purple-400: #A78BFA;
            --text-stone-400: #A8A29E;
            --text-amber-400: #FBBF24;
            --text-cyan-400: #22D3EE;
        }
        html.light {
            --bg-primary: #F9FAFB; 
            --bg-secondary: #F3F4F6; 
            --bg-card: #FFFFFF; 
            --bg-header: rgba(255, 255, 255, 0.95);
            --text-primary: #1F2937; 
            --text-secondary: #4B5563; 
            --text-accent: #7C3AED; 
            --text-accent-hover: #6D28D9; 
            --border-accent: #7C3AED;
            --border-card: rgba(124, 58, 237, 0.1);
            --btn-primary-bg: #7C3AED;
            --btn-primary-hover-bg: #6D28D9;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #A78BFA;
            --scrollbar-thumb-hover-bg: #8B5CF6;
            --svg-icon-fill: #374151;
            --shadow-color: rgba(124, 58, 237, 0.08);
            --shadow-strong-color: rgba(124, 58, 237, 0.15);
            --modal-backdrop: rgba(249, 250, 251, 0.85);
            --rgb-accent: 124, 58, 237;
            --rgb-purple-400: 124, 58, 237;
            --rgb-stone-400: 120, 113, 108;
            --rgb-amber-400: 217, 119, 6;
            --rgb-cyan-400: 8, 145, 178;
            --text-purple-400: #7C3AED;
            --text-stone-400: #78716C;
            --text-amber-400: #D97706;
            --text-cyan-400: #0891B2;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.75; }
        h1, h2, h3, h4, h5 { font-family: 'Lora', serif; font-weight: 600; line-height: 1.35; }
        h1 { letter-spacing: -0.025em; font-weight: 700; } h2 { letter-spacing: -0.02em; font-weight: 700; } h3 { font-weight: 600; }
        .hero-shop-bg { background: linear-gradient(rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.98)), url('https://placehold.co/1920x500/0a0f1e/8B5CF6?text=Skarbiec+Artefaktów') center/cover no-repeat; }
        .section-bg { background-color: var(--bg-secondary); }
        .card-bg { background-color: var(--bg-card); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.3s ease; border: 1px solid var(--border-card); box-shadow: 0 6px 12px -3px var(--shadow-color); overflow: hidden; }
        .card-bg:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 24px -4px var(--shadow-strong-color); }
        .btn-primary, .btn-discord, .btn-secondary { color: #FFFFFF; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 8px -2px var(--shadow-color); font-weight: 600; letter-spacing: 0.03em; padding-top: 0.8rem; padding-bottom: 0.8rem; border-radius: 0.375rem; } 
        .btn-primary { background-color: var(--btn-primary-bg); } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px var(--shadow-strong-color); }
        .btn-discord { background-color: var(--btn-discord-bg); } .btn-discord:hover { background-color: var(--btn-discord-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px rgba(88, 101, 242, 0.35); }
        .btn-secondary { background-color: transparent; border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.8rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: var(--border-accent); color: white; transform: scale(1.04) translateY(-2px); box-shadow: 0 6px 12px -2px var(--shadow-color); }
        .text-accent { color: var(--text-accent); }
        .reveal { opacity: 0; transform: translateY(50px); transition: opacity 0.8s cubic-bezier(0.645, 0.045, 0.355, 1), transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        ::-webkit-scrollbar { width: 12px; } ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 6px; border: 3px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(16px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 10px -3px rgba(15,23,42,0.15); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 4px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1px; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent), 0.1); }
        .nav-link:hover::after, .nav-link.active::after { width: 50%; }
        #mobileMenu { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none; }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        html.dark .text-shadow-custom { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 8px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.375rem; box-shadow: 0 8px 20px -4px var(--shadow-strong-color), 0 6px 8px -5px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: opacity 0.15s ease, transform 0.15s ease, visibility 0s linear 0.15s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.15s ease, transform 0.15s ease; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.7rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.1s ease, color 0.1s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent), 0.08); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; } 
        .modal { background-color: var(--modal-backdrop); backdrop-filter: blur(6px); }
        .modal-content { background-color: var(--bg-card); max-height: 90vh; }
        .shop-item-card { display: flex; flex-direction: column; height: 100%; }
        .shop-item-card .item-icon { font-size: 3rem; line-height: 1; margin-bottom: 0.75rem; }
        .shop-item-card .item-price { font-size: 1.5rem; font-weight: 700; color: var(--text-accent); margin: 0.5rem 0 1rem 0; }
        .loading-spinner { border-color: var(--text-accent) transparent var(--text-accent) transparent; }
    </style>
</head>
<body class="antialiased">

    <header id="navbar" class="fixed top-0 left-0 right-0 z-50 py-3">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold" aria-label="Strona główna Kronik Elary">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <a href="index.html" class="nav-link">Strona Główna</a>
                <a href="prezentacja.html" class="nav-link">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="nav-link">Wikipedia Kronik</a>
                <a href="blog.html" class="nav-link">Blog</a> {/* Dodany link */}
                <a href="ranking-stats.html" class="nav-link">Rankingi</a>
                <a href="dom-aukcyjny.html" class="nav-link">Dom Aukcyjny</a>
                <div id="auth-section-nav" class="ml-4 relative">
                    </div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative">
                    </div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otwórz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona Główna</a>
                <a href="prezentacja.html" class="block py-2.5 px-3 nav-link text-base font-medium">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="block py-2.5 px-3 nav-link text-base font-medium">Wikipedia Kronik</a>
                <a href="blog.html" class="block py-2.5 px-3 nav-link text-base font-medium">Blog</a> {/* Dodany link */}
                <a href="ranking-stats.html" class="block py-2.5 px-3 nav-link text-base font-medium">Rankingi</a>
                <a href="dom-aukcyjny.html" class="block py-2.5 px-3 nav-link text-base font-medium">Dom Aukcyjny</a>
                <a href="https://discord.gg/TWOJLINKZAPROSZENIOWY" target="_blank" rel="noopener noreferrer" class="block mt-2 py-2.5 px-3 text-base font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md text-center">Dołącz do Discorda</a>
                 </div>
        </div>
    </header>

    <main>
        <section class="hero-shop-bg pt-32 pb-16 sm:pt-40 sm:pb-24 text-center reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-white mb-6 leading-tight text-shadow-custom">
                    Skarbiec <span class="text-accent">Artefaktów Mocy</span>
                </h1>
                <p class="text-lg md:text-xl text-slate-200 mb-10 max-w-3xl mx-auto text-shadow-custom">
                    Wymień swoje Gwiezdne Dukaty na potężne artefakty, bonusy XP, unikalne role i inne skarby!
                </p>
            </div>
        </section>

        <section id="wprowadzenie-shop" class="py-16 sm:py-20 section-bg reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <div class="text-center mb-14 sm:mb-18">
                    <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">Wybierz Swój <span class="text-accent">Artefakt</span></h2>
                    <p class="text-lg text-secondary max-w-3xl mx-auto">
                        Przedmioty w Skarbcu są regularnie uzupełniane. Pamiętaj, aby sprawdzać dostępność i korzystać z okazji!
                    </p>
                    <p id="userCurrencyBalance" class="text-xl text-primary mt-4 font-semibold">
                        Twoje Dukaty: Ładowanie... ✨ | Twoje Kryształy: Ładowanie... 💠
                    </p>
                </div>
            </div>
        </section>

        <section id="shop-items" class="py-16 sm:py-20 reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <div id="shopItemsContainer" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <div class="text-center py-10 col-span-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 loading-spinner mx-auto mb-3"></div>
                        <p class="text-secondary text-lg">Ładowanie przedmiotów sklepu...</p>
                    </div>
                </div>
                <div id="shopStatus" class="mt-8 text-center text-lg font-semibold"></div>
            </div>
        </section>
        
    </main>

    <footer class="py-12 text-center" style="background-color: var(--bg-header);">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="flex justify-center space-x-6 mb-6">
                <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Twitter">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.67.9-.53 1.59-1.37 1.92-2.38-.84.5-1.78.86-2.79 1.07C18.28 4.42 17.03 4 15.64 4c-2.94 0-5.32 2.38-5.32 5.32 0 .42.05.83.14 1.22-4.42-.22-8.33-2.34-10.96-5.55-.46.79-.72 1.7-.72 2.67 0 1.84.94 3.47 2.37 4.42-.87-.03-1.69-.27-2.41-.66v.07c0 2.57 1.83 4.72 4.25 5.21-.44.12-.91.18-1.39.18-.34 0-.67-.03-1-.1 0 .67.65 1.37 1.77 1.84-.7.55-1.59.88-2.58.88-.39 0-.77-.02-1.14-.07.91.59 2 1.02 3.19 1.02 3.83 0 5.93-3.18 5.93-5.93 0-.09 0-.18-.01-.27.41-.3.76-.68 1.04-1.09z"/></svg>
                </a>
                 <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Instagram">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.17.053 1.805.248 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.167.422.362 1.056.415 2.227.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.17-.248 1.805-.415 2.227a3.48 3.48 0 01-.896 1.382c-.42.419-.82.679-1.382.896-.422.167-1.056.362-2.227.415-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.17-.053-1.805-.248-2.227-.415a3.492 3.492 0 01-1.381-.896 3.492 3.492 0 01-.896-1.381c-.167-.422-.362-1.056-.415-2.227-.058-1.266-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.17.248-1.805.415-2.227.218-.562.477-.96.896-1.381.419-.42.819-.679 1.381-.896.422-.167 1.056-.362 2.227-.415C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.143 0-3.505.012-4.725.068-1.09.05-1.647.235-1.98.378a1.69 1.69 0 00-.755.755c-.143.333-.328.89-.378 1.98C4.082 8.495 4.07 8.857 4.07 12s.012 3.505.068 4.725c.05 1.09.235 1.647.378 1.98.16.373.397.637.755.755.333.143.89.328 1.98.378 1.22.056 1.582.068 4.725.068s3.505-.012 4.725-.068c1.09-.05 1.647.235 1.98-.378.373-.16.637-.397.755-.755.143-.333.328.89.378-1.98.056-1.22.068-1.582.068-4.725s-.012-3.505-.068-4.725c-.05-1.09-.235-1.647-.378-1.98a1.69 1.69 0 00-.755-.755c-.333-.143-.89-.328-1.98-.378C15.505 3.977 15.143 3.965 12 3.965zm0 3.273a4.762 4.762 0 100 9.524 4.762 4.762 0 000-9.524zm0 7.722a3.06 3.06 0 110-6.12 3.06 3.06 0 010 6.12zm4.758-7.868a1.128 1.128 0 100-2.255 1.128 1.128 0 000 2.255z"/></svg>
                </a>
                 <a href="polityka-prywatnosci.html" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Polityka Prywatności">
                    Polityka Prywatności
                </a>
            </div>
            <p class="text-secondary text-sm">
                &copy; <span id="currentYear">2024</span> Kroniki Elary. Wszelkie prawa zastrzeżone.
            </p>
            <p class="text-xs mt-2.5" style="color: var(--text-secondary-light, #94A3B8);">
                Stworzone z pasji do anime i mangi przez Arcadiusa i jego Strażników.
            </p>
        </div>
    </footer>

    <div id="confirmationModal" class="fixed inset-0 z-[70] items-center justify-center hidden p-4 modal">
        <div class="modal-content w-full max-w-md p-6 rounded-lg shadow-xl reveal">
            <h3 class="text-xl font-semibold text-primary mb-4" id="modalTitle">Potwierdzenie Zakupu</h3>
            <p class="text-secondary mb-6" id="modalMessage">Czy na pewno chcesz zakupić ten przedmiot?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelButton" class="btn-secondary py-2 px-4 text-sm">Anuluj</button>
                <button id="confirmButton" class="btn-primary py-2 px-4 text-sm">Potwierdź Zakup</button>
            </div>
        </div>
    </div>


    <script src="js/main.js" defer></script>
    <script>
        // Skrypt specyficzny dla sklep-bota.html
        document.addEventListener('DOMContentLoaded', function() {
            // Common scripts are initialized by main.js
            // Specific logic for sklep-bota.html:
            const container = document.getElementById('shopItemsContainer');
            const statusDiv = document.getElementById('shopStatus');
            const balanceElement = document.getElementById('userCurrencyBalance'); // Element do wyświetlania salda

            async function loadShopItems() {
                if (!container || !statusDiv) return;
                container.innerHTML = `
                    <div class="text-center py-10 col-span-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 loading-spinner mx-auto mb-3" style="border-color: var(--text-accent) transparent var(--text-accent) transparent;"></div>
                        <p class="text-secondary text-lg">Ładowanie przedmiotów sklepu...</p>
                    </div>`;
                statusDiv.innerHTML = '';

                try {
                    const response = await fetch('/api/web/shop/items');
                    if (!response.ok) throw new Error(`Błąd HTTP: ${response.status}`);
                    const itemsData = await response.json();
                    
                    const items = itemsData.success ? itemsData.items : []; // Dostosuj do struktury odpowiedzi API

                    if (items && items.length > 0) {
                        container.innerHTML = items.map((item, index) => {
                            const costDukaty = item.cost_dukaty !== null ? `${item.cost_dukaty.toLocaleString('pl-PL')} ✨` : '';
                            const costKrysztaly = item.cost_krysztaly !== null ? `${item.cost_krysztaly.toLocaleString('pl-PL')} 💠` : '';
                            const priceString = [costDukaty, costKrysztaly].filter(Boolean).join(' lub ');
                            const stockInfo = item.stock === -1 ? 'Nieskończony' : `Dostępnych: ${item.stock}`;

                            return `
                                <div class="shop-item-card card-bg p-6 rounded-lg text-center flex flex-col items-center reveal" style="transition-delay: ${index * 0.05}s;">
                                    <div class="item-icon text-5xl mb-3">${item.emoji || '🛍️'}</div>
                                    <h3 class="text-xl font-semibold text-primary mb-2">${item.name}</h3>
                                    <p class="text-secondary text-sm mb-3 flex-grow">${item.description}</p>
                                    <p class="item-price text-2xl font-bold text-accent my-2">${priceString}</p>
                                    <p class="text-sm text-secondary mb-4">${stockInfo}</p>
                                    <button class="btn-primary w-full purchase-button mt-auto"
                                        data-item-id="${item.id}"
                                        data-item-name="${item.name}"
                                        data-cost-dukaty="${item.cost_dukaty}"
                                        data-cost-krysztaly="${item.cost_krysztaly}"
                                        ${item.stock === 0 ? 'disabled' : ''}>
                                        ${item.stock === 0 ? 'Wyprzedane' : 'Kup Teraz'}
                                    </button>
                                </div>
                            `;
                        }).join('');

                        document.querySelectorAll('.purchase-button').forEach(button => {
                            button.addEventListener('click', async function() {
                                const itemId = this.dataset.itemId;
                                const itemName = this.dataset.itemName;
                                const costDukaty = this.dataset.costDukaty !== 'null' ? parseInt(this.dataset.costDukaty) : null;
                                const costKrysztaly = this.dataset.costKrysztaly !== 'null' ? parseInt(this.dataset.costKrysztaly) : null;
                                let currencyToUse = 'dukaty'; // Domyślnie dukaty dla tego sklepu

                                if (costDukaty === null && costKrysztaly !== null) {
                                    currencyToUse = 'krysztaly'; // Jeśli tylko krysztaly są opcją
                                } else if (costDukaty !== null && costKrysztaly !== null) {
                                     // Jeśli obie waluty są dostępne, daj wybór (prosty confirm)
                                    if (!confirm(`Przedmiot "${itemName}" można kupić za Dukaty lub Kryształy. Czy chcesz użyć Dukatów? (Anuluj dla Kryształów)`)) {
                                        currencyToUse = 'krysztaly';
                                    }
                                } else if (costDukaty === null && costKrysztaly === null) {
                                     alert('Błąd: Przedmiot nie ma zdefiniowanej ceny.'); return;
                                }

                                const price = currencyToUse === 'dukaty' ? costDukaty : costKrysztaly;
                                const currencySymbol = currencyToUse === 'dukaty' ? '✨' : '💠';

                                if (!confirm(`Czy na pewno chcesz zakupić "${itemName}" za ${price.toLocaleString('pl-PL')} ${currencySymbol}?`)) {
                                    statusDiv.innerHTML = '<p class="text-secondary">Zakup anulowany.</p>';
                                    return;
                                }

                                statusDiv.innerHTML = '<p class="text-secondary">Przetwarzanie zakupu...</p>';
                                try {
                                    const purchaseResponse = await fetch(`/api/web/shop/buy/${itemId}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ currency_type: currencyToUse })
                                    });
                                    const result = await purchaseResponse.json();
                                    if (purchaseResponse.ok && result.message) {
                                        statusDiv.innerHTML = `<p class="text-green-400">${result.message}</p>`;
                                        loadShopItems();
                                        loadUserCurrencyBalance();
                                    } else {
                                        statusDiv.innerHTML = `<p class="text-red-400">${result.error || 'Wystąpił błąd podczas zakupu.'}</p>`;
                                    }
                                } catch (err) {
                                    console.error('Błąd zakupu:', err);
                                    statusDiv.innerHTML = `<p class="text-red-400">Wystąpił błąd sieciowy podczas zakupu.</p>`;
                                }
                            });
                        });
                        // Re-run reveal animations for newly added items
                        document.querySelectorAll('#shopItemsContainer .reveal').forEach(el => {
                            el.classList.remove('visible');
                            setTimeout(() => el.classList.add('visible'), 10);
                        });

                    } else {
                        container.innerHTML = '<p class="text-center text-secondary col-span-full py-10">Skarbiec jest obecnie pusty. Runa pracuje nad nowymi magicznymi przedmiotami!</p>';
                    }
                } catch (error) {
                    console.error('Błąd ładowania przedmiotów sklepu:', error);
                    container.innerHTML = `<p class="text-center text-red-400 col-span-full py-10">Wystąpił błąd podczas ładowania przedmiotów. Spróbuj odświeżyć stronę.</p>`;
                }
            }

            async function loadUserCurrencyBalance(discordUserId = null) {
                if (!balanceElement) return;

                if (!discordUserId) { // Jeśli ID nie jest podane, spróbuj pobrać zalogowanego użytkownika
                    try {
                        const userResponse = await fetch('/api/me');
                        if (userResponse.ok) {
                            const user = await userResponse.json();
                            if (user && user.id) discordUserId = user.id;
                        } else {
                             balanceElement.innerHTML = 'Dukaty: <a href="/auth/discord/login" class="text-accent underline">Zaloguj się</a> | Kryształy: <a href="/auth/discord/login" class="text-accent underline">Zaloguj się</a>';
                            return;
                        }
                    } catch (error) {
                        console.error('Błąd pobierania danych użytkownika dla salda:', error);
                        balanceElement.textContent = 'Dukaty: Błąd | Kryształy: Błąd';
                        return;
                    }
                }
                 if (!discordUserId) { // Jeśli nadal brak ID użytkownika (np. nie jest zalogowany)
                    balanceElement.innerHTML = 'Dukaty: <a href="/auth/discord/login" class="text-accent underline">Zaloguj się</a> | Kryształy: <a href="/auth/discord/login" class="text-accent underline">Zaloguj się</a>';
                    return;
                }


                try {
                    const statsResponse = await fetch(`/api/bot-stats/${discordUserId}`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        if (statsData.success && statsData.data) {
                            const stats = statsData.data;
                            balanceElement.innerHTML = `Twoje Dukaty: ${stats.balance_dukaty !== undefined ? stats.balance_dukaty.toLocaleString('pl-PL') : 'B/D'} ✨ | Twoje Kryształy: ${stats.balance_krysztaly !== undefined ? stats.balance_krysztaly.toLocaleString('pl-PL') : 'B/D'} 💠`;
                        } else {
                             balanceElement.textContent = `Dukaty: ${statsData.error || 'Błąd'} | Kryształy: ${statsData.error || 'Błąd'}`;
                        }
                    } else {
                        balanceElement.textContent = 'Dukaty: Nie udało się załadować | Kryształy: Nie udało się załadować';
                    }
                } catch (error) {
                    console.error('Błąd ładowania salda walut:', error);
                    balanceElement.textContent = 'Dukaty: Błąd sieci | Kryształy: Błąd sieci';
                }
            }
            
            // Inicjalizacja po załadowaniu DOM i main.js
             // updateAuthDisplay w main.js wywoła loadUserCurrencyBalance po ustaleniu użytkownika
            loadShopItems();
        });
    </script>
</body>
</html>
