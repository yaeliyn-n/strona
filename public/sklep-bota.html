<!DOCTYPE html>
<html lang="pl" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Skarbiec Artefakt√≥w Mocy - kupuj unikalne przedmioty i bonusy za Gwiezdne Dukaty i Kryszta≈Çy Elary.">
    <meta name="keywords" content="sklep, bot, discord, kroniki elary, dukaty, kryszta≈Çy, przedmioty, bonusy">
    <meta name="author" content="Arcadius & Stra≈ºnicy Kronik Elary">
    <title>Skarbiec Artefakt√≥w Mocy - Kroniki Elary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0F172A; 
            --bg-secondary: #1E293B; 
            --bg-card: #111827; 
            --bg-header: rgba(15, 23, 42, 0.92); 
            --text-primary: #E2E8F0; 
            --text-secondary: #94A3B8; 
            --text-accent: #A78BFA; 
            --text-accent-hover: #8B5CF6; 
            --border-accent: #8B5CF6;
            --border-card: rgba(167, 139, 250, 0.15); 
            --btn-primary-bg: #8B5CF6;
            --btn-primary-hover-bg: #7C3AED;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #8B5CF6;
            --scrollbar-thumb-hover-bg: #7C3AED;
            --svg-icon-fill: #E2E8F0;
            --shadow-color: rgba(167, 139, 250, 0.15); 
            --shadow-strong-color: rgba(167, 139, 250, 0.3); 
            --modal-backdrop: rgba(15, 23, 42, 0.85);
            --rgb-accent: 167, 139, 250;
            --rgb-purple-400: 167, 139, 250; 
            --rgb-stone-400: 168, 162, 158; 
            --rgb-amber-400: 251, 191, 36; 
            --rgb-cyan-400: 34, 211, 238; 
            --text-purple-400: #A78BFA;
            --text-stone-400: #A8A29E;
            --text-amber-400: #FBBF24;
            --text-cyan-400: #22D3EE;
        }
        html.light {
            --bg-primary: #F9FAFB; 
            --bg-secondary: #F3F4F6; 
            --bg-card: #FFFFFF; 
            --bg-header: rgba(255, 255, 255, 0.95);
            --text-primary: #1F2937; 
            --text-secondary: #4B5563; 
            --text-accent: #7C3AED; 
            --text-accent-hover: #6D28D9; 
            --border-accent: #7C3AED;
            --border-card: rgba(124, 58, 237, 0.1);
            --btn-primary-bg: #7C3AED;
            --btn-primary-hover-bg: #6D28D9;
            --btn-discord-bg: #5865F2;
            --btn-discord-hover-bg: #4752C4;
            --scrollbar-thumb-bg: #A78BFA;
            --scrollbar-thumb-hover-bg: #8B5CF6;
            --svg-icon-fill: #374151;
            --shadow-color: rgba(124, 58, 237, 0.08);
            --shadow-strong-color: rgba(124, 58, 237, 0.15);
            --modal-backdrop: rgba(249, 250, 251, 0.85);
            --rgb-accent: 124, 58, 237;
            --rgb-purple-400: 124, 58, 237;
            --rgb-stone-400: 120, 113, 108;
            --rgb-amber-400: 217, 119, 6;
            --rgb-cyan-400: 8, 145, 178;
            --text-purple-400: #7C3AED;
            --text-stone-400: #78716C;
            --text-amber-400: #D97706;
            --text-cyan-400: #0891B2;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.75; }
        h1, h2, h3, h4, h5 { font-family: 'Lora', serif; font-weight: 600; line-height: 1.35; }
        h1 { letter-spacing: -0.025em; font-weight: 700; } h2 { letter-spacing: -0.02em; font-weight: 700; } h3 { font-weight: 600; }
        .hero-shop-bg { background: linear-gradient(rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.98)), url('https://placehold.co/1920x500/0a0f1e/8B5CF6?text=Skarbiec+Artefakt√≥w') center/cover no-repeat; }
        .section-bg { background-color: var(--bg-secondary); }
        .card-bg { background-color: var(--bg-card); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.3s ease; border: 1px solid var(--border-card); box-shadow: 0 6px 12px -3px var(--shadow-color); overflow: hidden; }
        .card-bg:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 24px -4px var(--shadow-strong-color); }
        .btn-primary, .btn-discord, .btn-secondary { color: #FFFFFF; transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 8px -2px var(--shadow-color); font-weight: 600; letter-spacing: 0.03em; padding-top: 0.8rem; padding-bottom: 0.8rem; border-radius: 0.375rem; } 
        .btn-primary { background-color: var(--btn-primary-bg); } .btn-primary:hover { background-color: var(--btn-primary-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px var(--shadow-strong-color); }
        .btn-discord { background-color: var(--btn-discord-bg); } .btn-discord:hover { background-color: var(--btn-discord-hover-bg); transform: scale(1.04) translateY(-2px); box-shadow: 0 10px 18px -4px rgba(88, 101, 242, 0.35); }
        .btn-secondary { background-color: transparent; border: 2px solid var(--border-accent); color: var(--text-accent); padding: calc(0.8rem - 2px) calc(1.5rem - 2px); }
        .btn-secondary:hover { background-color: var(--border-accent); color: white; transform: scale(1.04) translateY(-2px); box-shadow: 0 6px 12px -2px var(--shadow-color); }
        .text-accent { color: var(--text-accent); }
        .reveal { opacity: 0; transform: translateY(50px); transition: opacity 0.8s cubic-bezier(0.645, 0.045, 0.355, 1), transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        ::-webkit-scrollbar { width: 12px; } ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 6px; border: 3px solid var(--bg-primary); }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }
        header#navbar { background-color: var(--bg-header); backdrop-filter: blur(16px); transition: background-color 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 10px -3px rgba(15,23,42,0.15); }
        .nav-link { position: relative; color: var(--text-secondary); transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease; padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; }
        .nav-link:hover { transform: translateY(-1px); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 4px; left: 50%; transform: translateX(-50%); background-color: var(--text-accent); transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-radius: 1px; }
        .nav-link:hover, .nav-link.active { color: var(--text-accent); background-color: rgba(var(--rgb-accent), 0.1); }
        .nav-link:hover::after, .nav-link.active::after { width: 50%; }
        #mobileMenu { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(-100%); opacity: 0; pointer-events: none; }
        #mobileMenu.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        html.dark .text-shadow-custom { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border-accent); cursor: pointer; transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 8px var(--shadow-strong-color); }
        .dropdown-menu { position: absolute; top: calc(100% + 0.5rem); right: 0; background-color: var(--bg-card); border: 1px solid var(--border-card); border-radius: 0.375rem; box-shadow: 0 8px 20px -4px var(--shadow-strong-color), 0 6px 8px -5px var(--shadow-color); z-index: 50; min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-8px); transition: opacity 0.15s ease, transform 0.15s ease, visibility 0s linear 0.15s; }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.15s ease, transform 0.15s ease; }
        .dropdown-menu a, .dropdown-menu button { display: block; width: 100%; text-align: left; padding: 0.7rem 1rem; font-size: 0.875rem; color: var(--text-secondary); transition: background-color 0.1s ease, color 0.1s ease; }
        .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: rgba(var(--rgb-accent), 0.08); color: var(--text-accent); }
        .dropdown-menu form { margin: 0; } 
        .modal { background-color: var(--modal-backdrop); backdrop-filter: blur(6px); }
        .modal-content { background-color: var(--bg-card); max-height: 90vh; }
        .shop-item-card { display: flex; flex-direction: column; height: 100%; }
        .shop-item-card .item-icon { font-size: 3rem; line-height: 1; margin-bottom: 0.75rem; }
        .shop-item-card .item-price { font-size: 1.5rem; font-weight: 700; color: var(--text-accent); margin: 0.5rem 0 1rem 0; }
        .loading-spinner { border-color: var(--text-accent) transparent var(--text-accent) transparent; }
    </style>
</head>
<body class="antialiased">

    <header id="navbar" class="fixed top-0 left-0 right-0 z-50 py-3">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-bold" aria-label="Strona g≈Ç√≥wna Kronik Elary">
                <span class="text-accent">Kroniki</span> <span class="text-primary">Elary</span>
            </a>
            <nav class="hidden md:flex items-center space-x-1 lg:space-x-2">
                <a href="index.html" class="nav-link">Strona G≈Ç√≥wna</a>
                <a href="prezentacja.html" class="nav-link">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="nav-link">Wikipedia Kronik</a> 
                <a href="ranking-stats.html" class="nav-link">Rankingi</a>
                <div id="auth-section-nav" class="ml-4 relative">
                    </div>
            </nav>
            <div class="md:hidden flex items-center">
                 <div id="auth-section-mobile-nav" class="mr-2 relative">
                    </div>
                <button id="mobileMenuButton" class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-header)] focus:ring-[var(--text-accent)]" aria-expanded="false" aria-controls="mobileMenu" aria-label="Otw√≥rz menu nawigacyjne">
                    <svg class="w-6 h-6" fill="none" stroke="var(--svg-icon-fill)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                </button>
            </div>
        </div>
        <div id="mobileMenu" class="absolute top-full left-0 right-0 md:hidden shadow-lg" style="background-color: var(--bg-header);">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="block py-2.5 px-3 nav-link text-base font-medium">Strona G≈Ç√≥wna</a>
                <a href="prezentacja.html" class="block py-2.5 px-3 nav-link text-base font-medium">Prezentacja Serwera</a>
                <a href="wikipedia.html" class="block py-2.5 px-3 nav-link text-base font-medium">Wikipedia Kronik</a>
                <a href="ranking-stats.html" class="block py-2.5 px-3 nav-link text-base font-medium">Rankingi</a>
                <a href="https://discord.gg/TWOJLINKZAPROSZENIOWY" target="_blank" rel="noopener noreferrer" class="block mt-2 py-2.5 px-3 text-base font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-md text-center">Do≈ÇƒÖcz do Discorda</a>
                 </div>
        </div>
    </header>

    <main>
        <section class="hero-shop-bg pt-32 pb-16 sm:pt-40 sm:pb-24 text-center reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-white mb-6 leading-tight text-shadow-custom">
                    Skarbiec <span class="text-accent">Artefakt√≥w Mocy</span>
                </h1>
                <p class="text-lg md:text-xl text-slate-200 mb-10 max-w-3xl mx-auto text-shadow-custom">
                    Wymie≈Ñ swoje Gwiezdne Dukaty na potƒô≈ºne artefakty, bonusy XP, unikalne role i inne skarby!
                </p>
            </div>
        </section>

        <section id="wprowadzenie-shop" class="py-16 sm:py-20 section-bg reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <div class="text-center mb-14 sm:mb-18">
                    <h2 class="text-3xl sm:text-4xl font-bold text-primary mb-4">Wybierz Sw√≥j <span class="text-accent">Artefakt</span></h2>
                    <p class="text-lg text-secondary max-w-3xl mx-auto">
                        Przedmioty w Skarbcu sƒÖ regularnie uzupe≈Çniane. Pamiƒôtaj, aby sprawdzaƒá dostƒôpno≈õƒá i korzystaƒá z okazji!
                    </p>
                    <p id="userCurrencyBalance" class="text-xl text-primary mt-4 font-semibold">
                        Twoje Dukaty: ≈Åadowanie... ‚ú® | Twoje Kryszta≈Çy: ≈Åadowanie... üí†
                    </p>
                </div>
            </div>
        </section>

        <section id="shop-items" class="py-16 sm:py-20 reveal">
            <div class="container mx-auto px-4 sm:px-6">
                <div id="shopItemsContainer" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <div class="text-center py-10 col-span-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 loading-spinner mx-auto mb-3"></div>
                        <p class="text-secondary text-lg">≈Åadowanie przedmiot√≥w sklepu...</p>
                    </div>
                </div>
                <div id="shopStatus" class="mt-8 text-center text-lg font-semibold"></div>
            </div>
        </section>
        
    </main>

    <footer class="py-12 text-center" style="background-color: var(--bg-header);">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="flex justify-center space-x-6 mb-6">
                <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Twitter">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.67.9-.53 1.59-1.37 1.92-2.38-.84.5-1.78.86-2.79 1.07C18.28 4.42 17.03 4 15.64 4c-2.94 0-5.32 2.38-5.32 5.32 0 .42.05.83.14 1.22-4.42-.22-8.33-2.34-10.96-5.55-.46.79-.72 1.7-.72 2.67 0 1.84.94 3.47 2.37 4.42-.87-.03-1.69-.27-2.41-.66v.07c0 2.57 1.83 4.72 4.25 5.21-.44.12-.91.18-1.39.18-.34 0-.67-.03-1-.1 0 .67.65 1.37 1.77 1.84-.7.55-1.59.88-2.58.88-.39 0-.77-.02-1.14-.07.91.59 2 1.02 3.19 1.02 3.83 0 5.93-3.18 5.93-5.93 0-.09 0-.18-.01-.27.41-.3.76-.68 1.04-1.09z"/></svg>
                </a>
                 <a href="#" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Placeholder Instagram">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.17.053 1.805.248 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.167.422.362 1.056.415 2.227.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.053 1.17-.248 1.805-.415 2.227a3.48 3.48 0 01-.896 1.382c-.42.419-.82.679-1.382.896-.422.167-1.056.362-2.227.415-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.17-.053-1.805-.248-2.227-.415a3.492 3.492 0 01-1.381-.896 3.492 3.492 0 01-.896-1.381c-.167-.422-.362-1.056-.415-2.227-.058-1.266-.07-1.646-.07-4.85s.012-3.584.07-4.85c.053-1.17.248-1.805.415-2.227.218-.562.477-.96.896-1.381.419-.42.819-.679 1.381-.896.422-.167 1.056-.362 2.227-.415C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.143 0-3.505.012-4.725.068-1.09.05-1.647.235-1.98.378a1.69 1.69 0 00-.755.755c-.143.333-.328.89-.378 1.98C4.082 8.495 4.07 8.857 4.07 12s.012 3.505.068 4.725c.05 1.09.235 1.647.378 1.98.16.373.397.637.755.755.333.143.89.328 1.98.378 1.22.056 1.582.068 4.725.068s3.505-.012 4.725-.068c1.09-.05 1.647.235 1.98-.378.373-.16.637-.397.755-.755.143-.333.328.89.378-1.98.056-1.22.068-1.582.068-4.725s-.012-3.505-.068-4.725c-.05-1.09-.235-1.647-.378-1.98a1.69 1.69 0 00-.755-.755c-.333-.143-.89-.328-1.98-.378C15.505 3.977 15.143 3.965 12 3.965zm0 3.273a4.762 4.762 0 100 9.524 4.762 4.762 0 000-9.524zm0 7.722a3.06 3.06 0 110-6.12 3.06 3.06 0 010 6.12zm4.758-7.868a1.128 1.128 0 100-2.255 1.128 1.128 0 000 2.255z"/></svg>
                </a>
                 <a href="polityka-prywatnosci.html" class="text-secondary hover:text-accent transition-colors duration-200" aria-label="Polityka Prywatno≈õci">
                    Polityka Prywatno≈õci
                </a>
            </div>
            <p class="text-secondary text-sm">
                &copy; <span id="currentYear">2024</span> Kroniki Elary. Wszelkie prawa zastrze≈ºone.
            </p>
            <p class="text-xs mt-2.5" style="color: var(--text-secondary-light, #94A3B8);">
                Stworzone z pasji do anime i mangi przez Arcadiusa i jego Stra≈ºnik√≥w.
            </p>
        </div>
    </footer>

    <div id="confirmationModal" class="fixed inset-0 z-[70] items-center justify-center hidden p-4 modal">
        <div class="modal-content w-full max-w-md p-6 rounded-lg shadow-xl reveal">
            <h3 class="text-xl font-semibold text-primary mb-4" id="modalTitle">Potwierdzenie Zakupu</h3>
            <p class="text-secondary mb-6" id="modalMessage">Czy na pewno chcesz zakupiƒá ten przedmiot?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelButton" class="btn-secondary py-2 px-4 text-sm">Anuluj</button>
                <button id="confirmButton" class="btn-primary py-2 px-4 text-sm">Potwierd≈∫ Zakup</button>
            </div>
        </div>
    </div>


    <script>
        // Funkcja do obs≈Çugi aktywnego linku w nawigacji
        function setActiveNavLink() {
            const currentPage = window.location.pathname.split("/").pop() || "index.html";
            const navLinks = document.querySelectorAll('header nav > a.nav-link, #mobileMenu > div > a.nav-link');
            const wikipediaSubPages = ["lore-postaci.html", "systemy-botow.html", "rangi-i-role.html", "lore-aethelgard.html", "komendy.html"];

            navLinks.forEach(link => {
                link.classList.remove('active');
                const linkPage = link.getAttribute('href').split("/").pop() || "index.html";
                
                if (linkPage === currentPage) {
                    link.classList.add('active');
                } else if (linkPage === 'wikipedia.html' && wikipediaSubPages.includes(currentPage)) {
                    link.classList.add('active');
                }
            });
        }

        async function updateAuthDisplay() {
            const authSectionNav = document.getElementById('auth-section-nav');
            const authSectionMobileNav = document.getElementById('auth-section-mobile-nav');
            const mobileMenuLinksContainer = document.querySelector('#mobileMenu > div'); 
            const ADMIN_DISCORD_ID = "1238814802357387285"; // TODO: ZASTƒÑP RZECZYWISTYM ID ADMINA

            function createLoginButton(isMobile = false) {
                const loginButton = document.createElement('a');
                loginButton.href = '/auth/discord/login?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); 
                loginButton.id = isMobile ? 'discordLoginButtonMobileNav' : 'discordLoginButtonNav';
                loginButton.className = 'btn-discord !text-white px-4 py-2.5 rounded-md text-sm flex items-center' + (isMobile ? ' w-full justify-center mt-2' : '');
                loginButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg> Zaloguj przez Discord`;
                return loginButton;
            }

            function createAvatarDropdown(user, isMobile = false) {
                const containerId = isMobile ? 'userDropdownContainerMobile' : 'userDropdownContainerNav';
                const dropdownId = isMobile ? 'userDropdownMobile' : 'userDropdownNav';

                const container = document.createElement('div');
                container.id = containerId;
                container.className = 'relative';

                const avatarImg = document.createElement('img');
                avatarImg.src = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png?size=32` : 'https://placehold.co/32x32/A78BFA/FFFFFF?text=U';
                avatarImg.alt = 'Awatar u≈ºytkownika';
                avatarImg.className = 'user-avatar';
                avatarImg.onerror = () => { avatarImg.src = 'https://placehold.co/32x32/A78BFA/FFFFFF?text=U'; };
                avatarImg.onclick = (event) => {
                    event.stopPropagation(); 
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) dropdown.classList.toggle('open');
                };
                container.appendChild(avatarImg);

                const dropdownMenu = document.createElement('div');
                dropdownMenu.id = dropdownId;
                dropdownMenu.className = 'dropdown-menu';
                
                const profileLink = document.createElement('a');
                profileLink.href = 'profil.html';
                profileLink.textContent = 'M√≥j Profil';
                dropdownMenu.appendChild(profileLink);

                const botShopLink = document.createElement('a');
                botShopLink.href = '/sklep-bota'; 
                botShopLink.textContent = 'Sklep Bota (Dukaty)';
                dropdownMenu.appendChild(botShopLink);
                
                const premiumShopLink = document.createElement('a');
                premiumShopLink.href = 'sklep-premium.html';
                premiumShopLink.textContent = 'Sklep Premium (Kryszta≈Çy)';
                dropdownMenu.appendChild(premiumShopLink);

                const supportTicketsLink = document.createElement('a');
                supportTicketsLink.href = 'support.html'; 
                supportTicketsLink.textContent = 'Centrum Wsparcia';
                dropdownMenu.appendChild(supportTicketsLink);

                if (user.id === ADMIN_DISCORD_ID) {
                    const adminLinkElement = document.createElement('a'); 
                    adminLinkElement.href = 'admin.html'; 
                    adminLinkElement.textContent = 'Panel Admina';
                    dropdownMenu.appendChild(adminLinkElement);
                }
                
                const logoutForm = document.createElement('form');
                logoutForm.action = '/auth/logout'; 
                logoutForm.method = 'POST';
                const logoutButton = document.createElement('button');
                logoutButton.type = 'submit';
                logoutButton.textContent = 'Wyloguj';
                logoutForm.appendChild(logoutButton);
                dropdownMenu.appendChild(logoutForm);

                container.appendChild(dropdownMenu);
                return container;
            }
            
            if (mobileMenuLinksContainer) {
                const existingMobileAuthElements = mobileMenuLinksContainer.querySelectorAll('#discordLoginButtonMobileNav, #userDropdownContainerMobileMenu, .mobile-auth-item');
                existingMobileAuthElements.forEach(el => el.remove());
            }

            try {
                const response = await fetch('/api/me'); 
                if (response.ok) {
                    const user = await response.json();
                    if (authSectionNav) {
                        authSectionNav.innerHTML = ''; 
                        authSectionNav.appendChild(createAvatarDropdown(user, false));
                    }
                    if (authSectionMobileNav) { 
                        authSectionMobileNav.innerHTML = ''; 
                        authSectionMobileNav.appendChild(createAvatarDropdown(user, true));
                    }
                     if (mobileMenuLinksContainer) {
                        const mobileDropdownContainer = createAvatarDropdown(user, true); 
                        mobileDropdownContainer.id = 'userDropdownContainerMobileMenu';
                        mobileDropdownContainer.classList.add('mt-2', 'border-t', 'border-[var(--border-card)]', 'pt-2', 'mobile-auth-item');
                        
                        const mobileAvatar = mobileDropdownContainer.querySelector('.user-avatar');
                        const mobileDropdown = mobileDropdownContainer.querySelector('.dropdown-menu');
                        
                        if (mobileAvatar) mobileAvatar.classList.add('hidden'); 
                        if (mobileDropdown) {
                            mobileDropdown.classList.remove('absolute', 'top-full', 'right-0', 'dropdown-menu'); 
                            mobileDropdown.classList.add('space-y-1');
                            Array.from(mobileDropdown.children).forEach(child => {
                                child.classList.add('block', 'py-2', 'px-3', 'text-base', 'font-medium', 'rounded-md', 'hover:bg-[rgba(var(--rgb-accent),0.1)]', 'hover:text-[var(--text-accent)]');
                                mobileMenuLinksContainer.appendChild(child);
                            });
                        }
                    }
                     // Po pomy≈õlnym za≈Çadowaniu danych u≈ºytkownika, za≈Çaduj jego saldo
                    if (user && user.id) {
                        loadUserCurrencyBalance(user.id);
                    }

                } else {
                     if (authSectionNav) {
                        authSectionNav.innerHTML = '';
                        authSectionNav.appendChild(createLoginButton(false));
                    }
                    if (authSectionMobileNav) { 
                        authSectionMobileNav.innerHTML = '';
                        authSectionMobileNav.appendChild(createLoginButton(true)); 
                    }
                    if (mobileMenuLinksContainer) {
                        const mobileLoginButton = createLoginButton(true); 
                        mobileLoginButton.classList.add('mt-2', 'border-t', 'border-[var(--border-card)]', 'pt-2', 'mobile-auth-item');
                        mobileMenuLinksContainer.appendChild(mobileLoginButton);
                    }
                    // Je≈õli u≈ºytkownik nie jest zalogowany, wy≈õwietl komunikat
                    document.getElementById('shopItemsContainer').innerHTML = `
                        <div class="text-center py-10 col-span-full card-bg p-8 rounded-lg">
                            <h2 class="text-2xl font-semibold text-primary mb-4">Dostƒôp Wymaga Logowania</h2>
                            <p class="text-secondary mb-6">Aby przeglƒÖdaƒá Skarbiec Artefakt√≥w, musisz byƒá zalogowany.</p>
                            <a href="/auth/discord/login?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}" class="btn-discord inline-flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M20.297 0H3.703C1.658 0 0 1.658 0 3.703V20.297C0 22.342 1.658 24 3.703 24H20.297C22.342 24 24 22.342 24 20.297V3.703C24 1.658 22.342 0 20.297 0ZM8.107 15.232C7.089 15.232 6.241 14.384 6.241 13.366C6.241 12.348 7.089 11.5 8.107 11.5C9.125 11.5 9.973 12.348 9.973 13.366C9.973 14.384 9.125 15.232 8.107 15.232ZM12.000 11.071C10.982 11.071 10.134 10.223 10.134 9.205C10.134 8.188 10.982 7.339 12.000 7.339C13.018 7.339 13.866 8.188 13.866 9.205C13.866 10.223 13.018 11.071 12.000 11.071ZM15.893 15.232C14.875 15.232 14.027 14.384 14.027 13.366C14.027 12.348 14.875 11.5 15.893 11.5C16.911 11.5 17.759 12.348 17.759 13.366C17.759 14.384 16.911 15.232 15.893 15.232Z"/></svg>
                                Zaloguj siƒô przez Discord
                            </a>
                        </div>`;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd aktualizacji UI logowania:', error);
                 if (authSectionNav) {
                    authSectionNav.innerHTML = '';
                    authSectionNav.appendChild(createLoginButton(false));
                }
                if (authSectionMobileNav) {
                    authSectionMobileNav.innerHTML = '';
                    authSectionMobileNav.appendChild(createLoginButton(true));
                }
                if (mobileMenuLinksContainer) {
                    const mobileLoginButton = createLoginButton(true);
                    mobileLoginButton.classList.add('mt-2', 'border-t', 'border-[var(--border-card)]', 'pt-2', 'mobile-auth-item');
                    mobileMenuLinksContainer.appendChild(mobileLoginButton);
                }
                document.getElementById('shopItemsContainer').innerHTML = `<p class="text-center text-red-400 col-span-full py-10">WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania sklepu. Spr√≥buj od≈õwie≈ºyƒá stronƒô.</p>`;
            }
        }
        
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true' || false;
                    mobileMenuButton.setAttribute('aria-expanded', String(!isExpanded));
                    mobileMenu.classList.toggle('open');
                });
                mobileMenu.querySelectorAll('a').forEach(link => { 
                    link.addEventListener('click', () => {
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                        mobileMenu.classList.remove('open');
                    });
                });
            }
        }

        function setupRevealAnimations() {
            const revealObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.reveal').forEach(el => {
                revealObserver.observe(el);
            });
        }

        function setupDropdownDismiss() {
            window.addEventListener('click', function(e) {
                const desktopDropdownContainer = document.getElementById('userDropdownContainerNav');
                const mobileDropdownContainer = document.getElementById('userDropdownContainerMobile'); 
                const desktopDropdown = document.getElementById('userDropdownNav');
                const mobileDropdown = document.getElementById('userDropdownMobile'); 

                if (desktopDropdownContainer && !desktopDropdownContainer.contains(e.target) && desktopDropdown && desktopDropdown.classList.contains('open')) {
                    desktopDropdown.classList.remove('open');
                }
                if (mobileDropdownContainer && !mobileDropdownContainer.contains(e.target) && mobileDropdown && mobileDropdown.classList.contains('open')) {
                     mobileDropdown.classList.remove('open');
                }
            });
        }

        async function loadShopItems() {
            const container = document.getElementById('shopItemsContainer');
            const statusDiv = document.getElementById('shopStatus');
            container.innerHTML = `
                <div class="text-center py-10 col-span-full">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 loading-spinner mx-auto mb-3"></div>
                    <p class="text-secondary text-lg">≈Åadowanie przedmiot√≥w sklepu...</p>
                </div>`;
            statusDiv.innerHTML = '';

            try {
                const response = await fetch('/api/web/shop/items');
                if (!response.ok) {
                    throw new Error(`B≈ÇƒÖd HTTP: ${response.status}`);
                }
                const items = await response.json();

                if (items && items.length > 0) {
                    container.innerHTML = items.map((item, index) => {
                        const costDukaty = item.cost_dukaty !== null ? `${item.cost_dukaty} ‚ú®` : '';
                        const costKrysztaly = item.cost_krysztaly !== null ? `${item.cost_krysztaly} üí†` : '';
                        const priceString = [costDukaty, costKrysztaly].filter(Boolean).join(' lub ');
                        const stockInfo = item.stock === -1 ? 'Niesko≈Ñczony' : `Dostƒôpnych: ${item.stock}`;
                        
                        return `
                            <div class="shop-item-card card-bg p-6 rounded-lg text-center flex flex-col items-center reveal" style="transition-delay: ${index * 0.05}s;">
                                <div class="item-icon">${item.emoji || 'üõçÔ∏è'}</div>
                                <h3 class="text-xl font-semibold text-primary mb-2">${item.name}</h3>
                                <p class="text-secondary text-sm mb-3 flex-grow">${item.description}</p>
                                <p class="item-price">${priceString}</p>
                                <p class="text-sm text-secondary mb-4">${stockInfo}</p>
                                <button class="btn-primary w-full purchase-button" 
                                    data-item-id="${item.id}" 
                                    data-item-name="${item.name}"
                                    data-cost-dukaty="${item.cost_dukaty}"
                                    data-cost-krysztaly="${item.cost_krysztaly}"
                                    ${item.stock !== -1 && item.stock <= 0 ? 'disabled' : ''}>
                                    ${item.stock !== -1 && item.stock <= 0 ? 'Wyprzedane' : 'Kup Teraz'}
                                </button>
                            </div>
                        `;
                    }).join('');
                    
                    document.querySelectorAll('.purchase-button').forEach(button => {
                        button.addEventListener('click', async function() {
                            const itemId = this.dataset.itemId;
                            const itemName = this.dataset.itemName;
                            const costDukaty = this.dataset.costDukaty !== 'null' ? parseInt(this.dataset.costDukaty) : null;
                            const costKrysztaly = this.dataset.costKrysztaly !== 'null' ? parseInt(this.dataset.costKrysztaly) : null;

                            let currencyType = null;
                            if (costDukaty !== null && costKrysztaly !== null) {
                                // Je≈õli sƒÖ obie waluty, zapytaj u≈ºytkownika lub domy≈õlnie u≈ºyj dukat√≥w
                                if (!confirm(`Przedmiot "${itemName}" kosztuje ${costDukaty} ‚ú® lub ${costKrysztaly} üí†. Czy chcesz zap≈Çaciƒá Dukatami? (Anuluj dla Kryszta≈Ç√≥w)`)) {
                                    currencyType = 'krysztaly';
                                } else {
                                    currencyType = 'dukaty';
                                }
                            } else if (costDukaty !== null) {
                                currencyType = 'dukaty';
                            } else if (costKrysztaly !== null) {
                                currencyType = 'krysztaly';
                            } else {
                                alert('B≈ÇƒÖd: Przedmiot nie ma ustalonej ceny.');
                                return;
                            }

                            // Poka≈º modal potwierdzenia
                            const modal = document.getElementById('confirmationModal');
                            const modalTitle = document.getElementById('modalTitle'); // Dodano pobieranie modalTitle
                            const modalMessage = document.getElementById('modalMessage');
                            const confirmBtn = document.getElementById('confirmButton');
                            const cancelBtn = document.getElementById('cancelButton');

                            modalTitle.textContent = `Potwierdzenie Zakupu: ${itemName}`;
                            modalMessage.textContent = `Czy na pewno chcesz zakupiƒá "${itemName}" za ${cost} ${currencySymbol} ${currencyName}?`;
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');

                            const newConfirmBtn = confirmBtn.cloneNode(true);
                            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                            
                            const newCancelBtn = cancelBtn.cloneNode(true);
                            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                            newConfirmBtn.addEventListener('click', async () => {
                                modal.classList.add('hidden');
                                modal.classList.remove('flex');
                                statusDiv.innerHTML = '<p class="text-secondary">Przetwarzanie zakupu...</p>';
                                try {
                                    const purchaseResponse = await fetch(`/api/web/shop/buy/${itemId}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ currency_type: currencyType })
                                    });
                                    const result = await purchaseResponse.json();
                                    if (purchaseResponse.ok && result.message) {
                                        statusDiv.innerHTML = `<p class="text-green-400">${result.message}</p>`;
                                        loadShopItems(); // Od≈õwie≈º listƒô, aby zaktualizowaƒá stan magazynowy
                                        loadUserCurrencyBalance(); // Od≈õwie≈º saldo u≈ºytkownika
                                    } else {
                                        statusDiv.innerHTML = `<p class="text-red-400">${result.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas zakupu.'}</p>`;
                                    }
                                } catch (err) {
                                    console.error('B≈ÇƒÖd zakupu:', err);
                                    statusDiv.innerHTML = `<p class="text-red-400">WystƒÖpi≈Ç b≈ÇƒÖd sieciowy podczas zakupu.</p>`;
                                }
                            });
                            newCancelBtn.addEventListener('click', () => {
                                modal.classList.add('hidden');
                                modal.classList.remove('flex');
                                statusDiv.innerHTML = '<p class="text-secondary">Zakup anulowany.</p>';
                            });
                        });
                    });

                    document.querySelectorAll('#shopItemsContainer .reveal').forEach(el => {
                        setTimeout(() => el.classList.add('visible'), 10);
                    });

                } else {
                    container.innerHTML = '<p class="text-center text-secondary col-span-full py-10">Skarbiec jest obecnie pusty. Runa pracuje nad nowymi magicznymi przedmiotami!</p>';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania przedmiot√≥w sklepu:', error);
                container.innerHTML = `<p class="text-center text-red-400 col-span-full py-10">WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania przedmiot√≥w. Spr√≥buj od≈õwie≈ºyƒá stronƒô.</p>`;
            }
        }

        async function loadUserCurrencyBalance(discordUserId = null) {
            const balanceElement = document.getElementById('userCurrencyBalance');
            if (!balanceElement) return;

            if (!discordUserId) {
                try {
                    const userResponse = await fetch('/api/me');
                    if (userResponse.ok) {
                        const user = await userResponse.json();
                        discordUserId = user.id;
                    } else {
                        balanceElement.textContent = 'Zaloguj siƒô, aby zobaczyƒá saldo.';
                        return;
                    }
                } catch (error) {
                    console.error('B≈ÇƒÖd pobierania danych u≈ºytkownika dla salda:', error);
                    balanceElement.textContent = 'B≈ÇƒÖd ≈Çadowania salda.';
                    return;
                }
            }

            try {
                const statsResponse = await fetch(`/api/bot-stats/${discordUserId}`);
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    balanceElement.textContent = `Twoje Dukaty: ${stats.currency || 0} ‚ú® | Twoje Kryszta≈Çy: ${stats.premium_currency || 0} üí†`;
                } else {
                    balanceElement.textContent = 'Nie uda≈Ço siƒô za≈Çadowaƒá salda.';
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania salda walut:', error);
                balanceElement.textContent = 'B≈ÇƒÖd ≈Çadowania salda.';
            }
        }


        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            if (!document.documentElement.classList.contains('light') && !document.documentElement.classList.contains('dark')) {
                 document.documentElement.classList.add('dark');
            }

            setActiveNavLink();
            updateAuthDisplay(); // To wywo≈Ça loadUserCurrencyBalance je≈õli u≈ºytkownik jest zalogowany
            setupMobileMenu();
            setupRevealAnimations();
            setupDropdownDismiss();
            loadShopItems(); // Za≈Çaduj przedmioty sklepu
        });
    </script>
</body>
</html>
